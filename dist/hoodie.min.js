// Hoodie.js - 0.5.1
// https://github.com/hoodiehq/hoodie.js
// Copyright 2012, 2013 https://github.com/hoodiehq/
// Licensed Apache License 2.0

(function(global) {
'use strict'

<<<<<<< HEAD
<<<<<<< HEAD
!function(a){"object"==typeof exports?module.exports=a():"function"==typeof define&&define.amd?define(a):"undefined"!=typeof window?window.Hoodie=a():"undefined"!=typeof global?global.Hoodie=a():"undefined"!=typeof self&&(self.Hoodie=a())}(function(){var a;return function b(a,c,d){function e(g,h){if(!c[g]){if(!a[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};a[g][0].call(j.exports,function(b){var c=a[g][1][b];return e(c?c:b)},j,j.exports,b,a,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){function c(a){if(!a||"[object Object]"!==e.call(a)||a.nodeType||a.setInterval)return!1;var b=d.call(a,"constructor"),c=d.call(a.constructor.prototype,"isPrototypeOf");if(a.constructor&&!b&&!c)return!1;var f;for(f in a);return void 0===f||d.call(a,f)}var d=Object.prototype.hasOwnProperty,e=Object.prototype.toString;b.exports=function f(){var a,b,d,e,g,h,i=arguments[0]||{},j=1,k=arguments.length,l=!1;for("boolean"==typeof i&&(l=i,i=arguments[1]||{},j=2),"object"!=typeof i&&"function"!=typeof i&&(i={});k>j;j++)if(null!=(a=arguments[j]))for(b in a)d=i[b],e=a[b],i!==e&&(l&&e&&(c(e)||(g=Array.isArray(e)))?(g?(g=!1,h=d&&Array.isArray(d)?d:[]):h=d&&c(d)?d:{},i[b]=f(l,h,e)):void 0!==e&&(i[b]=e));return i}},{}],2:[function(b,c){function d(a){var b=this;if(!(b instanceof d))throw new Error("usage: new Hoodie(url);");a&&(b.baseUrl=a.replace(/\/+$/,"")),b.extend=function(a){a(b)},b.extend(r),b.extend(j),b.extend(k),b.extend(l),b.extend(p),b.extend(m),b.extend(n),b.extend(o),b.extend(q),b.extend(i),b.extend(g),b.extend(h),b.account.username=b.config.get("_account.username"),b.account.checkPasswordReset(),b.on("account:signout",b.config.clear),b.store.patchIfNotPersistant(),b.store.subscribeToOutsideEvents(),b.store.bootstrapDirtyObjects(),b.remote.subscribeToOutsideEvents(),b.task.subscribeToOutsideEvents(),b.account.authenticate().then(function(){b.remote.connect()}),window.addEventListener("online",b.checkConnection,!1),window.addEventListener("offline",b.checkConnection,!1),b.checkConnection(),e(b)}function e(a){for(var b=0;b<s.length;b++)s[b](a)}var f="undefined"!=typeof self?self:"undefined"!=typeof window?window:{},g=b("./hoodie/account"),h=b("./hoodie/account_remote"),i=b("./hoodie/config"),j=b("./hoodie/promises"),k=b("./hoodie/request"),l=b("./hoodie/connection"),m=b("./hoodie/dispose"),n=b("./hoodie/open"),o=b("./hoodie/local_store"),p=b("./hoodie/generate_id"),q=b("./hoodie/task"),r=b("./hoodie/events"),s=[];d.extend=function(a){s.push(a)},"object"==typeof c&&c&&"object"==typeof c.exports?c.exports=d:"function"==typeof a&&a.amd?a(function(){return d}):f.Hoodie=d},{"./hoodie/account":3,"./hoodie/account_remote":4,"./hoodie/config":5,"./hoodie/connection":6,"./hoodie/dispose":7,"./hoodie/events":11,"./hoodie/generate_id":12,"./hoodie/local_store":13,"./hoodie/open":14,"./hoodie/promises":15,"./hoodie/request":17,"./hoodie/task":21}],3:[function(a,b){function c(a){function b(b){return a.config.set(N,b)}function c(){return a.config.get(N)}function e(){return a.config.unset(N)}function f(){a.on("remote:error:unauthenticated",g)}function g(){return I=void 0,J.authenticate()}function h(b){return J.username!==b?(J.username=b,a.config.set("_account.username",b)):void 0}function i(b){return J.ownerHash!==b?(J.ownerHash=b,a.config.set("createdBy",b),a.config.set("_account.ownerHash",b)):void 0}function j(b){return b.userCtx.name?(I=!0,h(b.userCtx.name.replace(/^user(_anonymous)?\//,"")),i(b.userCtx.roles[0]),a.resolveWith(J.username)):J.hasAnonymousAccount()?J.signIn(J.username,c()):(I=!1,J.trigger("error:unauthenticated"),a.reject())}function k(a,b){return function(c){return J.trigger("signup",a),K._rev=c.rev,m(a,b)}}function l(b){return function(c){return"HoodieConflictError"===c.name&&(c.message="Username "+b+" already exists"),a.rejectWith(c)}}function m(b,c,d,e){return e||(e=a.defer()),window.setTimeout(function(){var a=G(b,c);a.done(e.resolve),a.fail(function(a){"HoodieAccountUnconfirmedError"===a.name?m(b,c,d,e):e.reject.apply(e,arguments)})},300),e.promise()}function n(b){return b=b||{},function(c){var d,e;return d=a.defer(),e=c.name.replace(/^user(_anonymous)?\//,""),-1!==c.roles.indexOf("error")?(J.fetch(e).fail(d.reject).done(function(){return d.reject(K.$error)}),d.promise()):-1===c.roles.indexOf("confirmed")?d.reject({name:"HoodieAccountUnconfirmedError",message:"Account has not been confirmed yet"}):(h(e),i(c.roles[0]),I=!0,b.silent||b.reauthenticated||(J.hasAnonymousAccount()?J.trigger("signin:anonymous",e):J.trigger("signin",e)),b.reauthenticated&&J.trigger("reauthenticated",e),J.fetch(),d.resolve(e,c.roles[0]))}}function o(b){var c;return c=b.$error?b.$error:{name:"HoodiePendingError",message:"Password reset is still pending"},a.rejectWith(c)}function p(b){return"HoodieUnauthorizedError"===b.name?(a.config.unset("_account.resetPasswordId"),J.trigger("passwordreset"),a.resolve()):a.rejectWith(b)}function q(){var b=a.defer();return J.one("passwordreset",b.resolve),J.one("error:passwordreset",b.reject),b.always(function(){J.unbind("passwordreset",b.resolve),J.unbind("error:passwordreset",b.reject)}),b.promise()}function r(a,b,c){return G(J.username,a,{silent:!0}).then(function(){return J.fetch().then(A(a,b,c))})}function s(a,b){var d=c();return r(d,a,b).done(function(){J.trigger("signup",a),e()})}function t(){return a.remote.disconnect(),K._deleted=!0,C("updateUsersDoc",function(){J.request("PUT",z(),{data:JSON.stringify(K),contentType:"application/json"})})}function u(b){return"HoodieNotFoundError"===b.name?a.resolve():a.rejectWith(b)}function v(b){return b=b||{},J.trigger("cleanup"),I=b.authenticated,a.config.clear(),h(b.username),i(b.ownerHash||a.generateId()),a.resolve()}function w(){return v().then(function(){return J.trigger("signout")})}function x(a){var b;return b=a===J.ownerHash?"user_anonymous":"user",""+b+"/"+a}function y(a){return a=a||J.username,""+M+":"+x(a)}function z(a){return"/_users/"+encodeURIComponent(y(a))}function A(a,b,c){return function(){var d=$.extend({},K);b&&(d.$newUsername=b),d.updatedAt=H(),d.signedUpAt=d.signedUpAt||H(),null!==c&&(delete d.salt,delete d.password_sha,d.password=c);var e={data:JSON.stringify(d),contentType:"application/json"};return C("updateUsersDoc",function(){return J.request("PUT",z(),e).then(B(b,c||a))})}}function B(b,c){return function(){return a.remote.disconnect(),b?m(b,c,{silent:!0}):J.signIn(J.username,c)}}function C(a,b){return void 0!==L[a]&&"function"==typeof L[a].abort&&L[a].abort(),L[a]=b(),L[a]}function D(a,b){return void 0!==L[a]&&"function"==typeof L[a].state&&"pending"===L[a].state()?L[a]:(L[a]=b(),L[a])}function E(b){return a.store.hasLocalChanges()&&!b.ignoreLocalChanges?a.remote.push():a.resolve()}function F(){return D("signOut",function(){return J.request("DELETE","/_session")})}function G(a,b,c){var d={data:{name:x(a),password:b}};return C("signIn",function(){var a=J.request("POST","/_session",d);return a.then(n(c))})}function H(){return new Date}var I,J={},K={},L={},M="org.couchdb.user";d(a,{context:J,namespace:"account"}),J.authenticate=function(){var b;return I===!1?a.reject():I===!0?a.resolveWith(J.username):L.signOut&&"pending"===L.signOut.state()?L.signOut.then(a.reject):L.signIn&&"pending"===L.signIn.state()?L.signIn:J.hasAccount()?(b=function(){return J.request("GET","/_session").then(j)},D("authenticate",b)):F().then(function(){return I=!1,a.reject()})},J.hasValidSession=function(){return J.hasAccount()?I===!0:!1},J.hasInvalidSession=function(){return J.hasAccount()?I===!1:!1},J.signUp=function(b,c){if(void 0===c&&(c=""),!b)return a.rejectWith("Username must be set.");if(J.hasAnonymousAccount())return s(b,c);if(J.hasAccount())return a.rejectWith("Must sign out first.");b=b.toLowerCase();var d={data:JSON.stringify({_id:y(b),name:x(b),type:"user",roles:[],password:c,ownerHash:J.ownerHash,database:J.db(),updatedAt:H(),createdAt:H(),signedUpAt:b!==J.ownerHash?H():void 0}),contentType:"application/json"};return J.request("PUT",z(b),d).then(k(b,c),l(b))},J.anonymousSignUp=function(){var c,d;return c=a.generateId(10),d=J.ownerHash,J.signUp(d,c).done(function(){return b(c),J.trigger("signup:anonymous",d)})},J.hasAccount=function(){return!!J.username},J.hasAnonymousAccount=function(){return J.username===J.ownerHash};var N="_account.anonymousPassword";J.signIn=function(b,c,d){var e,f=function(){return J.signOut({silent:!0}).then(function(){return G(b,c)})};return d=d||{},null===b&&(b=""),void 0===c&&(c=""),b=b.toLowerCase(),b!==J.username?d.moveData?a.store.findAll().then(function(a){e=a}).then(f).done(function(){e.forEach(function(b){var c=b.type;("$config"!==c||"hoodie"!==b.id)&&(delete b.type,b.createdBy=a.account.ownerHash,a.store.add(c,b))})}):f():G(b,c,{reauthenticated:!0})},J.signOut=function(b){return b=b||{},J.hasAccount()?E(b).then(a.remote.disconnect).then(F).then(w):v().then(function(){return b.silent?void 0:J.trigger("signout")})},J.request=function(b,c,d){return d=d||{},a.request.apply(a,arguments)},J.db=function(){return"user/"+J.ownerHash},J.fetch=function(b){return void 0===b&&(b=J.username),b?D("fetch",function(){return J.request("GET",z(b)).done(function(a){return K=a})}):a.rejectWith({name:"HoodieUnauthorizedError",message:"Not signed in"})},J.changePassword=function(b,c){return J.username?(a.remote.disconnect(),J.fetch().then(A(b,null,c))):a.rejectWith({name:"HoodieUnauthorizedError",message:"Not signed in"})},J.resetPassword=function(b){var c,d,e,f;return(f=a.config.get("_account.resetPasswordId"))?J.checkPasswordReset():(f=""+b+"/"+a.generateId(),a.config.set("_account.resetPasswordId",f),d=""+M+":$passwordReset/"+f,c={_id:d,name:"$passwordReset/"+f,type:"user",roles:[],password:f,createdAt:H(),updatedAt:H()},e={data:JSON.stringify(c),contentType:"application/json"},C("resetPassword",function(){return J.request("PUT","/_users/"+encodeURIComponent(d),e).done(J.checkPasswordReset).then(q)}))},J.checkPasswordReset=function(){var b,c,d,e,f;return(d=a.config.get("_account.resetPasswordId"))?(f="$passwordReset/"+d,e="/_users/"+encodeURIComponent(M+":"+f),b=btoa(f+":"+d),c={headers:{Authorization:"Basic "+b}},C("passwordResetStatus",function(){return J.request("GET",e,c).then(o,p).fail(function(a){return"HoodiePendingError"===a.name?(window.setTimeout(J.checkPasswordReset,1e3),void 0):J.trigger("passwordreset:error")})})):a.rejectWith("No pending password reset.")},J.changeUsername=function(a,b){return b=b||"",r(a,b.toLowerCase())},J.destroy=function(){return J.hasAccount()?J.fetch().then(t,u).then(w):w()},J.subscribeToOutsideEvents=function(){f(),delete J.subscribeToOutsideEvents},a.account=J,a.account.ownerHash=a.config.get("_account.ownerHash"),a.account.ownerHash||i(a.generateId())}var d=a("./events");b.exports=c},{"./events":11}],4:[function(a,b){function c(a){function b(b){return b?a.config.set("_remote.since",b):a.config.get("_remote.since")||0}function c(){a.on("remote:connect",function(){a.on("store:idle",d.push),d.push()}),a.on("remote:disconnect",function(){a.unbind("store:idle",d.push)}),a.on("disconnected",d.disconnect),a.on("reconnected",d.connect),a.on("account:signin",d.connect),a.on("account:signin:anonymous",d.connect),a.on("account:reauthenticated",d.connect),a.on("account:signout",d.disconnect)}var d=a.open(a.account.db(),{connected:!0,prefix:"",since:b,defaultObjectsToPush:a.store.changedObjects,knownObjects:a.store.index().map(function(a){var b=a.split(/\//);return{type:b[0],id:b[1]}})}),e=d.connect;d.connect=function(){return a.account.hasAccount()?e(a.account.db()):a.rejectWith("User has no database to connect to")},d.trigger=function(){var b;b=arguments[0];var c=2<=arguments.length?Array.prototype.slice.call(arguments,1):[];return a.trigger.apply(a,["remote:"+b].concat(Array.prototype.slice.call(c)))},d.on=function(b,c){return b=b.replace(/(^| )([^ ]+)/g,"$1remote:$2"),a.on(b,c)},d.unbind=function(b,c){return b=b.replace(/(^| )([^ ]+)/g,"$1remote:$2"),a.unbind(b,c)},d.subscribeToOutsideEvents=function(){c(),delete d.subscribeToOutsideEvents},a.remote=d}b.exports=c},{}],5:[function(a,b){function c(a){var b="$config",c="hoodie",d={},e={};e.set=function(e,f){var g,h;if(d[e]!==f)return d[e]=f,h={},h[e]=f,g="_"===e.charAt(0),a.store.updateOrAdd(b,c,h,{silent:g})},e.get=function(a){return d[a]},e.clear=function(){return d={},a.store.remove(b,c)},e.unset=function(a){return e.set(a,void 0)},a.store.find(b,c).done(function(a){d=a}),a.config=e}b.exports=c},{}],6:[function(a,b){function c(a){function b(){return e=3e4,g=window.setTimeout(a.checkConnection,e),a.isConnected()||(a.trigger("reconnected"),d=!0),a.resolve()}function c(){return e=3e3,g=window.setTimeout(a.checkConnection,e),a.isConnected()&&(a.trigger("disconnected"),d=!1),a.reject()}var d=!0,e=3e4,f=null,g=null;a.checkConnection=function(){var d=f;return d&&"pending"===d.state()?d:(window.clearTimeout(g),f=a.request("GET","/").then(b,c))},a.isConnected=function(){return d}}b.exports=c},{}],7:[function(a,b){function c(a){function b(){a.trigger("dispose"),a.unbind()}a.dispose=b}b.exports=c},{}],8:[function(a,b){function c(a){if("string"==typeof a&&(a={message:a}),!a.message)throw"FATAL: error.message must be set";a.name||(a.name="HoodieError"),f(this,a),a.message=a.message.replace(d,function(b){var c=b.match(e)[0];return a[c]})}var d=/\{\{\s*\w+\s*\}\}/g,e=/\w+/,f=a("extend");c.prototype=new Error,c.prototype.constructor=c,b.exports=c},{extend:1}],9:[function(a,b){function c(a){return a.name="HoodieObjectIdError",a.message='"{{id}}" is invalid object id. {{rules}}.',new d(a)}var d=a("../error"),e=/^[a-z0-9\-]+$/;c.isInvalid=function(a,b){return!(b||e).test(a||"")},c.isValid=function(a,b){return(b||e).test(a||"")},c.prototype.rules="Lowercase letters, numbers and dashes allowed only. Must start with a letter",b.exports=c},{"../error":8}],10:[function(a,b){function c(a){return a.name="HoodieObjectTypeError",a.message='"{{type}}" is invalid object type. {{rules}}.',new d(a)}var d=a("../error"),e=/^[a-z$][a-z0-9]+$/;c.isInvalid=function(a,b){return!(b||e).test(a||"")},c.isValid=function(a,b){return(b||e).test(a||"")},c.prototype.rules="lowercase letters, numbers and dashes allowed only. Must start with a letter",b.exports=c},{"../error":8}],11:[function(a,b){function c(a,b){function c(b,c){var d,e,f,g;for(d=b.split(" "),f=0,g=d.length;g>f;f++)e=h+d[f],a.eventsCallbacks[e]=a.eventsCallbacks[e]||[],a.eventsCallbacks[e].push(c)}function d(b,c){b=h+b;var d=function(){a.unbind(b,d),c.apply(null,arguments)};a.bind(b,d)}function e(){var b,c,d,e,f,g;if(b=1<=arguments.length?Array.prototype.slice.call(arguments,0):[],d=b.shift(),d=h+d,e=a.eventsCallbacks[d]){for(f=0,g=e.length;g>f;f++)c=e[f],c.apply(null,b);return!0}}function f(b,c){var d,e,f,g,i,j;if(!b)return h||(a.eventsCallbacks={}),j=Object.keys(a.eventsCallbacks),j=j.filter(function(a){return 0===a.indexOf(h)}),j.forEach(function(b){delete a.eventsCallbacks[b]}),void 0;if(b=h+b,f=a.eventsCallbacks[b]){if(!c)return delete a.eventsCallbacks[b],void 0;for(e=g=0,i=f.length;i>g;e=++g)if(d=f[e],d===c){f=f.slice(),f.splice(e,1),a.eventsCallbacks[b]=f;break}}}var g=a,h="";b=b||{},a.eventsCallbacks||(a.eventsCallbacks={}),b.context&&(g=b.context,h=b.namespace+":"),g.bind=c,g.on=c,g.one=d,g.trigger=e,g.unbind=f,g.off=f}b.exports=c},{}],12:[function(a,b){function c(a){function b(a){var b="";for(void 0===a&&(a=7),d=0;a>d;d++){var f=Math.random()*e,g=c[Math.floor(f)];b+=String(g).charAt(0)}return b}var c,d,e;c="0123456789abcdefghijklmnopqrstuvwxyz".split(""),e=c.length,a.generateId=b}b.exports=c},{}],13:[function(a,b){function c(a){function b(a){if(e.isInvalid(a.type))return new e({type:a.type});if(a.id)return f.isInvalid(a.id)?new f({id:a.id}):void 0}function c(a,b,c,d){var e;if(void 0===c&&(c=!1),d=d||{},e=""+a+"/"+b,c){if($.extend(c,{type:a,id:b}),n(a,b,c),d.remote)return j(a,b),B[e]=$.extend(!0,{},c),B[e]}else{if(B[e]===!1)return!1;if(B[e])return $.extend(!0,{},B[e]);if(c=o(a,b),c===!1)return j(a,b),B[e]=!1,!1}return t(c)?(i(a,b,c,d),B[e]=!1,!1):(B[e]=$.extend(!0,{},c),s(c)?i(a,b,B[e],d):j(a,b),$.extend(!0,{},c))}function g(){var a,b,d,e,f,g,h;if(b=H.getItem("_dirty"))for(b=b.split(","),f=0,g=b.length;g>f;f++)h=b[f].split("/"),e=h[0],a=h[1],d=c(e,a)}function h(){a.on("account:cleanup",F.clear),a.on("account:signup",k),a.on("remote:bootstrap:start",w),a.on("remote:bootstrap:end",x),a.on("remote:change",l),a.on("remote:push",m)}function i(a,b,c,d){var e;d=d||{},e=""+a+"/"+b,C[e]=c,p(),d.silent||v()}function j(a,b){var c;return a&&b?(c=""+a+"/"+b,delete C[c]):C={},p(),window.clearTimeout(I)}function k(){return F.findAll().pipe(function(a){var b,c,d,e;for(d=0,e=a.length;e>d;d++)c=a[d],b=""+c.type+"/"+c.id,C[b]=c;p(),v()})}function l(a,b){"remove"===a?F.remove(b.type,b.id,{remote:!0,update:b}):F.save(b.type,b.id,b,{remote:!0})}function m(a){u("sync",a)}function n(a,b,c){var d,e;return d=""+a+"/"+b,e=$.extend({},c),delete e.type,delete e.id,H.setItem(d,JSON.stringify(e))}function o(a,b){var c,d;c=""+a+"/"+b;var e=H.getItem(c);return e?(d=JSON.parse(e),d.type=a,d.id=b,d):!1}function p(){try{if($.isEmptyObject(C))H.removeItem("_dirty");else{var a=Object.keys(C);H.setItem("_dirty",a.join(","))}}catch(b){}}function q(){return JSON.stringify(new Date).replace(/['"]/g,"")}function r(a){return J.test(a)}function s(a){return a.updatedAt?a._syncedAt?a._syncedAt<a.updatedAt:!0:!1}function t(a){return a._deleted===!0}function u(a,b,c){F.trigger(a,$.extend(!0,{},b),c),F.trigger(b.type+":"+a,$.extend(!0,{},b),c),F.trigger(a+":"+b.type,$.extend(!0,{},b),c),"new"!==a&&(F.trigger(b.type+":"+b.id+":"+a,$.extend(!0,{},b),c),F.trigger(a+":"+b.type+":"+b.id,$.extend(!0,{},b),c)),"sync"!==a&&(F.trigger("change",a,$.extend(!0,{},b),c),F.trigger(b.type+":change",a,$.extend(!0,{},b),c),F.trigger("change:"+b.type,a,$.extend(!0,{},b),c),"new"!==a&&(F.trigger(b.type+":"+b.id+":change",a,$.extend(!0,{},b),c),F.trigger("change:"+b.type+":"+b.id,a,$.extend(!0,{},b),c)))}function v(){F.trigger("dirty"),window.clearTimeout(I),I=window.setTimeout(function(){F.trigger("idle",F.changedObjects())},E)}function w(){G=!0,F.trigger("bootstrap:start")}function x(){var a,b,c,d;for(G=!1;D.length>0;)a=D.shift(),b=a[0],c=a[1],d=a[2],A[b].apply(A,c).then(d.resolve,d.reject);F.trigger("bootstrap:end")}function y(b,c){var d=a.defer();return D.push([b,c,d]),d.promise()}function z(){F.isPersistent()||(H={getItem:function(){return null},setItem:function(){return null},removeItem:function(){return null},key:function(){return null},length:function(){return 0}})}var A={},B={},C={},D=[],E=2e3;A.save=function(b,d){var e,f,g,h,i,j;if(d=d||{},F.isBootstrapping()&&!d.remote)return y("save",arguments);if(b.id?(e=c(b.type,b.id),i="object"!=typeof e):(i=!0,b.id=a.generateId()),i?b.createdBy=b.createdBy||a.account.ownerHash:e.createdBy&&(b.createdBy=e.createdBy),!i)for(j in e)if(!b.hasOwnProperty(j))switch(j.charAt(0)){case"_":d.remote&&(b[j]=e[j]);break;case"$":d.remote||(b[j]=e[j])}d.remote?b._syncedAt=q():d.silent||(b.updatedAt=q(),b.createdAt=b.createdAt||b.updatedAt),d.local?b._$local=!0:delete b._$local,f=a.defer();try{b=c(b.type,b.id,b,d),f.resolve(b,i).promise(),h=i?"add":"update",u(h,b,d)}catch(k){g=k,f.reject(g.toString())}return f.promise()},A.find=function(b,d){var e,f;if(F.isBootstrapping())return y("find",arguments);try{return f=c(b,d),f?a.resolveWith(f):a.rejectWith({name:"HoodieNotFoundError",message:'"{{type}}" with id "{{id}}" could not be found'})}catch(g){return e=g,a.rejectWith(e)}},A.findAll=function(b){var d,e,f,g,h,i,j,k,l;if(null==b&&(b=function(){return!0}),F.isBootstrapping())return y("findAll",arguments);i=F.index(),"string"==typeof b&&(l=b,b=function(a){return a.type===l}),e=a.defer();try{k=function(){var a,e,f,k;for(k=[],a=0,e=i.length;e>a;a++)h=i[a],r(h)&&(f=h.split("/"),d=f[0],g=f[1],j=c(d,g),j&&b(j)&&k.push(j));return k}.call(this),k.sort(function(a,b){return a.createdAt>b.createdAt?-1:a.createdAt<b.createdAt?1:0}),e.resolve(k).promise()}catch(m){f=m,e.reject(f).promise()}return e.promise()},A.remove=function(b,d,e){var f,g,h;return e=e||{},F.isBootstrapping()&&!e.remote?y("remove",arguments):(f=b+"/"+d,g=c(b,d),e.remote&&(H.removeItem(f),h=B[f]&&t(B[f]),B[f]=!1,j(b,d),h&&g)?a.resolveWith(g):g?(g._syncedAt?(g._deleted=!0,c(b,d,g)):(f=b+"/"+d,H.removeItem(f),B[f]=!1,j(b,d)),e.update&&(g=e.update,delete e.update),u("remove",g,e),a.resolveWith(g)):a.rejectWith({name:"HoodieNotFoundError",message:'"{{type}}" with id "{{id}}"" could not be found'}))},A.removeAll=function(a,b){return F.findAll(a).then(function(a){var c,d,e,f;for(f=[],d=0,e=a.length;e>d;d++)c=a[d],f.push(F.remove(c.type,c.id,b));return f})};var F=d(a,{validate:b,backend:{save:A.save,find:A.find,findAll:A.findAll,remove:A.remove,removeAll:A.removeAll}});F.index=function(){var a,b,c,d,e;for(c=[],a=d=0,e=H.length();e>=0?e>d:d>e;a=e>=0?++d:--d)b=H.key(a),r(b)&&c.push(b);return c},F.changedObjects=function(){var a,b,c,d,e,f,g;e=C,g=[];for(b in e)e.hasOwnProperty(b)&&(c=e[b],f=b.split("/"),d=f[0],a=f[1],c.type=d,c.id=a,g.push(c));return g},F.hasLocalChanges=function(a,b){if(!a)return!$.isEmptyObject(C);var d=[a,b].join("/");return C[d]?!0:s(c(a,b))},F.clear=function(){var b,c,d,e;b=a.defer();try{d=F.index(),e=function(){var a,b,e;for(e=[],a=0,b=d.length;b>a;a++)c=d[a],r(c)&&e.push(H.removeItem(c));return e}.call(this),B={},j(),b.resolve(),F.trigger("clear")}catch(f){b.reject(f)}return b.promise()};var G=!1;F.isBootstrapping=function(){return G},F.isPersistent=function(){try{if(!window.localStorage)return!1;if(localStorage.setItem("Storage-Test","1"),"1"!==localStorage.getItem("Storage-Test"))return!1;localStorage.removeItem("Storage-Test")}catch(a){return!1}return!0};var H={getItem:function(a){return window.localStorage.getItem(a)},setItem:function(a,b){return window.localStorage.setItem(a,b)},removeItem:function(a){return window.localStorage.removeItem(a)},key:function(a){return window.localStorage.key(a)},length:function(){return window.localStorage.length}};F.subscribeToOutsideEvents=function(){h(),delete F.subscribeToOutsideEvents};var I,J=new RegExp(/^[a-z$][a-z0-9]+\/[a-z0-9]+$/);a.store=F,F.bootstrapDirtyObjects=function(){g(),delete F.bootstrapDirtyObjects},F.patchIfNotPersistant=function(){z(),delete F.patchIfNotPersistant}}var d=a("./store"),e=a("./error/object_type"),f=a("./error/object_id");b.exports=c},{"./error/object_id":9,"./error/object_type":10,"./store":20}],14:[function(a,b){function c(a){function b(b,c){return c=c||{},$.extend(c,{name:b}),d(a,c)}a.open=b}var d=a("./remote_store");b.exports=c},{"./remote_store":16}],15:[function(a,b){function c(a){function b(a){return!(!a||"function"!=typeof a.done||"function"==typeof a.resolve)}function c(){return h().resolve().promise()}function e(){return h().reject().promise()}function f(){var a=h();return a.resolve.apply(a,arguments).promise()}function g(a){var b=h(),c=new d(a);return b.reject(c).promise()}var h=window.jQuery.Deferred;a.defer=h,a.isPromise=b,a.resolve=c,a.reject=e,a.resolveWith=f,a.rejectWith=g}var d=a("./error");b.exports=c},{"./error":8}],16:[function(a,b){function c(a,b){function c(a){return"function"==typeof u?u(a):u=a}function e(a){var b,c;c=$.extend({},a);for(b in c)if(c.hasOwnProperty(b)){if(-1!==A.indexOf(b))continue;if(!/^_/.test(b))continue;delete c[b]}return c._id=""+c.type+"/"+c.id,r.prefix&&(c._id=""+r.prefix+c._id),delete c.id,c}function f(a){var b,c,d;return b=a._id||a.id,delete a._id,r.prefix&&(b=b.replace(t,"")),d=b.match(/([^\/]+)\/(.*)/),c=d[0],a.type=d[1],a.id=d[2],a}function g(a){var b,c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(f(b));return e}function h(a){var b,c,d,e;try{e=a._rev.split(/-/),c=e[0],b=e[1]}catch(f){}return c=parseInt(c,10)||0,d=i(),a._$local&&(d+="-local"),a._rev=""+(c+1)+"-"+d,a._revisions={start:1,ids:[d]},b?(a._revisions.start+=c,a._revisions.ids.push(b)):void 0}function i(){return a.generateId(9)}function j(a){return a.rows.map(function(a){return a.doc})}function k(){var a;return a=r.getSinceNr(),r.isConnected()&&!v?"/_changes?include_docs=true&since="+a+"&heartbeat=10000&feed=longpoll":"/_changes?include_docs=true&since="+a}function l(){w&&w.abort()}function m(a){return c(a.last_seq),p(a.results),r.isConnected()?r.pull():void 0}function n(b,c){if(r.isConnected())switch(b.status){case 401:return r.trigger("error:unauthenticated",c),r.disconnect();case 404:return window.setTimeout(r.pull,3e3);case 500:return r.trigger("error:server",c),window.setTimeout(r.pull,3e3),a.checkConnection();default:return"abort"===b.statusText?r.pull():(window.setTimeout(r.pull,3e3),a.checkConnection())}}function o(){v=!1,r.trigger("bootstrap:end")}function p(a){var b,c,d,e,g;for(e=0,g=a.length;g>e;e++)if(b=a[e].doc,!r.prefix||0===b._id.indexOf(r.prefix)){if(d=f(b),d._deleted){if(!r.isKnownObject(d))continue;c="remove",r.isKnownObject(d)}else r.isKnownObject(d)?c="update":(c="add",r.markAsKnownObject(d));r.trigger(c,d),r.trigger(c+":"+d.type,d),r.trigger(c+":"+d.type+":"+d.id,d),r.trigger("change",c,d),r.trigger("change:"+d.type,c,d),r.trigger("change:"+d.type+":"+d.id,c,d)}}var q={};q.find=function(a,b){var c;return c=a+"/"+b,r.prefix&&(c=r.prefix+c),c="/"+encodeURIComponent(c),r.request("GET",c).then(f)},q.findAll=function(a){var b,c,d;switch(c="/_all_docs?include_docs=true",!0){case void 0!==a&&""!==r.prefix:d=r.prefix+a+"/";break;case void 0!==a:d=a+"/";break;case""!==r.prefix:d=r.prefix;break;default:d=""}return d&&(b=d.replace(/.$/,function(a){var b;return b=a.charCodeAt(0),String.fromCharCode(b+1)}),c=""+c+'&startkey="'+encodeURIComponent(d)+'"&endkey="'+encodeURIComponent(b)+'"'),r.request("GET",c).then(j).then(g)},q.save=function(b){var c;return b.id||(b.id=a.generateId()),b=e(b),c="/"+encodeURIComponent(b._id),r.request("PUT",c,{data:b})},q.remove=function(a,b){return r.update(a,b,{_deleted:!0})},q.removeAll=function(a){return r.updateAll(a,{_deleted:!0})};var r=d(a,{name:b.name,backend:{save:q.save,find:q.find,findAll:q.findAll,remove:q.remove,removeAll:q.removeAll}}),s=null;r.connected=!1,r.prefix="";var t=new RegExp("^");void 0!==b.name&&(s=b.name),void 0!==b.prefix&&(r.prefix=b.prefix,t=new RegExp("^"+r.prefix)),null!==b.baseUrl&&(r.baseUrl=b.baseUrl),r.request=function(b,c,d){return d=d||{},s&&(c="/"+encodeURIComponent(s)+c),r.baseUrl&&(c=""+r.baseUrl+c),d.contentType=d.contentType||"application/json",("POST"===b||"PUT"===b)&&(d.dataType=d.dataType||"json",d.processData=d.processData||!1,d.data=JSON.stringify(d.data)),a.request(b,c,d)},r.isKnownObject=function(a){var b=""+a.type+"/"+a.id;return void 0!==z[b]?z[b]:void 0},r.markAsKnownObject=function(a){var b=""+a.type+"/"+a.id;return z[b]=1,z[b]},r.connect=function(a){return a&&(s=a),r.connected=!0,r.trigger("connect"),r.bootstrap().then(function(){r.push()})},r.disconnect=function(){r.connected=!1,r.trigger("disconnect"),w&&w.abort(),y&&y.abort()},r.isConnected=function(){return r.connected};var u=b.since||0;r.getSinceNr=function(){return"function"==typeof u?u():u};var v=!1;r.bootstrap=function(){return v=!0,r.trigger("bootstrap:start"),r.pull().done(o)};var w,x;r.pull=function(){return w=r.request("GET",k()),r.isConnected()&&(window.clearTimeout(x),x=window.setTimeout(l,25e3)),w.done(m).fail(n)};var y;r.push=function(b){var c,d,f,g;if($.isArray(b)||(b=B()),0===b.length)return a.resolveWith([]);for(d=[],f=0,g=b.length;g>f;f++)c=$.extend(!0,{},b[f]),h(c),c=e(c),d.push(c);return y=r.request("POST","/_bulk_docs",{data:{docs:d,new_edits:!1}}),y.done(function(){for(var a=0;a<b.length;a++)r.trigger("push",b[a])}),y},r.sync=function(a){return r.push(a).then(r.pull)};var z={},A=["_id","_rev","_deleted","_revisions","_attachments"],B=function(){return[]};if(b.defaultObjectsToPush&&(B=$.isArray(b.defaultObjectsToPush)?function(){return b.defaultObjectsToPush}:b.defaultObjectsToPush),b.knownObjects)for(var C=0;C<b.knownObjects.length;C++)r.markAsKnownObject({type:b.knownObjects[C].type,id:b.knownObjects[C].id});return r}var d=a("./store");b.exports=c},{"./store":20}],17:[function(a,b){function c(a){function b(b,d,e){var i,j,k;return e=e||{},i={type:b,dataType:"json"},/^http/.test(d)||(d=(a.baseUrl||"")+h+d),/^http/.test(d)&&(i.xhrFields={withCredentials:!0},i.crossDomain=!0),i.url=d,j=g(f(i,e)),k=j.then(null,c),k.abort=j.abort,k}function c(b){var c;try{c=d(b)}catch(e){c=b.responseText?b.responseText:{name:"HoodieConnectionError",message:"Could not connect to Hoodie server at {{url}}.",url:a.baseUrl||"/"}}return a.rejectWith(c).promise()}function d(a){var b=JSON.parse(a.responseText);return b.name=i[a.status],b.name||(b.name=e(b.error)),b.status=a.status,b.message=b.reason||"",b.message=b.message.charAt(0).toUpperCase()+b.message.slice(1),delete b.error,delete b.reason,b}function e(a){return a=a.replace(/(^\w|_\w)/g,function(a){return(a[1]||a[0]).toUpperCase()}),"Hoodie"+a+"Error"}var f=$.extend,g=$.ajax,h="/_api",i={400:"HoodieRequestError",401:"HoodieUnauthorizedError",403:"HoodieRequestError",404:"HoodieNotFoundError",409:"HoodieConflictError",412:"HoodieConflictError",500:"HoodieServerError"};a.request=b}b.exports=c},{}],18:[function(a,b){function c(a,b,c){var e=c.name||"store",f=c.type,g=c.id,h={};return g||(d(a,{context:h,namespace:e+":"+f}),h.save=function(a,c,d){return b.save(f,a,c,d)},h.add=function(a,c){return b.add(f,a,c)},h.find=function(a){return b.find(f,a)},h.findOrAdd=function(a,c){return b.findOrAdd(f,a,c)},h.findAll=function(a){return b.findAll(f,a)},h.update=function(a,c,d){return b.update(f,a,c,d)},h.updateAll=function(a,c){return b.updateAll(f,a,c)},h.remove=function(a,c){return b.remove(f,a,c)},h.removeAll=function(a){return b.removeAll(f,a)}),g&&(d(a,{context:h,namespace:e+":"+f+":"+g}),h.save=function(a,c){return b.save(f,g,a,c)},h.find=function(){return b.find(f,g)},h.update=function(a,c){return b.update(f,g,a,c)},h.remove=function(a){return b.remove(f,g,a)}),h.decoratePromises=b.decoratePromises,h.validate=b.validate,h}var d=a("./events");b.exports=c},{"./events":11}],19:[function(a,b){function c(a,b,c){var e=c.type,f=c.id,g={};return f||(d(a,{context:g,namespace:"task:"+e}),g.start=function(a){return b.start(e,a)},g.cancel=function(a){return b.cancel(e,a)},g.restart=function(a,c){return b.restart(e,a,c)},g.cancelAll=function(){return b.cancelAll(e)},g.restartAll=function(a){return b.restartAll(e,a)}),f&&(d(a,{context:g,namespace:"task:"+e+":"+f}),g.cancel=function(){return b.cancel(e,f)},g.restart=function(a){return b.restart(e,f,a)}),g}var d=a("./events");b.exports=c},{"./events":11}],20:[function(a,b){function c(a,b){function c(a){return $.extend(a,j)}var i={},j={hoodie:a},k=b.name||"store",l=function p(c,e){var f=$.extend(!0,{type:c,id:e},b);return d(a,p,f)};if(e(a,{context:l,namespace:k}),l.validate=b.validate,b.validate||(l.validate=function(a){if(!a)return new f({name:"InvalidObjectError",message:"No object passed."});if(g.isInvalid(a.type,n))return new g({type:a.type,rules:o});if(a.id)return h.isInvalid(a.id,n)?new h({id:a.id,rules:o}):void 0}),l.save=function(b,d,e,f){f=f?$.extend(!0,{},f):{};var g=$.extend(!0,{},e,{type:b,id:d}),h=l.validate(g,f||{});return h?a.rejectWith(h):c(i.save(g,f||{}))},l.add=function(a,b,c){return void 0===b&&(b={}),c=c||{},l.save(a,b.id,b,c)},l.find=function(a,b){return c(i.find(a,b))},l.findOrAdd=function(a,b,d){function e(){var c;return c=$.extend(!0,{id:b},d),l.add(a,c)}null===d&&(d={});var f=l.find(a,b).then(null,e);return c(f)},l.findAll=function(a,b){return c(i.findAll(a,b))},l.update=function(b,d,e,f){function g(c){var g,h,i;return h=$.extend(!0,{},c),"function"==typeof e&&(e=e(h)),e?(g=function(){var a=[];for(var b in e)if(e.hasOwnProperty(b)){if(i=e[b],c[b]!==i==!1)continue;h[b]=i,a.push(b)}return a}(),g.length||f?l.save(b,d,h,f):a.resolveWith(h)):a.resolveWith(c)}var h=l.find(b,d).then(g);return c(h)},l.updateOrAdd=function(a,b,d,e){function f(){var c=$.extend(!0,{},d,{id:b});return l.add(a,c,e)}var g=l.update(a,b,d,e).then(null,f);return c(g)},l.updateAll=function(b,d,e){var f;
switch(e=e||{},!0){case"string"==typeof b:f=l.findAll(b);break;case a.isPromise(b):f=b;break;case $.isArray(b):f=a.defer().resolve(b).promise();break;default:f=l.findAll()}return f=f.then(function(a){var b,c;return $.isArray(a)||(a=[a]),c=function(){var c,f,g;for(g=[],c=0,f=a.length;f>c;c++)b=a[c],g.push(l.update(b.type,b.id,d,e));return g}(),$.when.apply(null,c)}),c(f)},l.remove=function(a,b,d){return c(i.remove(a,b,d||{}))},l.removeAll=function(a,b){return c(i.removeAll(a,b||{}))},l.decoratePromises=function(a){return $.extend(j,a)},!b.backend)throw new Error("options.backend must be passed");var m="save find findAll remove removeAll".split(" ");m.forEach(function(a){if(!b.backend[a])throw new Error("options.backend."+a+" must be passed.");i[a]=b.backend[a]});var n=/^[^\/]+$/,o="/ not allowed";return l}var d=a("./scoped_store"),e=a("./events"),f=a("./error"),g=a("./error/object_type"),h=a("./error/object_id");b.exports=c},{"./error":8,"./error/object_id":9,"./error/object_type":10,"./events":11,"./scoped_store":18}],21:[function(a,b){function c(a){function b(){a.on("store:change",h)}function c(b){var c=a.defer(),d=a.store(b.type,b.id);return d.on("remove",function(a){return a.type=a.type.substr(1),a.$processedAt?c.resolve(a):(c.reject(new f({message:"Task has been cancelled",task:a})),void 0)}),d.on("update",function(b){var d=b.$error;b.$error&&(b.type=b.type.substr(1),delete b.$error,d.object=b,d.message=d.message||"Something went wrong",c.reject(new f(d)),a.store.remove("$"+b.type,b.id))}),c.promise()}function g(b){var c,d=b.type,e=b.id,f=a.store.remove(d,e);return b._rev?(c=a.defer(),a.one("store:sync:"+d+":"+e,c.resolve),f.fail(c.reject),c.promise()):f}function h(a,b,c){"$"===b.type[0]&&(b.type=b.type.substr(1),l(a,b,c))}function i(b){var c,d="$";return b&&(d+=b),c=function(a){return 0===a.type.indexOf(d)},a.store.findAll(c)}function j(a){return a.map(function(a){return n.cancel(a.type.substr(1),a.id)})}function k(a,b){return a.map(function(a){return n.restart(a.type.substr(1),a.id,b)})}function l(a,b,c){var d;return"new"===a&&(a="start"),"remove"===a&&b.cancelledAt&&(a="cancel"),"remove"===a&&b.$processedAt&&(a="success"),"update"===a&&b.$error?(a="error",d=b.$error,delete b.$error,n.trigger("error",d,b,c),n.trigger(b.type+":error",d,b,c),n.trigger(b.type+":"+b.id+":error",d,b,c),c=$.extend({},c,{error:d}),n.trigger("change","error",b,c),n.trigger(b.type+":change","error",b,c),n.trigger(b.type+":"+b.id+":change","error",b,c),void 0):(("start"===a||"cancel"===a||"success"===a)&&(n.trigger(a,b,c),n.trigger(b.type+":"+a,b,c),"start"!==a&&n.trigger(b.type+":"+b.id+":"+a,b,c),n.trigger("change",a,b,c),n.trigger(b.type+":change",a,b,c),"start"!==a&&n.trigger(b.type+":"+b.id+":change",a,b,c)),void 0)}function m(){return JSON.stringify(new Date).replace(/['"]/g,"")}var n=function o(b,c){return e(a,o,{type:b,id:c})};d(a,{context:n,namespace:"task"}),n.start=function(b,d){return a.account.hasAccount()?a.store.add("$"+b,d).then(c):a.account.anonymousSignUp().then(function(){return n.start(b,d)})},n.cancel=function(b,c){return a.store.update("$"+b,c,{cancelledAt:m()}).then(g)},n.restart=function(a,b,c){var d=function(a){return $.extend(a,c),delete a.$error,delete a.$processedAt,delete a.cancelledAt,n.start(a.type,a)};return n.cancel(a,b).then(d)},n.cancelAll=function(a){return i(a).then(j)},n.restartAll=function(a,b){return"object"==typeof a&&(b=a),i(a).then(function(a){k(a,b)})},n.subscribeToOutsideEvents=function(){b(),delete n.subscribeToOutsideEvents},a.task=n}var d=a("./events"),e=a("./scoped_task"),f=a("./error");b.exports=c},{"./error":8,"./events":11,"./scoped_task":19}]},{},[2])(2)});
=======
!function(e){"object"==typeof exports?module.exports=e():"function"==typeof define&&define.amd?define(e):"undefined"!=typeof window?window.Hoodie=e():"undefined"!=typeof global?global.Hoodie=e():"undefined"!=typeof self&&(self.Hoodie=e())}(function(){var e;return function o(e,n,d){function f(t,u){if(!n[t]){if(!e[t]){var l="function"==typeof require&&require;if(!u&&l)return l(t,!0);if(i)return i(t,!0);throw new Error("Cannot find module '"+t+"'")}var p=n[t]={exports:{}};e[t][0].call(p.exports,function(o){var n=e[t][1][o];return f(n?n:o)},p,p.exports,o,e,n,d)}return n[t].exports}for(var i="function"==typeof require&&require,t=0;t<d.length;t++)f(d[t]);return f}({1:[function(o,n){function d(e){var o=this;if(!(o instanceof d))throw new Error("usage: new Hoodie(url);");e&&(o.baseUrl=e.replace(/\/+$/,"")),o.extend=function(e){e(o)},o.extend(H),o.extend(p),o.extend(c),o.extend(s),o.extend(b),o.extend(y),o.extend(w),o.extend(a),o.store.patchIfNotPersistant(),o.extend(r),o.extend(l),o.extend(t),o.extend(u),o.account.username=o.config.get("_account.username"),o.account.checkPasswordReset(),o.on("account:signout",o.config.clear),o.store.subscribeToOutsideEvents(),o.store.bootstrapDirtyObjects(),o.remote.subscribeToOutsideEvents(),o.task.subscribeToOutsideEvents(),o.account.authenticate().then(function(){o.remote.connect()}),window.addEventListener("online",o.checkConnection,!1),window.addEventListener("offline",o.checkConnection,!1),o.checkConnection(),f(o)}function f(e){for(var o=0;o<g.length;o++)g[o](e)}var i="undefined"!=typeof self?self:"undefined"!=typeof window?window:{},t=o("./hoodie/account"),u=o("./hoodie/account_remote"),l=o("./hoodie/config"),p=o("./hoodie/promises"),c=o("./hoodie/request"),s=o("./hoodie/connection"),y=o("./hoodie/dispose"),w=o("./hoodie/open"),a=o("./hoodie/local_store"),b=o("./hoodie/generate_id"),r=o("./hoodie/task"),H=o("./hoodie/events"),g=[];d.extend=function(e){g.push(e)},"object"==typeof n&&n&&"object"==typeof n.exports?n.exports=d:"function"==typeof e&&e.amd?e(function(){return d}):i.Hoodie=d},{"./hoodie/account":2,"./hoodie/account_remote":3,"./hoodie/config":4,"./hoodie/connection":5,"./hoodie/dispose":6,"./hoodie/events":10,"./hoodie/generate_id":11,"./hoodie/local_store":12,"./hoodie/open":13,"./hoodie/promises":14,"./hoodie/request":16,"./hoodie/task":20}],2:[function(e,o){function n(e){function o(o){return e.config.set(N,o)}function n(){return e.config.get(N)}function f(){return e.config.unset(N)}function i(){e.on("remote:error:unauthenticated",t)}function t(){return I=void 0,J.authenticate()}function u(o){return J.username!==o?(J.username=o,e.config.set("_account.username",o)):void 0}function l(o){return J.ownerHash!==o?(J.ownerHash=o,e.config.set("createdBy",o),e.config.set("_account.ownerHash",o)):void 0}function p(o){return o.userCtx.name?(I=!0,u(o.userCtx.name.replace(/^user(_anonymous)?\//,"")),l(o.userCtx.roles[0]),e.resolveWith(J.username)):J.hasAnonymousAccount()?J.signIn(J.username,n()):(I=!1,J.trigger("error:unauthenticated"),e.reject())}function c(e,o){return function(n){return J.trigger("signup",e),K._rev=n.rev,y(e,o)}}function s(o){return function(n){return"HoodieConflictError"===n.name&&(n.message="Username "+o+" already exists"),e.rejectWith(n)}}function y(o,n,d,f){return f||(f=e.defer()),window.setTimeout(function(){var e=F(o,n);e.done(f.resolve),e.fail(function(e){"HoodieAccountUnconfirmedError"===e.name?y(o,n,d,f):f.reject.apply(f,arguments)})},300),f.promise()}function w(o){return o=o||{},function(n){var d,f;return d=e.defer(),f=n.name.replace(/^user(_anonymous)?\//,""),-1!==n.roles.indexOf("error")?(J.fetch(f).fail(d.reject).done(function(){return d.reject(K.$error)}),d.promise()):-1===n.roles.indexOf("confirmed")?d.reject({name:"HoodieAccountUnconfirmedError",message:"Account has not been confirmed yet"}):(u(f),l(n.roles[0]),I=!0,o.silent||o.reauthenticated||(J.hasAnonymousAccount()?J.trigger("signin:anonymous",f):J.trigger("signin",f)),o.reauthenticated&&J.trigger("reauthenticated",f),J.fetch(),d.resolve(f,n.roles[0]))}}function a(o){var n;return n=o.$error?o.$error:{name:"HoodiePendingError",message:"Password reset is still pending"},e.rejectWith(n)}function b(o){return"HoodieUnauthorizedError"===o.name?(e.config.unset("_account.resetPasswordId"),J.trigger("passwordreset"),e.resolve()):e.rejectWith(o)}function r(){var o=e.defer();return J.one("passwordreset",o.resolve),J.one("error:passwordreset",o.reject),o.always(function(){J.unbind("passwordreset",o.resolve),J.unbind("error:passwordreset",o.reject)}),o.promise()}function H(e,o,n){return F(J.username,e,{silent:!0}).then(function(){return J.fetch().then(z(e,o,n))})}function g(e,o){var d=n();return H(d,e,o).done(function(){J.trigger("signup",e),f()})}function m(){return e.remote.disconnect(),K._deleted=!0,B("updateUsersDoc",function(){J.request("PUT",v(),{data:JSON.stringify(K),contentType:"application/json"})})}function x(o){return"HoodieNotFoundError"===o.name?e.resolve():e.rejectWith(o)}function j(o){return o=o||{},J.trigger("cleanup"),I=o.authenticated,e.config.clear(),u(o.username),l(o.ownerHash||e.generateId()),e.resolve()}function h(){return j().then(function(){return J.trigger("signout")})}function k(e){var o;return o=e===J.ownerHash?"user_anonymous":"user",""+o+"/"+e}function q(e){return e=e||J.username,""+M+":"+k(e)}function v(e){return"/_users/"+encodeURIComponent(q(e))}function z(e,o,n){return function(){var d=$.extend({},K);o&&(d.$newUsername=o),d.updatedAt=G(),d.signedUpAt=d.signedUpAt||G(),null!==n&&(delete d.salt,delete d.password_sha,d.password=n);var f={data:JSON.stringify(d),contentType:"application/json"};return B("updateUsersDoc",function(){return J.request("PUT",v(),f).then(A(o,n||e))})}}function A(o,n){return function(){return e.remote.disconnect(),o?y(o,n,{silent:!0}):J.signIn(J.username,n)}}function B(e,o){return void 0!==L[e]&&"function"==typeof L[e].abort&&L[e].abort(),L[e]=o(),L[e]}function C(e,o){return void 0!==L[e]&&"function"==typeof L[e].state&&"pending"===L[e].state()?L[e]:(L[e]=o(),L[e])}function D(o){return e.store.hasLocalChanges()&&!o.ignoreLocalChanges?e.remote.push():e.resolve()}function E(){return C("signOut",function(){return J.request("DELETE","/_session")})}function F(e,o,n){var d={data:{name:k(e),password:o}};return B("signIn",function(){var e=J.request("POST","/_session",d);return e.then(w(n))})}function G(){return new Date}var I,J={},K={},L={},M="org.couchdb.user";d(e,{context:J,namespace:"account"}),J.authenticate=function(){var o;return I===!1?e.reject():I===!0?e.resolveWith(J.username):L.signOut&&"pending"===L.signOut.state()?L.signOut.then(e.reject):L.signIn&&"pending"===L.signIn.state()?L.signIn:J.hasAccount()?(o=function(){return J.request("GET","/_session").then(p)},C("authenticate",o)):E().then(function(){return I=!1,e.reject()})},J.hasValidSession=function(){return J.hasAccount()?I===!0:!1},J.hasInvalidSession=function(){return J.hasAccount()?I===!1:!1},J.signUp=function(o,n){if(void 0===n&&(n=""),!o)return e.rejectWith("Username must be set.");if(J.hasAnonymousAccount())return g(o,n);if(J.hasAccount())return e.rejectWith("Must sign out first.");o=o.toLowerCase();var d={data:JSON.stringify({_id:q(o),name:k(o),type:"user",roles:[],password:n,ownerHash:J.ownerHash,database:J.db(),updatedAt:G(),createdAt:G(),signedUpAt:o!==J.ownerHash?G():void 0}),contentType:"application/json"};return J.request("PUT",v(o),d).then(c(o,n),s(o))},J.anonymousSignUp=function(){var n,d;return n=e.generateId(10),d=J.ownerHash,J.signUp(d,n).done(function(){return o(n),J.trigger("signup:anonymous",d)})},J.hasAccount=function(){return!!J.username},J.hasAnonymousAccount=function(){return J.username===J.ownerHash};var N="_account.anonymousPassword";J.signIn=function(o,n,d){var f,i=function(){return J.signOut({silent:!0}).then(function(){return F(o,n)})};return d=d||{},null===o&&(o=""),void 0===n&&(n=""),o=o.toLowerCase(),o!==J.username?d.moveData?e.store.findAll().then(function(e){f=e}).then(i).done(function(){f.forEach(function(o){var n=o.type;("$config"!==n||"hoodie"!==o.id)&&(delete o.type,o.createdBy=e.account.ownerHash,e.store.add(n,o))})}):i():F(o,n,{reauthenticated:!0})},J.signOut=function(o){return o=o||{},J.hasAccount()?D(o).then(e.remote.disconnect).then(E).then(h):j().then(function(){return o.silent?void 0:J.trigger("signout")})},J.request=function(o,n,d){return d=d||{},e.request.apply(e,arguments)},J.db=function(){return"user/"+J.ownerHash},J.fetch=function(o){return void 0===o&&(o=J.username),o?C("fetch",function(){return J.request("GET",v(o)).done(function(e){return K=e})}):e.rejectWith({name:"HoodieUnauthorizedError",message:"Not signed in"})},J.changePassword=function(o,n){return J.username?(e.remote.disconnect(),J.fetch().then(z(o,null,n))):e.rejectWith({name:"HoodieUnauthorizedError",message:"Not signed in"})},J.resetPassword=function(o){var n,d,f,i;return(i=e.config.get("_account.resetPasswordId"))?J.checkPasswordReset():(i=""+o+"/"+e.generateId(),e.config.set("_account.resetPasswordId",i),d=""+M+":$passwordReset/"+i,n={_id:d,name:"$passwordReset/"+i,type:"user",roles:[],password:i,createdAt:G(),updatedAt:G()},f={data:JSON.stringify(n),contentType:"application/json"},B("resetPassword",function(){return J.request("PUT","/_users/"+encodeURIComponent(d),f).done(J.checkPasswordReset).then(r)}))},J.checkPasswordReset=function(){var o,n,d,f,i;return(d=e.config.get("_account.resetPasswordId"))?(i="$passwordReset/"+d,f="/_users/"+encodeURIComponent(M+":"+i),o=btoa(i+":"+d),n={headers:{Authorization:"Basic "+o}},B("passwordResetStatus",function(){return J.request("GET",f,n).then(a,b).fail(function(e){return"HoodiePendingError"===e.name?(window.setTimeout(J.checkPasswordReset,1e3),void 0):J.trigger("passwordreset:error")})})):e.rejectWith("No pending password reset.")},J.changeUsername=function(e,o){return o=o||"",H(e,o.toLowerCase())},J.destroy=function(){return J.hasAccount()?J.fetch().then(m,x).then(h):h()},J.subscribeToOutsideEvents=function(){i(),delete J.subscribeToOutsideEvents},e.account=J,e.account.ownerHash=e.config.get("_account.ownerHash"),e.account.ownerHash||l(e.generateId())}var d=e("./events");o.exports=n},{"./events":10}],3:[function(e,o){function n(e){function o(o){return o?e.config.set("_remote.since",o):e.config.get("_remote.since")||0}function n(){e.on("remote:connect",function(){e.on("store:idle",d.push),d.push()}),e.on("remote:disconnect",function(){e.unbind("store:idle",d.push)}),e.on("disconnected",d.disconnect),e.on("reconnected",d.connect),e.on("account:signin",d.connect),e.on("account:signin:anonymous",d.connect),e.on("account:reauthenticated",d.connect),e.on("account:signout",d.disconnect)}var d=e.open(e.account.db(),{connected:!0,prefix:"",since:o,defaultObjectsToPush:e.store.changedObjects,knownObjects:e.store.index().map(function(e){var o=e.split(/\//);return{type:o[0],id:o[1]}})}),f=d.connect;d.connect=function(){return e.account.hasAccount()?f(e.account.db()):e.rejectWith("User has no database to connect to")},d.trigger=function(){var o;o=arguments[0];var n=2<=arguments.length?Array.prototype.slice.call(arguments,1):[];return e.trigger.apply(e,["remote:"+o].concat(Array.prototype.slice.call(n)))},d.on=function(o,n){return o=o.replace(/(^| )([^ ]+)/g,"$1remote:$2"),e.on(o,n)},d.unbind=function(o,n){return o=o.replace(/(^| )([^ ]+)/g,"$1remote:$2"),e.unbind(o,n)},d.subscribeToOutsideEvents=function(){n(),delete d.subscribeToOutsideEvents},e.remote=d}o.exports=n},{}],4:[function(e,o){function n(e){var o="$config",n="hoodie",d={},f={};f.set=function(f,i){var t,u;if(d[f]!==i)return d[f]=i,u={},u[f]=i,t="_"===f.charAt(0),e.store.updateOrAdd(o,n,u,{silent:t})},f.get=function(e){return d[e]},f.clear=function(){return d={},e.store.remove(o,n)},f.unset=function(e){return f.set(e,void 0)},e.store.find(o,n).done(function(e){d=e}),e.config=f}o.exports=n},{}],5:[function(e,o){function n(e){function o(){return f=3e4,t=window.setTimeout(e.checkConnection,f),e.isConnected()||(e.trigger("reconnected"),d=!0),e.resolve()}function n(){return f=3e3,t=window.setTimeout(e.checkConnection,f),e.isConnected()&&(e.trigger("disconnected"),d=!1),e.reject()}var d=!0,f=3e4,i=null,t=null;e.checkConnection=function(){var d=i;return d&&"pending"===d.state()?d:(window.clearTimeout(t),i=e.request("GET","/").then(o,n))},e.isConnected=function(){return d}}o.exports=n},{}],6:[function(e,o){function n(e){function o(){e.trigger("dispose"),e.unbind()}e.dispose=o}o.exports=n},{}],7:[function(e,o){function n(e){if("string"==typeof e&&(e={message:e}),!e.message)throw new Error("FATAL: error.message must be set");e.name||(e.name="HoodieError"),e.message=e.message.replace(d,function(o){var n=o.match(f)[0];return e[n]}),$.extend(this,e)}var d=/\{\{\s*\w+\s*\}\}/g,f=/\w+/;n.prototype=new Error,n.prototype.constructor=n,o.exports=n},{}],8:[function(e,o){function n(e){return e.name="HoodieObjectIdError",e.message='"{{id}}" is invalid object id. {{rules}}.',new d(e)}var d=e("../error"),f=/^[a-z0-9\-]+$/;n.isInvalid=function(e,o){return!(o||f).test(e||"")},n.isValid=function(e,o){return(o||f).test(e||"")},n.prototype.rules="Lowercase letters, numbers and dashes allowed only. Must start with a letter",o.exports=n},{"../error":7}],9:[function(e,o){function n(e){return e.name="HoodieObjectTypeError",e.message='"{{type}}" is invalid object type. {{rules}}.',new d(e)}var d=e("../error"),f=/^[a-z$][a-z0-9]+$/;n.isInvalid=function(e,o){return!(o||f).test(e||"")},n.isValid=function(e,o){return(o||f).test(e||"")},n.prototype.rules="lowercase letters, numbers and dashes allowed only. Must start with a letter",o.exports=n},{"../error":7}],10:[function(e,o){function n(e,o){function n(o,n){var d,f,i,t;for(d=o.split(" "),i=0,t=d.length;t>i;i++)f=u+d[i],e.eventsCallbacks[f]=e.eventsCallbacks[f]||[],e.eventsCallbacks[f].push(n)}function d(o,n){o=u+o;var d=function(){e.unbind(o,d),n.apply(null,arguments)};e.bind(o,d)}function f(){var o,n,d,f,i,t;if(o=1<=arguments.length?Array.prototype.slice.call(arguments,0):[],d=o.shift(),d=u+d,f=e.eventsCallbacks[d]){for(i=0,t=f.length;t>i;i++)n=f[i],n.apply(null,o);return!0}}function i(o,n){var d,f,i,t,l,p;if(!o)return u||(e.eventsCallbacks={}),p=Object.keys(e.eventsCallbacks),p=p.filter(function(e){return 0===e.indexOf(u)}),p.forEach(function(o){delete e.eventsCallbacks[o]}),void 0;if(o=u+o,i=e.eventsCallbacks[o]){if(!n)return delete e.eventsCallbacks[o],void 0;for(f=t=0,l=i.length;l>t;f=++t)if(d=i[f],d===n){i=i.slice(),i.splice(f,1),e.eventsCallbacks[o]=i;break}}}var t=e,u="";o=o||{},e.eventsCallbacks||(e.eventsCallbacks={}),o.context&&(t=o.context,u=o.namespace+":"),t.bind=n,t.on=n,t.one=d,t.trigger=f,t.unbind=i,t.off=i}o.exports=n},{}],11:[function(e,o){function n(e){function o(e){var o="";for(void 0===e&&(e=7),d=0;e>d;d++){var i=Math.random()*f,t=n[Math.floor(i)];o+=String(t).charAt(0)}return o}var n,d,f;n="0123456789abcdefghijklmnopqrstuvwxyz".split(""),f=n.length,e.generateId=o}o.exports=n},{}],12:[function(e,o){function n(e){function o(e){if(f.isInvalid(e.type))return new f({type:e.type});if(e.id)return i.isInvalid(e.id)?new i({id:e.id}):void 0}function n(e,o,n,d){var f;if(void 0===n&&(n=!1),d=d||{},f=""+e+"/"+o,n){if($.extend(n,{type:e,id:o}),w(e,o,n),d.remote)return p(e,o),A[f]=$.extend(!0,{},n),A[f]}else{if(A[f]===!1)return!1;if(A[f])return $.extend(!0,{},A[f]);if(n=a(e,o),n===!1)return p(e,o),A[f]=!1,!1}return m(n)?(l(e,o,n,d),A[f]=!1,!1):(A[f]=$.extend(!0,{},n),g(n)?l(e,o,A[f],d):p(e,o),$.extend(!0,{},n))}function t(){var e,o,d,f,i,t,u;if(o=G.getItem("_dirty"))for(o=o.split(","),i=0,t=o.length;t>i;i++)u=o[i].split("/"),f=u[0],e=u[1],d=n(f,e)}function u(){e.on("account:cleanup",E.clear),e.on("account:signup",c),e.on("remote:bootstrap:start",h),e.on("remote:bootstrap:end",k),e.on("remote:change",s),e.on("remote:push",y)}function l(e,o,n,d){var f;d=d||{},f=""+e+"/"+o,B[f]=n,b(),d.silent||j()}function p(e,o){var n;return e&&o?(n=""+e+"/"+o,delete B[n]):B={},b(),window.clearTimeout(I)}function c(){return E.findAll().pipe(function(e){var o,n,d,f;for(d=0,f=e.length;f>d;d++)n=e[d],o=""+n.type+"/"+n.id,B[o]=n;b(),j()})}function s(e,o){"remove"===e?E.remove(o.type,o.id,{remote:!0,update:o}):E.save(o.type,o.id,o,{remote:!0})}function y(e){x("sync",e)}function w(e,o,n){var d,f;return d=""+e+"/"+o,f=$.extend({},n),delete f.type,delete f.id,G.setItem(d,JSON.stringify(f))}function a(e,o){var n,d;n=""+e+"/"+o;var f=G.getItem(n);return f?(d=JSON.parse(f),d.type=e,d.id=o,d):!1}function b(){try{if($.isEmptyObject(B))G.removeItem("_dirty");else{var e=Object.keys(B);G.setItem("_dirty",e.join(","))}}catch(o){}}function r(){return JSON.stringify(new Date).replace(/['"]/g,"")}function H(e){return J.test(e)}function g(e){return e.updatedAt?e._syncedAt?e._syncedAt<e.updatedAt:!0:!1}function m(e){return e._deleted===!0}function x(e,o,n){E.trigger(e,$.extend(!0,{},o),n),E.trigger(o.type+":"+e,$.extend(!0,{},o),n),E.trigger(e+":"+o.type,$.extend(!0,{},o),n),"new"!==e&&(E.trigger(o.type+":"+o.id+":"+e,$.extend(!0,{},o),n),E.trigger(e+":"+o.type+":"+o.id,$.extend(!0,{},o),n)),"sync"!==e&&(E.trigger("change",e,$.extend(!0,{},o),n),E.trigger(o.type+":change",e,$.extend(!0,{},o),n),E.trigger("change:"+o.type,e,$.extend(!0,{},o),n),"new"!==e&&(E.trigger(o.type+":"+o.id+":change",e,$.extend(!0,{},o),n),E.trigger("change:"+o.type+":"+o.id,e,$.extend(!0,{},o),n)))}function j(){E.trigger("dirty"),window.clearTimeout(I),I=window.setTimeout(function(){E.trigger("idle",E.changedObjects())},D)}function h(){F=!0,E.trigger("bootstrap:start")}function k(){var e,o,n,d;for(F=!1;C.length>0;)e=C.shift(),o=e[0],n=e[1],d=e[2],z[o].apply(z,n).then(d.resolve,d.reject);E.trigger("bootstrap:end")}function q(o,n){var d=e.defer();return C.push([o,n,d]),d.promise()}function v(){E.isPersistent()||(G={getItem:function(){return null},setItem:function(){return null},removeItem:function(){return null},key:function(){return null},length:function(){return 0}})}var z={},A={},B={},C=[],D=2e3;z.save=function(o,d){var f,i,t,u,l,p;if(d=d||{},E.isBootstrapping()&&!d.remote)return q("save",arguments);if(o.id?(f=n(o.type,o.id),l="object"!=typeof f):(l=!0,o.id=e.generateId()),l?o.createdBy=o.createdBy||e.account.ownerHash:f.createdBy&&(o.createdBy=f.createdBy),!l)for(p in f)if(!o.hasOwnProperty(p))switch(p.charAt(0)){case"_":d.remote&&(o[p]=f[p]);break;case"$":d.remote||(o[p]=f[p])}d.remote?o._syncedAt=r():d.silent||(o.updatedAt=r(),o.createdAt=o.createdAt||o.updatedAt),d.local?o._$local=!0:delete o._$local,i=e.defer();try{o=n(o.type,o.id,o,d),i.resolve(o,l).promise(),u=l?"add":"update",x(u,o,d)}catch(c){t=c,i.reject(t.toString())}return i.promise()},z.find=function(o,d){var f,i;if(E.isBootstrapping())return q("find",arguments);try{return i=n(o,d),i?e.resolveWith(i):e.rejectWith({name:"HoodieNotFoundError",message:'"{{type}}" with id "{{id}}" could not be found'})}catch(t){return f=t,e.rejectWith(f)}},z.findAll=function(o){var d,f,i,t,u,l,p,c,s;if(null==o&&(o=function(){return!0}),E.isBootstrapping())return q("findAll",arguments);l=E.index(),"string"==typeof o&&(s=o,o=function(e){return e.type===s}),f=e.defer();try{c=function(){var e,f,i,c;for(c=[],e=0,f=l.length;f>e;e++)u=l[e],H(u)&&(i=u.split("/"),d=i[0],t=i[1],p=n(d,t),p&&o(p)&&c.push(p));return c}.call(this),c.sort(function(e,o){return e.createdAt>o.createdAt?-1:e.createdAt<o.createdAt?1:0}),f.resolve(c).promise()}catch(y){i=y,f.reject(i).promise()}return f.promise()},z.remove=function(o,d,f){var i,t,u;return f=f||{},E.isBootstrapping()&&!f.remote?q("remove",arguments):(i=o+"/"+d,t=n(o,d),f.remote&&(G.removeItem(i),u=A[i]&&m(A[i]),A[i]=!1,p(o,d),u&&t)?e.resolveWith(t):t?(t._syncedAt?(t._deleted=!0,n(o,d,t)):(i=o+"/"+d,G.removeItem(i),A[i]=!1,p(o,d)),f.update&&(t=f.update,delete f.update),x("remove",t,f),e.resolveWith(t)):e.rejectWith({name:"HoodieNotFoundError",message:'"{{type}}" with id "{{id}}"" could not be found'}))},z.removeAll=function(e,o){return E.findAll(e).then(function(e){var n,d,f,i;for(i=[],d=0,f=e.length;f>d;d++)n=e[d],i.push(E.remove(n.type,n.id,o));return i})};var E=d(e,{validate:o,backend:{save:z.save,find:z.find,findAll:z.findAll,remove:z.remove,removeAll:z.removeAll}});E.index=function(){var e,o,n,d,f;for(n=[],e=d=0,f=G.length();f>=0?f>d:d>f;e=f>=0?++d:--d)o=G.key(e),H(o)&&n.push(o);return n},E.changedObjects=function(){var e,o,n,d,f,i,t;f=B,t=[];for(o in f)f.hasOwnProperty(o)&&(n=f[o],i=o.split("/"),d=i[0],e=i[1],n.type=d,n.id=e,t.push(n));return t},E.hasLocalChanges=function(e,o){if(!e)return!$.isEmptyObject(B);var d=[e,o].join("/");return B[d]?!0:g(n(e,o))},E.clear=function(){var o,n,d,f;o=e.defer();try{d=E.index(),f=function(){var e,o,f;for(f=[],e=0,o=d.length;o>e;e++)n=d[e],H(n)&&f.push(G.removeItem(n));return f}.call(this),A={},p(),o.resolve(),E.trigger("clear")}catch(i){o.reject(i)}return o.promise()};var F=!1;E.isBootstrapping=function(){return F},E.isPersistent=function(){try{if(!window.localStorage)return!1;if(localStorage.setItem("Storage-Test","1"),"1"!==localStorage.getItem("Storage-Test"))return!1;localStorage.removeItem("Storage-Test")}catch(e){return!1}return!0};var G={getItem:function(e){return window.localStorage.getItem(e)},setItem:function(e,o){return window.localStorage.setItem(e,o)},removeItem:function(e){return window.localStorage.removeItem(e)},key:function(e){return window.localStorage.key(e)},length:function(){return window.localStorage.length}};E.subscribeToOutsideEvents=function(){u(),delete E.subscribeToOutsideEvents};var I,J=new RegExp(/^[a-z$][a-z0-9]+\/[a-z0-9]+$/);e.store=E,E.bootstrapDirtyObjects=function(){t(),delete E.bootstrapDirtyObjects},E.patchIfNotPersistant=function(){v(),delete E.patchIfNotPersistant}}var d=e("./store"),f=e("./error/object_type"),i=e("./error/object_id");o.exports=n},{"./error/object_id":8,"./error/object_type":9,"./store":19}],13:[function(e,o){function n(e){function o(o,n){return n=n||{},$.extend(n,{name:o}),d(e,n)}e.open=o}var d=e("./remote_store");o.exports=n},{"./remote_store":15}],14:[function(e,o){function n(e){function o(e){return!(!e||"function"!=typeof e.done||"function"==typeof e.resolve)}function n(){return u().resolve().promise()}function f(){return u().reject().promise()}function i(){var e=u();return e.resolve.apply(e,arguments).promise()}function t(e){var o=u(),n=new d(e);return o.reject(n).promise()}var u=window.jQuery.Deferred;e.defer=u,e.isPromise=o,e.resolve=n,e.reject=f,e.resolveWith=i,e.rejectWith=t}var d=e("./error");o.exports=n},{"./error":7}],15:[function(e,o){function n(e,o){function n(e){return"function"==typeof x?x(e):x=e}function f(e){var o,n;n=$.extend({},e);for(o in n)if(n.hasOwnProperty(o)){if(-1!==z.indexOf(o))continue;if(!/^_/.test(o))continue;delete n[o]}return n._id=""+n.type+"/"+n.id,H.prefix&&(n._id=""+H.prefix+n._id),delete n.id,n}function i(e){var o,n,d;return o=e._id||e.id,delete e._id,H.prefix&&(o=o.replace(m,"")),d=o.match(/([^\/]+)\/(.*)/),n=d[0],e.type=d[1],e.id=d[2],e}function t(e){var o,n,d,f;for(f=[],n=0,d=e.length;d>n;n++)o=e[n],f.push(i(o));return f}function u(e){var o,n,d,f;try{f=e._rev.split(/-/),n=f[0],o=f[1]}catch(i){}return n=parseInt(n,10)||0,d=l(),e._$local&&(d+="-local"),e._rev=""+(n+1)+"-"+d,e._revisions={start:1,ids:[d]},o?(e._revisions.start+=n,e._revisions.ids.push(o)):void 0}function l(){return e.generateId(9)}function p(e){return e.rows.map(function(e){return e.doc})}function c(){var e;return e=H.getSinceNr(),H.isConnected()&&!j?"/_changes?include_docs=true&since="+e+"&heartbeat=10000&feed=longpoll":"/_changes?include_docs=true&since="+e}function s(){h&&h.abort()}function y(e){return n(e.last_seq),b(e.results),H.isConnected()?H.pull():void 0}function w(o,n){if(H.isConnected())switch(o.status){case 401:return H.trigger("error:unauthenticated",n),H.disconnect();case 404:return window.setTimeout(H.pull,3e3);case 500:return H.trigger("error:server",n),window.setTimeout(H.pull,3e3),e.checkConnection();default:return"abort"===o.statusText?H.pull():(window.setTimeout(H.pull,3e3),e.checkConnection())}}function a(){j=!1,H.trigger("bootstrap:end")}function b(e){var o,n,d,f,t;for(f=0,t=e.length;t>f;f++)if(o=e[f].doc,!H.prefix||0===o._id.indexOf(H.prefix)){if(d=i(o),d._deleted){if(!H.isKnownObject(d))continue;n="remove",H.isKnownObject(d)}else H.isKnownObject(d)?n="update":(n="add",H.markAsKnownObject(d));H.trigger(n,d),H.trigger(n+":"+d.type,d),H.trigger(n+":"+d.type+":"+d.id,d),H.trigger("change",n,d),H.trigger("change:"+d.type,n,d),H.trigger("change:"+d.type+":"+d.id,n,d)}}var r={};r.find=function(e,o){var n;return n=e+"/"+o,H.prefix&&(n=H.prefix+n),n="/"+encodeURIComponent(n),H.request("GET",n).then(i)},r.findAll=function(e){var o,n,d;switch(n="/_all_docs?include_docs=true",!0){case void 0!==e&&""!==H.prefix:d=H.prefix+e+"/";break;case void 0!==e:d=e+"/";break;case""!==H.prefix:d=H.prefix;break;default:d=""}return d&&(o=d.replace(/.$/,function(e){var o;return o=e.charCodeAt(0),String.fromCharCode(o+1)}),n=""+n+'&startkey="'+encodeURIComponent(d)+'"&endkey="'+encodeURIComponent(o)+'"'),H.request("GET",n).then(p).then(t)},r.save=function(o){var n;return o.id||(o.id=e.generateId()),o=f(o),n="/"+encodeURIComponent(o._id),H.request("PUT",n,{data:o})},r.remove=function(e,o){return H.update(e,o,{_deleted:!0})},r.removeAll=function(e){return H.updateAll(e,{_deleted:!0})};var H=d(e,{name:o.name,backend:{save:r.save,find:r.find,findAll:r.findAll,remove:r.remove,removeAll:r.removeAll}}),g=null;H.connected=!1,H.prefix="";var m=new RegExp("^");void 0!==o.name&&(g=o.name),void 0!==o.prefix&&(H.prefix=o.prefix,m=new RegExp("^"+H.prefix)),null!==o.baseUrl&&(H.baseUrl=o.baseUrl),H.request=function(o,n,d){return d=d||{},g&&(n="/"+encodeURIComponent(g)+n),H.baseUrl&&(n=""+H.baseUrl+n),d.contentType=d.contentType||"application/json",("POST"===o||"PUT"===o)&&(d.dataType=d.dataType||"json",d.processData=d.processData||!1,d.data=JSON.stringify(d.data)),e.request(o,n,d)},H.isKnownObject=function(e){var o=""+e.type+"/"+e.id;return void 0!==v[o]?v[o]:void 0},H.markAsKnownObject=function(e){var o=""+e.type+"/"+e.id;return v[o]=1,v[o]},H.connect=function(e){return e&&(g=e),H.connected=!0,H.trigger("connect"),H.bootstrap().then(function(){H.push()})},H.disconnect=function(){H.connected=!1,H.trigger("disconnect"),h&&h.abort(),q&&q.abort()},H.isConnected=function(){return H.connected};var x=o.since||0;H.getSinceNr=function(){return"function"==typeof x?x():x};var j=!1;H.bootstrap=function(){return j=!0,H.trigger("bootstrap:start"),H.pull().done(a)};var h,k;H.pull=function(){return h=H.request("GET",c()),H.isConnected()&&(window.clearTimeout(k),k=window.setTimeout(s,25e3)),h.done(y).fail(w)};var q;H.push=function(o){var n,d,i,t;if($.isArray(o)||(o=A()),0===o.length)return e.resolveWith([]);for(d=[],i=0,t=o.length;t>i;i++)n=$.extend(!0,{},o[i]),u(n),n=f(n),d.push(n);return q=H.request("POST","/_bulk_docs",{data:{docs:d,new_edits:!1}}),q.done(function(){for(var e=0;e<o.length;e++)H.trigger("push",o[e])}),q},H.sync=function(e){return H.push(e).then(H.pull)};var v={},z=["_id","_rev","_deleted","_revisions","_attachments"],A=function(){return[]};if(o.defaultObjectsToPush&&(A=$.isArray(o.defaultObjectsToPush)?function(){return o.defaultObjectsToPush}:o.defaultObjectsToPush),o.knownObjects)for(var B=0;B<o.knownObjects.length;B++)H.markAsKnownObject({type:o.knownObjects[B].type,id:o.knownObjects[B].id});return H}var d=e("./store");o.exports=n},{"./store":19}],16:[function(e,o){function n(e){function o(o,d,f){var l,p,c;return f=f||{},l={type:o,dataType:"json"},/^http/.test(d)||(d=(e.baseUrl||"")+u+d),/^http/.test(d)&&(l.xhrFields={withCredentials:!0},l.crossDomain=!0),l.url=d,p=t(i(l,f)),c=p.then(null,n),c.abort=p.abort,c}function n(o){var n;try{n=d(o)}catch(f){n=o.responseText?o.responseText:{name:"HoodieConnectionError",message:"Could not connect to Hoodie server at {{url}}.",url:e.baseUrl||"/"}}return e.rejectWith(n).promise()}function d(e){var o=JSON.parse(e.responseText);return o.name=l[e.status],o.name||(o.name=f(o.error)),o.status=e.status,o.message=o.reason||"",o.message=o.message.charAt(0).toUpperCase()+o.message.slice(1),delete o.error,delete o.reason,o}function f(e){return e=e.replace(/(^\w|_\w)/g,function(e){return(e[1]||e[0]).toUpperCase()}),"Hoodie"+e+"Error"}var i=$.extend,t=$.ajax,u="/_api",l={400:"HoodieRequestError",401:"HoodieUnauthorizedError",403:"HoodieRequestError",404:"HoodieNotFoundError",409:"HoodieConflictError",412:"HoodieConflictError",500:"HoodieServerError"};e.request=o}o.exports=n},{}],17:[function(e,o){function n(e,o,n){var f=n.name||"store",i=n.type,t=n.id,u={};return t||(d(e,{context:u,namespace:f+":"+i}),u.save=function(e,n,d){return o.save(i,e,n,d)},u.add=function(e,n){return o.add(i,e,n)},u.find=function(e){return o.find(i,e)},u.findOrAdd=function(e,n){return o.findOrAdd(i,e,n)},u.findAll=function(e){return o.findAll(i,e)},u.update=function(e,n,d){return o.update(i,e,n,d)},u.updateAll=function(e,n){return o.updateAll(i,e,n)},u.remove=function(e,n){return o.remove(i,e,n)},u.removeAll=function(e){return o.removeAll(i,e)}),t&&(d(e,{context:u,namespace:f+":"+i+":"+t}),u.save=function(e,n){return o.save(i,t,e,n)},u.find=function(){return o.find(i,t)},u.update=function(e,n){return o.update(i,t,e,n)},u.remove=function(e){return o.remove(i,t,e)}),u.decoratePromises=o.decoratePromises,u.validate=o.validate,u}var d=e("./events");o.exports=n},{"./events":10}],18:[function(e,o){function n(e,o,n){var f=n.type,i=n.id,t={};return i||(d(e,{context:t,namespace:"task:"+f}),t.start=function(e){return o.start(f,e)},t.cancel=function(e){return o.cancel(f,e)},t.restart=function(e,n){return o.restart(f,e,n)},t.cancelAll=function(){return o.cancelAll(f)},t.restartAll=function(e){return o.restartAll(f,e)}),i&&(d(e,{context:t,namespace:"task:"+f+":"+i}),t.cancel=function(){return o.cancel(f,i)},t.restart=function(e){return o.restart(f,i,e)}),t}var d=e("./events");o.exports=n},{"./events":10}],19:[function(e,o){function n(e,o){function n(e){return $.extend(e,p)}var l={},p={hoodie:e},c=o.name||"store",s=function b(n,f){var i=$.extend(!0,{type:n,id:f},o);return d(e,b,i)};if(f(e,{context:s,namespace:c}),s.validate=o.validate,o.validate||(s.validate=function(e){if(!e)return new i({name:"InvalidObjectError",message:"No object passed."});if(t.isInvalid(e.type,w))return new t({type:e.type,rules:a});if(e.id)return u.isInvalid(e.id,w)?new u({id:e.id,rules:a}):void 0}),s.save=function(o,d,f,i){i=i?$.extend(!0,{},i):{};var t=$.extend(!0,{},f,{type:o,id:d}),u=s.validate(t,i||{});return u?e.rejectWith(u):n(l.save(t,i||{}))},s.add=function(e,o,n){return void 0===o&&(o={}),n=n||{},s.save(e,o.id,o,n)},s.find=function(e,o){return n(l.find(e,o))},s.findOrAdd=function(e,o,d){function f(){var n;return n=$.extend(!0,{id:o},d),s.add(e,n)}null===d&&(d={});var i=s.find(e,o).then(null,f);return n(i)},s.findAll=function(e,o){return n(l.findAll(e,o))},s.update=function(o,d,f,i){function t(n){var t,u,l;return u=$.extend(!0,{},n),"function"==typeof f&&(f=f(u)),f?(t=function(){var e=[];for(var o in f)if(f.hasOwnProperty(o)){if(l=f[o],n[o]!==l==!1)continue;u[o]=l,e.push(o)}return e}(),t.length||i?s.save(o,d,u,i):e.resolveWith(u)):e.resolveWith(n)}var u=s.find(o,d).then(t);return n(u)},s.updateOrAdd=function(e,o,d,f){function i(){var n=$.extend(!0,{},d,{id:o});return s.add(e,n,f)}var t=s.update(e,o,d,f).then(null,i);return n(t)},s.updateAll=function(o,d,f){var i;switch(f=f||{},!0){case"string"==typeof o:i=s.findAll(o);break;case e.isPromise(o):i=o;break;case $.isArray(o):i=e.defer().resolve(o).promise();break;default:i=s.findAll()}return i=i.then(function(e){var o,n;return $.isArray(e)||(e=[e]),n=function(){var n,i,t;for(t=[],n=0,i=e.length;i>n;n++)o=e[n],t.push(s.update(o.type,o.id,d,f));return t}(),$.when.apply(null,n)}),n(i)},s.remove=function(e,o,d){return n(l.remove(e,o,d||{}))},s.removeAll=function(e,o){return n(l.removeAll(e,o||{}))},s.decoratePromises=function(e){return $.extend(p,e)},!o.backend)throw new Error("options.backend must be passed");var y="save find findAll remove removeAll".split(" ");y.forEach(function(e){if(!o.backend[e])throw new Error("options.backend."+e+" must be passed.");
l[e]=o.backend[e]});var w=/^[^\/]+$/,a="/ not allowed";return s}var d=e("./scoped_store"),f=e("./events"),i=e("./error"),t=e("./error/object_type"),u=e("./error/object_id");o.exports=n},{"./error":7,"./error/object_id":8,"./error/object_type":9,"./events":10,"./scoped_store":17}],20:[function(e,o){function n(e){function o(){e.on("store:change",u)}function n(o){var n=e.defer(),d=e.store(o.type,o.id);return d.on("remove",function(e){return e.type=e.type.substr(1),e.$processedAt?n.resolve(e):(n.reject(new i({message:"Task has been cancelled",task:e})),void 0)}),d.on("update",function(o){var d=o.$error;o.$error&&(o.type=o.type.substr(1),delete o.$error,d.object=o,d.message=d.message||"Something went wrong",n.reject(new i(d)),e.store.remove("$"+o.type,o.id))}),n.promise()}function t(o){var n,d=o.type,f=o.id,i=e.store.remove(d,f);return o._rev?(n=e.defer(),e.one("store:sync:"+d+":"+f,n.resolve),i.fail(n.reject),n.promise()):i}function u(e,o,n){"$"===o.type[0]&&(o.type=o.type.substr(1),s(e,o,n))}function l(o){var n,d="$";return o&&(d+=o),n=function(e){return 0===e.type.indexOf(d)},e.store.findAll(n)}function p(e){return e.map(function(e){return w.cancel(e.type.substr(1),e.id)})}function c(e,o){return e.map(function(e){return w.restart(e.type.substr(1),e.id,o)})}function s(e,o,n){var d;return"new"===e&&(e="start"),"remove"===e&&o.cancelledAt&&(e="cancel"),"remove"===e&&o.$processedAt&&(e="success"),"update"===e&&o.$error?(e="error",d=o.$error,delete o.$error,w.trigger("error",d,o,n),w.trigger(o.type+":error",d,o,n),w.trigger(o.type+":"+o.id+":error",d,o,n),n=$.extend({},n,{error:d}),w.trigger("change","error",o,n),w.trigger(o.type+":change","error",o,n),w.trigger(o.type+":"+o.id+":change","error",o,n),void 0):(("start"===e||"cancel"===e||"success"===e)&&(w.trigger(e,o,n),w.trigger(o.type+":"+e,o,n),"start"!==e&&w.trigger(o.type+":"+o.id+":"+e,o,n),w.trigger("change",e,o,n),w.trigger(o.type+":change",e,o,n),"start"!==e&&w.trigger(o.type+":"+o.id+":change",e,o,n)),void 0)}function y(){return JSON.stringify(new Date).replace(/['"]/g,"")}var w=function a(o,n){return f(e,a,{type:o,id:n})};d(e,{context:w,namespace:"task"}),w.start=function(o,d){return e.account.hasAccount()?e.store.add("$"+o,d).then(n):e.account.anonymousSignUp().then(function(){return w.start(o,d)})},w.cancel=function(o,n){return e.store.update("$"+o,n,{cancelledAt:y()}).then(t)},w.restart=function(e,o,n){var d=function(e){return $.extend(e,n),delete e.$error,delete e.$processedAt,delete e.cancelledAt,w.start(e.type,e)};return w.cancel(e,o).then(d)},w.cancelAll=function(e){return l(e).then(p)},w.restartAll=function(e,o){return"object"==typeof e&&(o=e),l(e).then(function(e){c(e,o)})},w.subscribeToOutsideEvents=function(){o(),delete w.subscribeToOutsideEvents},e.task=w}var d=e("./events"),f=e("./scoped_task"),i=e("./error");o.exports=n},{"./error":7,"./events":10,"./scoped_task":18}]},{},[1])(1)});
>>>>>>> [minor] prevent from braking when localStorage is not supported. This is a temporary fix that can be undone once #199 is fixed
=======
!function(a){"object"==typeof exports?module.exports=a():"function"==typeof define&&define.amd?define(a):"undefined"!=typeof window?window.Hoodie=a():"undefined"!=typeof global?global.Hoodie=a():"undefined"!=typeof self&&(self.Hoodie=a())}(function(){var a;return function b(a,c,d){function e(g,h){if(!c[g]){if(!a[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};a[g][0].call(j.exports,function(b){var c=a[g][1][b];return e(c?c:b)},j,j.exports,b,a,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(b,c){function d(a){var b=this;if(!(b instanceof d))throw new Error("usage: new Hoodie(url);");a&&(b.baseUrl=a.replace(/\/+$/,"")),b.extend=function(a){a(b)},b.extend(r),b.extend(j),b.extend(k),b.extend(l),b.extend(p),b.extend(m),b.extend(n),b.extend(o),b.store.patchIfNotPersistant(),b.extend(q),b.extend(i),b.extend(g),b.extend(h),b.account.username=b.config.get("_account.username"),b.account.checkPasswordReset(),b.on("account:signout",b.config.clear),b.store.subscribeToOutsideEvents(),b.store.bootstrapDirtyObjects(),b.remote.subscribeToOutsideEvents(),b.task.subscribeToOutsideEvents(),b.account.authenticate().then(function(){b.remote.connect()}),window.addEventListener("online",b.checkConnection,!1),window.addEventListener("offline",b.checkConnection,!1),b.checkConnection(),e(b)}function e(a){for(var b=0;b<s.length;b++)s[b](a)}var f="undefined"!=typeof self?self:"undefined"!=typeof window?window:{},g=b("./hoodie/account"),h=b("./hoodie/account_remote"),i=b("./hoodie/config"),j=b("./hoodie/promises"),k=b("./hoodie/request"),l=b("./hoodie/connection"),m=b("./hoodie/dispose"),n=b("./hoodie/open"),o=b("./hoodie/local_store"),p=b("./hoodie/generate_id"),q=b("./hoodie/task"),r=b("./hoodie/events"),s=[];d.extend=function(a){s.push(a)},"object"==typeof c&&c&&"object"==typeof c.exports?c.exports=d:"function"==typeof a&&a.amd?a(function(){return d}):f.Hoodie=d},{"./hoodie/account":2,"./hoodie/account_remote":3,"./hoodie/config":4,"./hoodie/connection":5,"./hoodie/dispose":6,"./hoodie/events":10,"./hoodie/generate_id":11,"./hoodie/local_store":12,"./hoodie/open":13,"./hoodie/promises":14,"./hoodie/request":16,"./hoodie/task":20}],2:[function(a,b){function c(a){function b(b){return a.config.set(N,b)}function c(){return a.config.get(N)}function e(){return a.config.unset(N)}function f(){a.on("remote:error:unauthenticated",g)}function g(){return I=void 0,J.authenticate()}function h(b){return J.username!==b?(J.username=b,a.config.set("_account.username",b)):void 0}function i(b){return J.ownerHash!==b?(J.ownerHash=b,a.config.set("createdBy",b),a.config.set("_account.ownerHash",b)):void 0}function j(b){return b.userCtx.name?(I=!0,h(b.userCtx.name.replace(/^user(_anonymous)?\//,"")),i(b.userCtx.roles[0]),a.resolveWith(J.username)):J.hasAnonymousAccount()?J.signIn(J.username,c()):(I=!1,J.trigger("error:unauthenticated"),a.reject())}function k(a,b){return function(c){return J.trigger("signup",a),K._rev=c.rev,m(a,b)}}function l(b){return function(c){return"HoodieConflictError"===c.name&&(c.message="Username "+b+" already exists"),a.rejectWith(c)}}function m(b,c,d,e){return e||(e=a.defer()),window.setTimeout(function(){var a=G(b,c);a.done(e.resolve),a.fail(function(a){"HoodieAccountUnconfirmedError"===a.name?m(b,c,d,e):e.reject.apply(e,arguments)})},300),e.promise()}function n(b){return b=b||{},function(c){var d,e;return d=a.defer(),e=c.name.replace(/^user(_anonymous)?\//,""),-1!==c.roles.indexOf("error")?(J.fetch(e).fail(d.reject).done(function(){return d.reject(K.$error)}),d.promise()):-1===c.roles.indexOf("confirmed")?d.reject({name:"HoodieAccountUnconfirmedError",message:"Account has not been confirmed yet"}):(h(e),i(c.roles[0]),I=!0,b.silent||b.reauthenticated||(J.hasAnonymousAccount()?J.trigger("signin:anonymous",e):J.trigger("signin",e)),b.reauthenticated&&J.trigger("reauthenticated",e),J.fetch(),d.resolve(e,c.roles[0]))}}function o(b){var c;return c=b.$error?b.$error:{name:"HoodiePendingError",message:"Password reset is still pending"},a.rejectWith(c)}function p(b){return"HoodieUnauthorizedError"===b.name?(a.config.unset("_account.resetPasswordId"),J.trigger("passwordreset"),a.resolve()):a.rejectWith(b)}function q(){var b=a.defer();return J.one("passwordreset",b.resolve),J.one("error:passwordreset",b.reject),b.always(function(){J.unbind("passwordreset",b.resolve),J.unbind("error:passwordreset",b.reject)}),b.promise()}function r(a,b,c){return G(J.username,a,{silent:!0}).then(function(){return J.fetch().then(A(a,b,c))})}function s(a,b){var d=c();return r(d,a,b).done(function(){J.trigger("signup",a),e()})}function t(){return a.remote.disconnect(),K._deleted=!0,C("updateUsersDoc",function(){J.request("PUT",z(),{data:JSON.stringify(K),contentType:"application/json"})})}function u(b){return"HoodieNotFoundError"===b.name?a.resolve():a.rejectWith(b)}function v(b){return b=b||{},J.trigger("cleanup"),I=b.authenticated,a.config.clear(),h(b.username),i(b.ownerHash||a.generateId()),a.resolve()}function w(){return v().then(function(){return J.trigger("signout")})}function x(a){var b;return b=a===J.ownerHash?"user_anonymous":"user",""+b+"/"+a}function y(a){return a=a||J.username,""+M+":"+x(a)}function z(a){return"/_users/"+encodeURIComponent(y(a))}function A(a,b,c){return function(){var d=$.extend({},K);b&&(d.$newUsername=b),d.updatedAt=H(),d.signedUpAt=d.signedUpAt||H(),null!==c&&(delete d.salt,delete d.password_sha,d.password=c);var e={data:JSON.stringify(d),contentType:"application/json"};return C("updateUsersDoc",function(){return J.request("PUT",z(),e).then(B(b,c||a))})}}function B(b,c){return function(){return a.remote.disconnect(),b?m(b,c,{silent:!0}):J.signIn(J.username,c)}}function C(a,b){return void 0!==L[a]&&"function"==typeof L[a].abort&&L[a].abort(),L[a]=b(),L[a]}function D(a,b){return void 0!==L[a]&&"function"==typeof L[a].state&&"pending"===L[a].state()?L[a]:(L[a]=b(),L[a])}function E(b){return a.store.hasLocalChanges()&&!b.ignoreLocalChanges?a.remote.push():a.resolve()}function F(){return D("signOut",function(){return J.request("DELETE","/_session")})}function G(a,b,c){var d={data:{name:x(a),password:b}};return C("signIn",function(){var a=J.request("POST","/_session",d);return a.then(n(c))})}function H(){return new Date}var I,J={},K={},L={},M="org.couchdb.user";d(a,{context:J,namespace:"account"}),J.authenticate=function(){var b;return I===!1?a.reject():I===!0?a.resolveWith(J.username):L.signOut&&"pending"===L.signOut.state()?L.signOut.then(a.reject):L.signIn&&"pending"===L.signIn.state()?L.signIn:J.hasAccount()?(b=function(){return J.request("GET","/_session").then(j)},D("authenticate",b)):F().then(function(){return I=!1,a.reject()})},J.hasValidSession=function(){return J.hasAccount()?I===!0:!1},J.hasInvalidSession=function(){return J.hasAccount()?I===!1:!1},J.signUp=function(b,c){if(void 0===c&&(c=""),!b)return a.rejectWith("Username must be set.");if(J.hasAnonymousAccount())return s(b,c);if(J.hasAccount())return a.rejectWith("Must sign out first.");b=b.toLowerCase();var d={data:JSON.stringify({_id:y(b),name:x(b),type:"user",roles:[],password:c,ownerHash:J.ownerHash,database:J.db(),updatedAt:H(),createdAt:H(),signedUpAt:b!==J.ownerHash?H():void 0}),contentType:"application/json"};return J.request("PUT",z(b),d).then(k(b,c),l(b))},J.anonymousSignUp=function(){var c,d;return c=a.generateId(10),d=J.ownerHash,J.signUp(d,c).done(function(){return b(c),J.trigger("signup:anonymous",d)})},J.hasAccount=function(){return!!J.username},J.hasAnonymousAccount=function(){return J.username===J.ownerHash};var N="_account.anonymousPassword";J.signIn=function(b,c,d){var e,f=function(){return J.signOut({silent:!0}).then(function(){return G(b,c)})};return d=d||{},null===b&&(b=""),void 0===c&&(c=""),b=b.toLowerCase(),b!==J.username?d.moveData?a.store.findAll().then(function(a){e=a}).then(f).done(function(){e.forEach(function(b){var c=b.type;("$config"!==c||"hoodie"!==b.id)&&(delete b.type,b.createdBy=a.account.ownerHash,a.store.add(c,b))})}):f():G(b,c,{reauthenticated:!0})},J.signOut=function(b){return b=b||{},J.hasAccount()?E(b).then(a.remote.disconnect).then(F).then(w):v().then(function(){return b.silent?void 0:J.trigger("signout")})},J.request=function(b,c,d){return d=d||{},a.request.apply(a,arguments)},J.db=function(){return"user/"+J.ownerHash},J.fetch=function(b){return void 0===b&&(b=J.username),b?D("fetch",function(){return J.request("GET",z(b)).done(function(a){return K=a})}):a.rejectWith({name:"HoodieUnauthorizedError",message:"Not signed in"})},J.changePassword=function(b,c){return J.username?(a.remote.disconnect(),J.fetch().then(A(b,null,c))):a.rejectWith({name:"HoodieUnauthorizedError",message:"Not signed in"})},J.resetPassword=function(b){var c,d,e,f;return(f=a.config.get("_account.resetPasswordId"))?J.checkPasswordReset():(f=""+b+"/"+a.generateId(),a.config.set("_account.resetPasswordId",f),d=""+M+":$passwordReset/"+f,c={_id:d,name:"$passwordReset/"+f,type:"user",roles:[],password:f,createdAt:H(),updatedAt:H()},e={data:JSON.stringify(c),contentType:"application/json"},C("resetPassword",function(){return J.request("PUT","/_users/"+encodeURIComponent(d),e).done(J.checkPasswordReset).then(q)}))},J.checkPasswordReset=function(){var b,c,d,e,f;return(d=a.config.get("_account.resetPasswordId"))?(f="$passwordReset/"+d,e="/_users/"+encodeURIComponent(M+":"+f),b=btoa(f+":"+d),c={headers:{Authorization:"Basic "+b}},C("passwordResetStatus",function(){return J.request("GET",e,c).then(o,p).fail(function(a){return"HoodiePendingError"===a.name?(window.setTimeout(J.checkPasswordReset,1e3),void 0):J.trigger("passwordreset:error")})})):a.rejectWith("No pending password reset.")},J.changeUsername=function(a,b){return b=b||"",r(a,b.toLowerCase())},J.destroy=function(){return J.hasAccount()?J.fetch().then(t,u).then(w):w()},J.subscribeToOutsideEvents=function(){f(),delete J.subscribeToOutsideEvents},a.account=J,a.account.ownerHash=a.config.get("_account.ownerHash"),a.account.ownerHash||i(a.generateId())}var d=a("./events");b.exports=c},{"./events":10}],3:[function(a,b){function c(a){function b(b){return b?a.config.set("_remote.since",b):a.config.get("_remote.since")||0}function c(){a.on("remote:connect",function(){a.on("store:idle",d.push),d.push()}),a.on("remote:disconnect",function(){a.unbind("store:idle",d.push)}),a.on("disconnected",d.disconnect),a.on("reconnected",d.connect),a.on("account:signin",d.connect),a.on("account:signin:anonymous",d.connect),a.on("account:reauthenticated",d.connect),a.on("account:signout",d.disconnect)}var d=a.open(a.account.db(),{connected:!0,prefix:"",since:b,defaultObjectsToPush:a.store.changedObjects,knownObjects:a.store.index().map(function(a){var b=a.split(/\//);return{type:b[0],id:b[1]}})}),e=d.connect;d.connect=function(){return a.account.hasAccount()?e(a.account.db()):a.rejectWith("User has no database to connect to")},d.trigger=function(){var b;b=arguments[0];var c=2<=arguments.length?Array.prototype.slice.call(arguments,1):[];return a.trigger.apply(a,["remote:"+b].concat(Array.prototype.slice.call(c)))},d.on=function(b,c){return b=b.replace(/(^| )([^ ]+)/g,"$1remote:$2"),a.on(b,c)},d.unbind=function(b,c){return b=b.replace(/(^| )([^ ]+)/g,"$1remote:$2"),a.unbind(b,c)},d.subscribeToOutsideEvents=function(){c(),delete d.subscribeToOutsideEvents},a.remote=d}b.exports=c},{}],4:[function(a,b){function c(a){var b="$config",c="hoodie",d={},e={};e.set=function(e,f){var g,h;if(d[e]!==f)return d[e]=f,h={},h[e]=f,g="_"===e.charAt(0),a.store.updateOrAdd(b,c,h,{silent:g})},e.get=function(a){return d[a]},e.clear=function(){return d={},a.store.remove(b,c)},e.unset=function(a){return e.set(a,void 0)},a.store.find(b,c).done(function(a){d=a}),a.config=e}b.exports=c},{}],5:[function(a,b){function c(a){function b(){return e=3e4,g=window.setTimeout(a.checkConnection,e),a.isConnected()||(a.trigger("reconnected"),d=!0),a.resolve()}function c(){return e=3e3,g=window.setTimeout(a.checkConnection,e),a.isConnected()&&(a.trigger("disconnected"),d=!1),a.reject()}var d=!0,e=3e4,f=null,g=null;a.checkConnection=function(){var d=f;return d&&"pending"===d.state()?d:(window.clearTimeout(g),f=a.request("GET","/").then(b,c))},a.isConnected=function(){return d}}b.exports=c},{}],6:[function(a,b){function c(a){function b(){a.trigger("dispose"),a.unbind()}a.dispose=b}b.exports=c},{}],7:[function(a,b){function c(a){if("string"==typeof a&&(a={message:a}),!a.message)throw new Error("FATAL: error.message must be set");a.name||(a.name="HoodieError"),a.message=a.message.replace(d,function(b){var c=b.match(e)[0];return a[c]}),$.extend(this,a)}var d=/\{\{\s*\w+\s*\}\}/g,e=/\w+/;c.prototype=new Error,c.prototype.constructor=c,b.exports=c},{}],8:[function(a,b){function c(a){return a.name="HoodieObjectIdError",a.message='"{{id}}" is invalid object id. {{rules}}.',new d(a)}var d=a("../error"),e=/^[a-z0-9\-]+$/;c.isInvalid=function(a,b){return!(b||e).test(a||"")},c.isValid=function(a,b){return(b||e).test(a||"")},c.prototype.rules="Lowercase letters, numbers and dashes allowed only. Must start with a letter",b.exports=c},{"../error":7}],9:[function(a,b){function c(a){return a.name="HoodieObjectTypeError",a.message='"{{type}}" is invalid object type. {{rules}}.',new d(a)}var d=a("../error"),e=/^[a-z$][a-z0-9]+$/;c.isInvalid=function(a,b){return!(b||e).test(a||"")},c.isValid=function(a,b){return(b||e).test(a||"")},c.prototype.rules="lowercase letters, numbers and dashes allowed only. Must start with a letter",b.exports=c},{"../error":7}],10:[function(a,b){function c(a,b){function c(b,c){var d,e,f,g;for(d=b.split(" "),f=0,g=d.length;g>f;f++)e=h+d[f],a.eventsCallbacks[e]=a.eventsCallbacks[e]||[],a.eventsCallbacks[e].push(c)}function d(b,c){b=h+b;var d=function(){a.unbind(b,d),c.apply(null,arguments)};a.bind(b,d)}function e(){var b,c,d,e,f,g;if(b=1<=arguments.length?Array.prototype.slice.call(arguments,0):[],d=b.shift(),d=h+d,e=a.eventsCallbacks[d]){for(f=0,g=e.length;g>f;f++)c=e[f],c.apply(null,b);return!0}}function f(b,c){var d,e,f,g,i,j;if(!b)return h||(a.eventsCallbacks={}),j=Object.keys(a.eventsCallbacks),j=j.filter(function(a){return 0===a.indexOf(h)}),j.forEach(function(b){delete a.eventsCallbacks[b]}),void 0;if(b=h+b,f=a.eventsCallbacks[b]){if(!c)return delete a.eventsCallbacks[b],void 0;for(e=g=0,i=f.length;i>g;e=++g)if(d=f[e],d===c){f=f.slice(),f.splice(e,1),a.eventsCallbacks[b]=f;break}}}var g=a,h="";b=b||{},a.eventsCallbacks||(a.eventsCallbacks={}),b.context&&(g=b.context,h=b.namespace+":"),g.bind=c,g.on=c,g.one=d,g.trigger=e,g.unbind=f,g.off=f}b.exports=c},{}],11:[function(a,b){function c(a){function b(a){var b="";for(void 0===a&&(a=7),d=0;a>d;d++){var f=Math.random()*e,g=c[Math.floor(f)];b+=String(g).charAt(0)}return b}var c,d,e;c="0123456789abcdefghijklmnopqrstuvwxyz".split(""),e=c.length,a.generateId=b}b.exports=c},{}],12:[function(a,b){function c(a){function b(a){if(e.isInvalid(a.type))return new e({type:a.type});if(a.id)return f.isInvalid(a.id)?new f({id:a.id}):void 0}function c(a,b,c,d){var e;if(void 0===c&&(c=!1),d=d||{},e=""+a+"/"+b,c){if($.extend(c,{type:a,id:b}),n(a,b,c),d.remote)return j(a,b),B[e]=$.extend(!0,{},c),B[e]}else{if(B[e]===!1)return!1;if(B[e])return $.extend(!0,{},B[e]);if(c=o(a,b),c===!1)return j(a,b),B[e]=!1,!1}return t(c)?(i(a,b,c,d),B[e]=!1,!1):(B[e]=$.extend(!0,{},c),s(c)?i(a,b,B[e],d):j(a,b),$.extend(!0,{},c))}function g(){var a,b,d,e,f,g,h;if(b=H.getItem("_dirty"))for(b=b.split(","),f=0,g=b.length;g>f;f++)h=b[f].split("/"),e=h[0],a=h[1],d=c(e,a)}function h(){a.on("account:cleanup",F.clear),a.on("account:signup",k),a.on("remote:bootstrap:start",w),a.on("remote:bootstrap:end",x),a.on("remote:change",l),a.on("remote:push",m)}function i(a,b,c,d){var e;d=d||{},e=""+a+"/"+b,C[e]=c,p(),d.silent||v()}function j(a,b){var c;return a&&b?(c=""+a+"/"+b,delete C[c]):C={},p(),window.clearTimeout(I)}function k(){return F.findAll().pipe(function(a){var b,c,d,e;for(d=0,e=a.length;e>d;d++)c=a[d],b=""+c.type+"/"+c.id,C[b]=c;p(),v()})}function l(a,b){"remove"===a?F.remove(b.type,b.id,{remote:!0,update:b}):F.save(b.type,b.id,b,{remote:!0})}function m(a){u("sync",a)}function n(a,b,c){var d,e;return d=""+a+"/"+b,e=$.extend({},c),delete e.type,delete e.id,H.setItem(d,JSON.stringify(e))}function o(a,b){var c,d;c=""+a+"/"+b;var e=H.getItem(c);return e?(d=JSON.parse(e),d.type=a,d.id=b,d):!1}function p(){try{if($.isEmptyObject(C))H.removeItem("_dirty");else{var a=Object.keys(C);H.setItem("_dirty",a.join(","))}}catch(b){}}function q(){return JSON.stringify(new Date).replace(/['"]/g,"")}function r(a){return J.test(a)}function s(a){return a.updatedAt?a._syncedAt?a._syncedAt<a.updatedAt:!0:!1}function t(a){return a._deleted===!0}function u(a,b,c){F.trigger(a,$.extend(!0,{},b),c),F.trigger(b.type+":"+a,$.extend(!0,{},b),c),F.trigger(a+":"+b.type,$.extend(!0,{},b),c),"new"!==a&&(F.trigger(b.type+":"+b.id+":"+a,$.extend(!0,{},b),c),F.trigger(a+":"+b.type+":"+b.id,$.extend(!0,{},b),c)),"sync"!==a&&(F.trigger("change",a,$.extend(!0,{},b),c),F.trigger(b.type+":change",a,$.extend(!0,{},b),c),F.trigger("change:"+b.type,a,$.extend(!0,{},b),c),"new"!==a&&(F.trigger(b.type+":"+b.id+":change",a,$.extend(!0,{},b),c),F.trigger("change:"+b.type+":"+b.id,a,$.extend(!0,{},b),c)))}function v(){F.trigger("dirty"),window.clearTimeout(I),I=window.setTimeout(function(){F.trigger("idle",F.changedObjects())},E)}function w(){G=!0,F.trigger("bootstrap:start")}function x(){var a,b,c,d;for(G=!1;D.length>0;)a=D.shift(),b=a[0],c=a[1],d=a[2],A[b].apply(A,c).then(d.resolve,d.reject);F.trigger("bootstrap:end")}function y(b,c){var d=a.defer();return D.push([b,c,d]),d.promise()}function z(){F.isPersistent()||(H={getItem:function(){return null},setItem:function(){return null},removeItem:function(){return null},key:function(){return null},length:function(){return 0}})}var A={},B={},C={},D=[],E=2e3;A.save=function(b,d){var e,f,g,h,i,j;if(d=d||{},F.isBootstrapping()&&!d.remote)return y("save",arguments);if(b.id?(e=c(b.type,b.id),i="object"!=typeof e):(i=!0,b.id=a.generateId()),i?b.createdBy=b.createdBy||a.account.ownerHash:e.createdBy&&(b.createdBy=e.createdBy),!i)for(j in e)if(!b.hasOwnProperty(j))switch(j.charAt(0)){case"_":d.remote&&(b[j]=e[j]);break;case"$":d.remote||(b[j]=e[j])}d.remote?b._syncedAt=q():d.silent||(b.updatedAt=q(),b.createdAt=b.createdAt||b.updatedAt),d.local?b._$local=!0:delete b._$local,f=a.defer();try{b=c(b.type,b.id,b,d),f.resolve(b,i).promise(),h=i?"add":"update",u(h,b,d)}catch(k){g=k,f.reject(g.toString())}return f.promise()},A.find=function(b,d){var e,f;if(F.isBootstrapping())return y("find",arguments);try{return f=c(b,d),f?a.resolveWith(f):a.rejectWith({name:"HoodieNotFoundError",message:'"{{type}}" with id "{{id}}" could not be found'})}catch(g){return e=g,a.rejectWith(e)}},A.findAll=function(b){var d,e,f,g,h,i,j,k,l;if(null==b&&(b=function(){return!0}),F.isBootstrapping())return y("findAll",arguments);i=F.index(),"string"==typeof b&&(l=b,b=function(a){return a.type===l}),e=a.defer();try{k=function(){var a,e,f,k;for(k=[],a=0,e=i.length;e>a;a++)h=i[a],r(h)&&(f=h.split("/"),d=f[0],g=f[1],j=c(d,g),j&&b(j)&&k.push(j));return k}.call(this),k.sort(function(a,b){return a.createdAt>b.createdAt?-1:a.createdAt<b.createdAt?1:0}),e.resolve(k).promise()}catch(m){f=m,e.reject(f).promise()}return e.promise()},A.remove=function(b,d,e){var f,g,h;return e=e||{},F.isBootstrapping()&&!e.remote?y("remove",arguments):(f=b+"/"+d,g=c(b,d),e.remote&&(H.removeItem(f),h=B[f]&&t(B[f]),B[f]=!1,j(b,d),h&&g)?a.resolveWith(g):g?(g._syncedAt?(g._deleted=!0,c(b,d,g)):(f=b+"/"+d,H.removeItem(f),B[f]=!1,j(b,d)),e.update&&(g=e.update,delete e.update),u("remove",g,e),a.resolveWith(g)):a.rejectWith({name:"HoodieNotFoundError",message:'"{{type}}" with id "{{id}}"" could not be found'}))},A.removeAll=function(a,b){return F.findAll(a).then(function(a){var c,d,e,f;for(f=[],d=0,e=a.length;e>d;d++)c=a[d],f.push(F.remove(c.type,c.id,b));return f})};var F=d(a,{validate:b,backend:{save:A.save,find:A.find,findAll:A.findAll,remove:A.remove,removeAll:A.removeAll}});F.index=function(){var a,b,c,d,e;for(c=[],a=d=0,e=H.length();e>=0?e>d:d>e;a=e>=0?++d:--d)b=H.key(a),r(b)&&c.push(b);return c},F.changedObjects=function(){var a,b,c,d,e,f,g;e=C,g=[];for(b in e)e.hasOwnProperty(b)&&(c=e[b],f=b.split("/"),d=f[0],a=f[1],c.type=d,c.id=a,g.push(c));return g},F.hasLocalChanges=function(a,b){if(!a)return!$.isEmptyObject(C);var d=[a,b].join("/");return C[d]?!0:s(c(a,b))},F.clear=function(){var b,c,d,e;b=a.defer();try{d=F.index(),e=function(){var a,b,e;for(e=[],a=0,b=d.length;b>a;a++)c=d[a],r(c)&&e.push(H.removeItem(c));return e}.call(this),B={},j(),b.resolve(),F.trigger("clear")}catch(f){b.reject(f)}return b.promise()};var G=!1;F.isBootstrapping=function(){return G},F.isPersistent=function(){try{if(!window.localStorage)return!1;if(localStorage.setItem("Storage-Test","1"),"1"!==localStorage.getItem("Storage-Test"))return!1;localStorage.removeItem("Storage-Test")}catch(a){return!1}return!0};var H={getItem:function(a){return window.localStorage.getItem(a)},setItem:function(a,b){return window.localStorage.setItem(a,b)},removeItem:function(a){return window.localStorage.removeItem(a)},key:function(a){return window.localStorage.key(a)},length:function(){return window.localStorage.length}};F.subscribeToOutsideEvents=function(){h(),delete F.subscribeToOutsideEvents};var I,J=new RegExp(/^[a-z$][a-z0-9]+\/[a-z0-9]+$/);a.store=F,F.bootstrapDirtyObjects=function(){g(),delete F.bootstrapDirtyObjects},F.patchIfNotPersistant=function(){z(),delete F.patchIfNotPersistant}}var d=a("./store"),e=a("./error/object_type"),f=a("./error/object_id");b.exports=c},{"./error/object_id":8,"./error/object_type":9,"./store":19}],13:[function(a,b){function c(a){function b(b,c){return c=c||{},$.extend(c,{name:b}),d(a,c)}a.open=b}var d=a("./remote_store");b.exports=c},{"./remote_store":15}],14:[function(a,b){function c(a){function b(a){return!(!a||"function"!=typeof a.done||"function"==typeof a.resolve)}function c(){return h().resolve().promise()}function e(){return h().reject().promise()}function f(){var a=h();return a.resolve.apply(a,arguments).promise()}function g(a){var b=h(),c=new d(a);return b.reject(c).promise()}var h=window.jQuery.Deferred;a.defer=h,a.isPromise=b,a.resolve=c,a.reject=e,a.resolveWith=f,a.rejectWith=g}var d=a("./error");b.exports=c},{"./error":7}],15:[function(a,b){function c(a,b){function c(a){return"function"==typeof u?u(a):u=a}function e(a){var b,c;c=$.extend({},a);for(b in c)if(c.hasOwnProperty(b)){if(-1!==A.indexOf(b))continue;if(!/^_/.test(b))continue;delete c[b]}return c._id=""+c.type+"/"+c.id,r.prefix&&(c._id=""+r.prefix+c._id),delete c.id,c}function f(a){var b,c,d;return b=a._id||a.id,delete a._id,r.prefix&&(b=b.replace(t,"")),d=b.match(/([^\/]+)\/(.*)/),c=d[0],a.type=d[1],a.id=d[2],a}function g(a){var b,c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(f(b));return e}function h(a){var b,c,d,e;try{e=a._rev.split(/-/),c=e[0],b=e[1]}catch(f){}return c=parseInt(c,10)||0,d=i(),a._$local&&(d+="-local"),a._rev=""+(c+1)+"-"+d,a._revisions={start:1,ids:[d]},b?(a._revisions.start+=c,a._revisions.ids.push(b)):void 0}function i(){return a.generateId(9)}function j(a){return a.rows.map(function(a){return a.doc})}function k(){var a;return a=r.getSinceNr(),r.isConnected()&&!v?"/_changes?include_docs=true&since="+a+"&heartbeat=10000&feed=longpoll":"/_changes?include_docs=true&since="+a}function l(){w&&w.abort()}function m(a){return c(a.last_seq),p(a.results),r.isConnected()?r.pull():void 0}function n(b,c){if(r.isConnected())switch(b.status){case 401:return r.trigger("error:unauthenticated",c),r.disconnect();case 404:return window.setTimeout(r.pull,3e3);case 500:return r.trigger("error:server",c),window.setTimeout(r.pull,3e3),a.checkConnection();default:return"abort"===b.statusText?r.pull():(window.setTimeout(r.pull,3e3),a.checkConnection())}}function o(){v=!1,r.trigger("bootstrap:end")}function p(a){var b,c,d,e,g;for(e=0,g=a.length;g>e;e++)if(b=a[e].doc,!r.prefix||0===b._id.indexOf(r.prefix)){if(d=f(b),d._deleted){if(!r.isKnownObject(d))continue;c="remove",r.isKnownObject(d)}else r.isKnownObject(d)?c="update":(c="add",r.markAsKnownObject(d));r.trigger(c,d),r.trigger(c+":"+d.type,d),r.trigger(c+":"+d.type+":"+d.id,d),r.trigger("change",c,d),r.trigger("change:"+d.type,c,d),r.trigger("change:"+d.type+":"+d.id,c,d)}}var q={};q.find=function(a,b){var c;return c=a+"/"+b,r.prefix&&(c=r.prefix+c),c="/"+encodeURIComponent(c),r.request("GET",c).then(f)},q.findAll=function(a){var b,c,d;switch(c="/_all_docs?include_docs=true",!0){case void 0!==a&&""!==r.prefix:d=r.prefix+a+"/";break;case void 0!==a:d=a+"/";break;case""!==r.prefix:d=r.prefix;break;default:d=""}return d&&(b=d.replace(/.$/,function(a){var b;return b=a.charCodeAt(0),String.fromCharCode(b+1)}),c=""+c+'&startkey="'+encodeURIComponent(d)+'"&endkey="'+encodeURIComponent(b)+'"'),r.request("GET",c).then(j).then(g)},q.save=function(b){var c;return b.id||(b.id=a.generateId()),b=e(b),c="/"+encodeURIComponent(b._id),r.request("PUT",c,{data:b})},q.remove=function(a,b){return r.update(a,b,{_deleted:!0})},q.removeAll=function(a){return r.updateAll(a,{_deleted:!0})};var r=d(a,{name:b.name,backend:{save:q.save,find:q.find,findAll:q.findAll,remove:q.remove,removeAll:q.removeAll}}),s=null;r.connected=!1,r.prefix="";var t=new RegExp("^");void 0!==b.name&&(s=b.name),void 0!==b.prefix&&(r.prefix=b.prefix,t=new RegExp("^"+r.prefix)),null!==b.baseUrl&&(r.baseUrl=b.baseUrl),r.request=function(b,c,d){return d=d||{},s&&(c="/"+encodeURIComponent(s)+c),r.baseUrl&&(c=""+r.baseUrl+c),d.contentType=d.contentType||"application/json",("POST"===b||"PUT"===b)&&(d.dataType=d.dataType||"json",d.processData=d.processData||!1,d.data=JSON.stringify(d.data)),a.request(b,c,d)},r.isKnownObject=function(a){var b=""+a.type+"/"+a.id;return void 0!==z[b]?z[b]:void 0},r.markAsKnownObject=function(a){var b=""+a.type+"/"+a.id;return z[b]=1,z[b]},r.connect=function(a){return a&&(s=a),r.connected=!0,r.trigger("connect"),r.bootstrap().then(function(){r.push()})},r.disconnect=function(){r.connected=!1,r.trigger("disconnect"),w&&w.abort(),y&&y.abort()},r.isConnected=function(){return r.connected};var u=b.since||0;r.getSinceNr=function(){return"function"==typeof u?u():u};var v=!1;r.bootstrap=function(){return v=!0,r.trigger("bootstrap:start"),r.pull().done(o)};var w,x;r.pull=function(){return w=r.request("GET",k()),r.isConnected()&&(window.clearTimeout(x),x=window.setTimeout(l,25e3)),w.done(m).fail(n)};var y;r.push=function(b){var c,d,f,g;if($.isArray(b)||(b=B()),0===b.length)return a.resolveWith([]);for(d=[],f=0,g=b.length;g>f;f++)c=$.extend(!0,{},b[f]),h(c),c=e(c),d.push(c);return y=r.request("POST","/_bulk_docs",{data:{docs:d,new_edits:!1}}),y.done(function(){for(var a=0;a<b.length;a++)r.trigger("push",b[a])}),y},r.sync=function(a){return r.push(a).then(r.pull)};var z={},A=["_id","_rev","_deleted","_revisions","_attachments"],B=function(){return[]};if(b.defaultObjectsToPush&&(B=$.isArray(b.defaultObjectsToPush)?function(){return b.defaultObjectsToPush}:b.defaultObjectsToPush),b.knownObjects)for(var C=0;C<b.knownObjects.length;C++)r.markAsKnownObject({type:b.knownObjects[C].type,id:b.knownObjects[C].id});return r}var d=a("./store");b.exports=c},{"./store":19}],16:[function(a,b){function c(a){function b(b,d,e){var i,j,k;return e=e||{},i={type:b,dataType:"json"},/^http/.test(d)||(d=(a.baseUrl||"")+h+d),/^http/.test(d)&&(i.xhrFields={withCredentials:!0},i.crossDomain=!0),i.url=d,j=g(f(i,e)),k=j.then(null,c),k.abort=j.abort,k}function c(b){var c;try{c=d(b)}catch(e){c=b.responseText?b.responseText:{name:"HoodieConnectionError",message:"Could not connect to Hoodie server at {{url}}.",url:a.baseUrl||"/"}}return a.rejectWith(c).promise()}function d(a){var b=JSON.parse(a.responseText);return b.name=i[a.status],b.name||(b.name=e(b.error)),b.status=a.status,b.message=b.reason||"",b.message=b.message.charAt(0).toUpperCase()+b.message.slice(1),delete b.error,delete b.reason,b}function e(a){return a=a.replace(/(^\w|_\w)/g,function(a){return(a[1]||a[0]).toUpperCase()}),"Hoodie"+a+"Error"}var f=$.extend,g=$.ajax,h="/_api",i={400:"HoodieRequestError",401:"HoodieUnauthorizedError",403:"HoodieRequestError",404:"HoodieNotFoundError",409:"HoodieConflictError",412:"HoodieConflictError",500:"HoodieServerError"};a.request=b}b.exports=c},{}],17:[function(a,b){function c(a,b,c){var e=c.name||"store",f=c.type,g=c.id,h={};return g||(d(a,{context:h,namespace:e+":"+f}),h.save=function(a,c,d){return b.save(f,a,c,d)},h.add=function(a,c){return b.add(f,a,c)},h.find=function(a){return b.find(f,a)},h.findOrAdd=function(a,c){return b.findOrAdd(f,a,c)},h.findAll=function(a){return b.findAll(f,a)},h.update=function(a,c,d){return b.update(f,a,c,d)},h.updateAll=function(a,c){return b.updateAll(f,a,c)},h.remove=function(a,c){return b.remove(f,a,c)},h.removeAll=function(a){return b.removeAll(f,a)}),g&&(d(a,{context:h,namespace:e+":"+f+":"+g}),h.save=function(a,c){return b.save(f,g,a,c)},h.find=function(){return b.find(f,g)},h.update=function(a,c){return b.update(f,g,a,c)},h.remove=function(a){return b.remove(f,g,a)}),h.decoratePromises=b.decoratePromises,h.validate=b.validate,h}var d=a("./events");b.exports=c},{"./events":10}],18:[function(a,b){function c(a,b,c){var e=c.type,f=c.id,g={};return f||(d(a,{context:g,namespace:"task:"+e}),g.start=function(a){return b.start(e,a)},g.cancel=function(a){return b.cancel(e,a)},g.restart=function(a,c){return b.restart(e,a,c)},g.cancelAll=function(){return b.cancelAll(e)},g.restartAll=function(a){return b.restartAll(e,a)}),f&&(d(a,{context:g,namespace:"task:"+e+":"+f}),g.cancel=function(){return b.cancel(e,f)},g.restart=function(a){return b.restart(e,f,a)}),g}var d=a("./events");b.exports=c},{"./events":10}],19:[function(a,b){function c(a,b){function c(a){return $.extend(a,j)}var i={},j={hoodie:a},k=b.name||"store",l=function p(c,e){var f=$.extend(!0,{type:c,id:e},b);return d(a,p,f)};if(e(a,{context:l,namespace:k}),l.validate=b.validate,b.validate||(l.validate=function(a){if(!a)return new f({name:"InvalidObjectError",message:"No object passed."});if(g.isInvalid(a.type,n))return new g({type:a.type,rules:o});if(a.id)return h.isInvalid(a.id,n)?new h({id:a.id,rules:o}):void 0}),l.save=function(b,d,e,f){f=f?$.extend(!0,{},f):{};var g=$.extend(!0,{},e,{type:b,id:d}),h=l.validate(g,f||{});return h?a.rejectWith(h):c(i.save(g,f||{}))},l.add=function(a,b,c){return void 0===b&&(b={}),c=c||{},l.save(a,b.id,b,c)},l.find=function(a,b){return c(i.find(a,b))},l.findOrAdd=function(a,b,d){function e(){var c;return c=$.extend(!0,{id:b},d),l.add(a,c)}null===d&&(d={});var f=l.find(a,b).then(null,e);return c(f)},l.findAll=function(a,b){return c(i.findAll(a,b))},l.update=function(b,d,e,f){function g(c){var g,h,i;return h=$.extend(!0,{},c),"function"==typeof e&&(e=e(h)),e?(g=function(){var a=[];for(var b in e)if(e.hasOwnProperty(b)){if(i=e[b],c[b]!==i==!1)continue;h[b]=i,a.push(b)}return a}(),g.length||f?l.save(b,d,h,f):a.resolveWith(h)):a.resolveWith(c)}var h=l.find(b,d).then(g);return c(h)},l.updateOrAdd=function(a,b,d,e){function f(){var c=$.extend(!0,{},d,{id:b});return l.add(a,c,e)}var g=l.update(a,b,d,e).then(null,f);return c(g)},l.updateAll=function(b,d,e){var f;switch(e=e||{},!0){case"string"==typeof b:f=l.findAll(b);break;case a.isPromise(b):f=b;break;case $.isArray(b):f=a.defer().resolve(b).promise();break;default:f=l.findAll()}return f=f.then(function(a){var b,c;return $.isArray(a)||(a=[a]),c=function(){var c,f,g;for(g=[],c=0,f=a.length;f>c;c++)b=a[c],g.push(l.update(b.type,b.id,d,e));return g}(),$.when.apply(null,c)}),c(f)},l.remove=function(a,b,d){return c(i.remove(a,b,d||{}))},l.removeAll=function(a,b){return c(i.removeAll(a,b||{}))},l.decoratePromises=function(a){return $.extend(j,a)},!b.backend)throw new Error("options.backend must be passed");var m="save find findAll remove removeAll".split(" ");m.forEach(function(a){if(!b.backend[a])throw new Error("options.backend."+a+" must be passed.");
i[a]=b.backend[a]});var n=/^[^\/]+$/,o="/ not allowed";return l}var d=a("./scoped_store"),e=a("./events"),f=a("./error"),g=a("./error/object_type"),h=a("./error/object_id");b.exports=c},{"./error":7,"./error/object_id":8,"./error/object_type":9,"./events":10,"./scoped_store":17}],20:[function(a,b){function c(a){function b(){a.on("store:change",h)}function c(b){var c=a.defer(),d=a.store(b.type,b.id);return d.on("remove",function(a){return a.type=a.type.substr(1),a.$processedAt?c.resolve(a):(c.reject(new f({message:"Task has been cancelled",task:a})),void 0)}),d.on("update",function(b){var d=b.$error;b.$error&&(b.type=b.type.substr(1),delete b.$error,d.object=b,d.message=d.message||"Something went wrong",c.reject(new f(d)),a.store.remove("$"+b.type,b.id))}),c.promise()}function g(b){var c,d=b.type,e=b.id,f=a.store.remove(d,e);return b._rev?(c=a.defer(),a.one("store:sync:"+d+":"+e,c.resolve),f.fail(c.reject),c.promise()):f}function h(a,b,c){"$"===b.type[0]&&(b.type=b.type.substr(1),l(a,b,c))}function i(b){var c,d="$";return b&&(d+=b),c=function(a){return 0===a.type.indexOf(d)},a.store.findAll(c)}function j(a){return a.map(function(a){return n.cancel(a.type.substr(1),a.id)})}function k(a,b){return a.map(function(a){return n.restart(a.type.substr(1),a.id,b)})}function l(a,b,c){var d;return"new"===a&&(a="start"),"remove"===a&&b.cancelledAt&&(a="cancel"),"remove"===a&&b.$processedAt&&(a="success"),"update"===a&&b.$error?(a="error",d=b.$error,delete b.$error,n.trigger("error",d,b,c),n.trigger(b.type+":error",d,b,c),n.trigger(b.type+":"+b.id+":error",d,b,c),c=$.extend({},c,{error:d}),n.trigger("change","error",b,c),n.trigger(b.type+":change","error",b,c),n.trigger(b.type+":"+b.id+":change","error",b,c),void 0):(("start"===a||"cancel"===a||"success"===a)&&(n.trigger(a,b,c),n.trigger(b.type+":"+a,b,c),"start"!==a&&n.trigger(b.type+":"+b.id+":"+a,b,c),n.trigger("change",a,b,c),n.trigger(b.type+":change",a,b,c),"start"!==a&&n.trigger(b.type+":"+b.id+":change",a,b,c)),void 0)}function m(){return JSON.stringify(new Date).replace(/['"]/g,"")}var n=function o(b,c){return e(a,o,{type:b,id:c})};d(a,{context:n,namespace:"task"}),n.start=function(b,d){return a.account.hasAccount()?a.store.add("$"+b,d).then(c):a.account.anonymousSignUp().then(function(){return n.start(b,d)})},n.cancel=function(b,c){return a.store.update("$"+b,c,{cancelledAt:m()}).then(g)},n.restart=function(a,b,c){var d=function(a){return $.extend(a,c),delete a.$error,delete a.$processedAt,delete a.cancelledAt,n.start(a.type,a)};return n.cancel(a,b).then(d)},n.cancelAll=function(a){return i(a).then(j)},n.restartAll=function(a,b){return"object"==typeof a&&(b=a),i(a).then(function(a){k(a,b)})},n.subscribeToOutsideEvents=function(){b(),delete n.subscribeToOutsideEvents},a.task=n}var d=a("./events"),e=a("./scoped_task"),f=a("./error");b.exports=c},{"./error":7,"./events":10,"./scoped_task":18}]},{},[1])(1)});
>>>>>>> [fix] hoodie.account.usernameChange #207
