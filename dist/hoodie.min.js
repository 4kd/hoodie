//  hoodie 0.3.0
function hoodieEvents(a){function b(a,b){var c,d,e,g;for(c=a.split(" "),e=0,g=c.length;g>e;e++)d=c[e],f[d]=f[d]||[],f[d].push(b)}function c(a,c){b(a,function(){e(a,c),c.apply(null,arguments)})}function d(){var a,b,c,d,e,g;if(a=1<=arguments.length?Array.prototype.slice.call(arguments,0):[],c=a.shift(),d=f[c]){for(e=0,g=d.length;g>e;e++)b=d[e],b.apply(null,a);return!0}}function e(a,b){var c,d,e,g,h;if(!a)return f={},void 0;if(e=f[a]){if(!b)return delete f[a],void 0;for(d=g=0,h=e.length;h>g;d=++g)if(c=e[d],c===b){e=e.slice(),e.splice(d,1),f[a]=e;break}}}var f={};a.bind=b,a.on=b,a.one=c,a.trigger=d,a.unbind=e,a.off=e}function hoodiePromises(a){function b(a){return!(!a||"function"!=typeof a.done||"function"==typeof a.resolve)}function c(){return g().resolve().promise()}function d(){return g().reject().promise()}function e(){var a=g();return a.resolve.apply(a,arguments).promise()}function f(){var a=g();return a.reject.apply(a,arguments).promise()}var g=window.jQuery.Deferred;a.defer=g,a.isPromise=b,a.resolve=c,a.reject=d,a.resolveWith=e,a.rejectWith=f}function hoodieRequest(a){function b(b,f,g){var h,i,j;return g=g||{},/^http/.test(f)||(f=""+a.baseUrl+f),h={type:b,url:f,xhrFields:{withCredentials:!0},crossDomain:!0,dataType:"json"},i=e(d(h,g)),j=i.then(null,c),j.abort=i.abort,j}function c(b){var c;try{c=JSON.parse(b.responseText)}catch(d){c={error:b.responseText||"Cannot connect to Hoodie server at "+a.baseUrl}}return a.rejectWith(c).promise()}var d=$.extend,e=$.ajax;a.request=b}function hoodieConnection(a){"use strict";function b(){var b=h;return b&&"pending"===b.state()?b:h=a.request("GET","/").pipe(d,e)}function c(){return f}function d(){return g=3e4,window.setTimeout(b,g),a.isOnline()||(a.trigger("reconnected"),f=!0),a.resolve()}function e(){return g=3e3,window.setTimeout(b,g),a.isOnline()&&(a.trigger("disconnected"),f=!1),a.reject()}var f=!0,g=3e4,h=null;a.isOnline=c,a.checkConnection=b}function hoodieUUID(a){function b(a){var b,c,d;return void 0===a&&(a=7),b="0123456789abcdefghijklmnopqrstuvwxyz".split(""),d=b.length,function(){var e,f=[];for(c=e=0;a>=0?a>e:e>a;c=a>=0?++e:--e){var g=Math.random()*d;f.push(b[0]=String(g).charAt(0))}return f}().join("")}a.uuid=b}function hoodieDispose(a){function b(){a.trigger("dispose"),a.unbind()}a.dispose=b}function hoodieOpen(a){function b(b,d){return d=d||{},c(d,{name:b}),hoodieRemoteBase(a,d)}var c=window.jQuery.extend;a.open=b}function hoodieStoreBase(a){function b(a){return new RegExp(/^[^\/]+$/).test(a)}function c(a){return new RegExp(/^[^\/]+$/).test(a)}var d={save:function(d,e,f,g){var h;return null===g&&(g={}),h=a.defer(),"object"!=typeof f||Array.isArray(f)?(h.reject(Hoodie.Errors.INVALID_ARGUMENTS("invalid object")),h.promise()):e&&!b(e)?h.reject(Hoodie.Errors.INVALID_KEY({id:e})).promise():c(d)?h:h.reject(Hoodie.Errors.INVALID_KEY({type:d})).promise()},add:function(a,b,c){return void 0===b&&(b={}),c=c||{},d.save(a,b.id,b)},update:function(b,c,e,f){var g,h;return g=a.defer(),h=d.find(b,c).pipe(function(a){var h,i,j;return i=$.extend(!0,{},a),"function"==typeof e&&(e=e(i)),e?(h=function(){var b=[];for(var c in e)if(e.hasOwnProperty(c)){if(j=e[c],a[c]!==j==!1)continue;i[c]=j,b.push(c)}return b}(),h.length||f?(d.save(b,c,i,f).then(g.resolve,g.reject),void 0):g.resolve(i)):g.resolve(a)}),h.fail(function(){return d.save(b,c,e,f).then(g.resolve,g.reject)}),g.promise()},updateAll:function(b,c,e){var f;switch(e=e||{},!0){case"string"==typeof b:f=d.findAll(b);break;case a.isPromise(b):f=b;break;case $.isArray(b):f=a.defer().resolve(b).promise();break;default:f=d.findAll()}return f.pipe(function(b){var f,g,h;return f=a.defer(),$.isArray(b)||(b=[b]),h=function(){var a,f,h;for(h=[],a=0,f=b.length;f>a;a++)g=b[a],h.push(d.update(g.type,g.id,c,e));return h}(),$.when.apply(null,h).then(f.resolve),f.promise()})},find:function(b,c){var d;return d=a.defer(),"string"!=typeof b||"string"!=typeof c?d.reject(Hoodie.Errors.INVALID_ARGUMENTS("type & id are required")).promise():d},findOrAdd:function(b,c,e){var f;return null===e&&(e={}),f=a.defer(),d.find(b,c).done(f.resolve).fail(function(){var a;return a=$.extend(!0,{id:c},e),d.add(b,a).then(f.resolve,f.reject)}),f.promise()},findAll:function(){return a.defer()},remove:function(b,c,d){var e;return null===d&&(d={}),e=a.defer(),"string"!=typeof b||"string"!=typeof c?e.reject(Hoodie.Errors.INVALID_ARGUMENTS("type & id are required")).promise():e},removeAll:function(a,b){return b=b||{},d.findAll(a).pipe(function(a){var c,e,f,g;for(g=[],e=0,f=a.length;f>e;e++)c=a[e],g.push(d.remove(c.type,c.id,b));return g})}};return d}function hoodieRemoteBase(a,b){function c(a){var b,c;c=$.extend({},a);for(b in c)if(c.hasOwnProperty(b)){if(-1!==v.indexOf(b))continue;if(!/^_/.test(b))continue;delete c[b]}return c._id=""+c.type+"/"+c.id,p.prefix&&(c._id=""+p.prefix+c._id),delete c.id,c}function d(a){var b,c,d;return b=a._id||a.id,delete a._id,p.prefix&&(b=b.replace(new RegExp("^"+p.prefix),"")),d=b.match(/([^\/]+)\/(.*)/),c=d[0],a.type=d[1],a.id=d[2],a}function e(a){var b,c,e,f;for(f=[],c=0,e=a.length;e>c;c++)b=a[c],f.push(d(b));return f}function f(a){var b,c,d,e;try{e=a._rev.split(/-/),c=e[0],b=e[1]}catch(f){}return c=parseInt(c,10)||0,d=g(),a._$local&&(d+="-local"),a._rev=""+(c+1)+"-"+d,a._revisions={start:1,ids:[d]},b?(a._revisions.start+=c,a._revisions.ids.push(b)):void 0}function g(){return a.uuid(9)}function h(a){return a.rows.map(function(a){return a.doc})}function i(){var a;return a=p.getSinceNr(),p.isConnected()?"/_changes?include_docs=true&since="+a+"&heartbeat=10000&feed=longpoll":"/_changes?include_docs=true&since="+a}function j(){r&&r.abort()}function k(a){return p.setSinceNr(a.last_seq),n(a.results),p.isConnected()?p.pull():void 0}function l(b,c){if(p.isConnected())switch(b.status){case 401:return p.trigger("error:unauthenticated",c),p.disconnect();case 404:return window.setTimeout(p.pull,3e3);case 500:return p.trigger("error:server",c),window.setTimeout(p.pull,3e3),a.checkConnection();default:return"abort"===b.statusText?p.pull():(window.setTimeout(p.pull,3e3),a.checkConnection())}}function m(){p.trigger("bootstrap:end")}function n(a){var b,c,e,f,g;for(f=0,g=a.length;g>f;f++)if(b=a[f].doc,!p.prefix||0===b._id.indexOf(p.prefix)){if(e=d(b),e._deleted){if(!p.isKnownObject(e))continue;c="remove",p.isKnownObject(e)}else p.isKnownObject(e)?c="update":(c="add",p.markAsKnownObject(e));p.trigger(""+c,e),p.trigger(""+c+":"+e.type,e),p.trigger(""+c+":"+e.type+":"+e.id,e),p.trigger("change",c,e),p.trigger("change:"+e.type,c,e),p.trigger("change:"+e.type+":"+e.id,c,e)}}var o=hoodieStoreBase(a),p=Object.create(o);p.name=null,p.connected=!1,p.prefix="",p.request=function(b,c,d){return d=d||{},p.name&&(c="/"+encodeURIComponent(p.name)+c),p.baseUrl&&(c=""+p.baseUrl+c),d.contentType=d.contentType||"application/json",("POST"===b||"PUT"===b)&&(d.dataType=d.dataType||"json",d.processData=d.processData||!1,d.data=JSON.stringify(d.data)),a.request(b,c,d)},p.get=function(){return console.log.apply(console,[".get() not yet implemented"].concat(Array.prototype.slice.call(arguments)))},p.post=function(){return console.log.apply(console,[".post() not yet implemented"].concat(Array.prototype.slice.call(arguments)))},p.find=function(b,c){var e,f;return e=o.find.apply(p,arguments),a.isPromise(e)?e:(f=""+b+"/"+c,p.prefix&&(f=p.prefix+f),f="/"+encodeURIComponent(f),p.request("GET",f).pipe(d))},p.findAll=function(b){var c,d,f,g;if(c=o.findAll.apply(p,arguments),a.isPromise(c))return c;switch(f="/_all_docs?include_docs=true",!0){case void 0!==b&&""!==p.prefix:g=""+p.prefix+b+"/";break;case void 0!==b:g=""+b+"/";break;case""!==p.prefix:g=p.prefix;break;default:g=""}return g&&(d=g.replace(/.$/,function(a){var b;return b=a.charCodeAt(0),String.fromCharCode(b+1)}),f=""+f+"&startkey='"+encodeURIComponent(g)+"'&endkey='"+encodeURIComponent(d)+"'"),p.request("GET",f).pipe(h).pipe(e)},p.save=function(b,d,e){var f,g;return f=o.save.apply(p,arguments),a.isPromise(f)?f:(d||(d=a.uuid()),e=$.extend({type:b,id:d},e),e=c(e),g="/"+encodeURIComponent(e._id),p.request("PUT",g,{data:e}))},p.remove=function(a,b){return p.update(a,b,{_deleted:!0})},p.removeAll=function(a){return p.updateAll(a,{_deleted:!0})},p.isKnownObject=function(a){var b=""+a.type+"/"+a.id;return void 0!==u[b]?u[b]:void 0},p.markAsKnownObject=function(a){var b=""+a.type+"/"+a.id;return u[b]=1,u[b]},p.connect=function(){return p.connected=!0,p.bootstrap()},p.disconnect=function(){p.connected=!1,r&&r.abort(),t&&t.abort()},p.isConnected=function(){return p.connected},p.getSinceNr=function(){return q||0};var q;p.setSinceNr=function(a){return q=a},p.bootstrap=function(){return p.trigger("bootstrap:start"),p.pull().done(m.bind(this))};var r,s;p.pull=function(){return r=p.request("GET",i()),p.isConnected()&&(window.clearTimeout(s),s=window.setTimeout(j,25e3)),r.then(k,l)};var t;p.push=function(b){var d,e,g,h;if(!(void 0!==b?b.length:void 0))return a.resolveWith([]);for(e=[],g=0,h=b.length;h>g;g++)d=b[g],f(d),d=c(d),e.push(d);return t=p.request("POST","/_bulk_docs",{data:{docs:e,new_edits:!1}})},p.sync=function(a){return p.push(a).pipe(p.pull)},p.on=function(b,c){return b=b.replace(/(^| )([^ ]+)/g,"$1"+p.name+":$2"),a.on(b,c)},p.one=function(b,c){return b=b.replace(/(^| )([^ ]+)/g,"$1"+p.name+":$2"),a.one(b,c)},p.trigger=function(){var b,c,d;return b=arguments[0],c=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],(d=a).trigger.apply(d,[""+p.name+":"+b].concat(Array.prototype.slice.call(c)))};var u={},v=["_id","_rev","_deleted","_revisions","_attachments"];return void 0!==b.name&&(p.name=b.name),void 0!==b.prefix&&(p.prefix=b.prefix),void 0!==b.connected&&(p.connected=b.connected),null!==b.baseUrl&&(p.baseUrl=b.baseUrl),p.isConnected()&&p.connect(),p}function hoodieStore(a){function b(){var a,b,c,d,e,f,g;if(b=C.getItem("_dirty"))for(b=b.split(","),e=0,f=b.length;f>e;e++)g=b[e].split("/"),d=g[0],a=g[1],c=u.cache(d,a)}function c(){a.on("account:cleanup",u.clear),a.on("account:signup",u.markAllAsChanged),a.on("remote:bootstrap:start",q),a.on("remote:bootstrap:end",r),a.on("remote:change",d)}function d(a,b){"remove"===a?u.remove(b.type,b.id,{remote:!0}):u.save(b.type,b.id,b,{remote:!0})}function e(a,b,c){var d,e;return d=""+a+"/"+b,e=$.extend({},c),delete e.type,delete e.id,C.setItem(d,JSON.stringify(e))}function f(a,b){var c,d;c=""+a+"/"+b;var e=C.getItem(c);return e?(d=JSON.parse(e),d.type=a,d.id=b,d):!1}function g(){if($.isEmptyObject(w))return C.removeItem("_dirty");var a=Object.keys(w);return C.setItem("_dirty",a.join(","))}function h(){return JSON.stringify(new Date).replace(/'/g,"")}function i(a){return new RegExp(/^[a-z0-9\-]+$/).test(a)}function j(a){return new RegExp(/^[a-z$][a-z0-9]+$/).test(a)}function k(a){return new RegExp(/^[a-z$][a-z0-9]+\/[a-z0-9]+$/).test(a)}function l(a){return a.updatedAt?a._syncedAt?a._syncedAt<a.updatedAt:!0:!1}function m(a){return a._deleted===!0}function n(a,b,c){u.trigger(a,b,c),u.trigger(""+a+":"+b.type,b,c),"new"!==a&&u.trigger(""+a+":"+b.type+":"+b.id,b,c),u.trigger("change",a,b,c),u.trigger("change:"+b.type,a,b,c),"new"!==a&&u.trigger("change:"+b.type+":"+b.id,a,b,c)}function o(){u.trigger("dirty"),window.clearTimeout(B),B=window.setTimeout(function(){u.trigger("idle",u.changedObjects())},z)}function p(a){return $.extend(a,y)}function q(){A=!0,u.trigger("bootstrap:start")}function r(){var a,b,c,d;for(A=!1;x.length>0;)a=x.shift(),b=a[0],c=a[1],d=a[2],this[b].apply(u,c).then(d.resolve,d.reject);u.trigger("bootstrap:end")}function s(b,c){var d=a.defer();return x.push([b,c,d]),d.promise()}var t=hoodieStoreBase(a),u=Object.create(t),v={},w={},x=[],y={hoodie:a},z=2e3;u.save=function(b,c,d,e){var f,g,k,l,m,o,q;if(e=e||{},g=t.save.apply(u,arguments),a.isPromise(g))return p(g);if(c&&!i(c))return a.rejectWith(Hoodie.Errors.INVALID_KEY({id:c}));if(!j(b))return a.rejectWith(Hoodie.Errors.INVALID_KEY({type:b}));if(u.isBootstrapping())return s("save",arguments);if(q=$.extend(!0,{},d),c?(f=u.cache(b,c),m="object"!=typeof f):(m=!0,c=a.uuid()),m&&a.account&&(q.createdBy=q.createdBy||a.account.ownerHash),!m)for(o in f)if(!q.hasOwnProperty(o))switch(o.charAt(0)){case"_":e.remote&&(q[o]=f[o]);break;case"$":e.remote||(q[o]=f[o])}e.remote?q._syncedAt=h():e.silent||(q.updatedAt=h(),q.createdAt=q.createdAt||q.updatedAt),e.local?q._$local=!0:delete q._$local;try{q=u.cache(b,c,q,e),g.resolve(q,m).promise(),l=m?"add":"update",n(l,q,e)}catch(r){k=r,g.reject(k).promise()}return p(g.promise())},u.find=function(b,c){var d,e,f;if(d=t.find.apply(u,arguments),a.isPromise(d))return p(d);if(u.isBootstrapping())return s("find",arguments);try{f=u.cache(b,c),f||d.reject(Hoodie.Errors.NOT_FOUND(b,c)).promise(),d.resolve(f)}catch(g){e=g,d.reject(e)}return p(d.promise())},u.findAll=function(b){var c,d,e,f,g,h,i,j,l;if(null==b&&(b=function(){return!0}),d=t.findAll.apply(u,arguments),a.isPromise(d))return p(d);if(u.isBootstrapping())return s("findAll",arguments);h=u.index(),"string"==typeof b&&(l=b,b=function(a){return a.type===l});try{j=function(){var a,d,e,j;for(j=[],a=0,d=h.length;d>a;a++)g=h[a],k(g)&&(e=g.split("/"),c=e[0],f=e[1],i=u.cache(c,f),i&&b(i)&&j.push(i));return j}.call(this),j.sort(function(a,b){return a.createdAt>b.createdAt?-1:a.createdAt<b.createdAt?1:0}),d.resolve(j).promise()}catch(m){e=m,d.reject(e).promise()}return p(d.promise())},u.remove=function(b,c,d){var e,f,g,h,i;return d=d||{},e=t.remove.apply(u,arguments),a.isPromise(e)?p(e):u.isBootstrapping()?s("remove",arguments):(f=""+b+"/"+c,d.remote&&(C.removeItem(f),h=v[f]&&m(v[f]),v[f]=!1,u.clearChanged(b,c),h)?void 0:(g=u.cache(b,c))?(g._syncedAt?(g._deleted=!0,u.cache(b,c,g)):(f=""+b+"/"+c,C.removeItem(f),v[f]=!1,u.clearChanged(b,c)),n("remove",g,d),i=e.resolve(g).promise(),p(i)):p(e.reject(Hoodie.Errors.NOT_FOUND(b,c)).promise()))},u.update=function(){return p(t.update.apply(u,arguments))},u.updateAll=function(){return p(t.updateAll.apply(u,arguments))},u.removeAll=function(){return p(t.removeAll.apply(u,arguments))},u.index=function(){var a,b,c,d,e;for(c=[],a=d=0,e=C.length();e>=0?e>d:d>e;a=e>=0?++d:--d)b=C.key(a),k(b)&&c.push(b);return c},u.cache=function(a,b,c,d){var g;if(void 0===c&&(c=!1),d=d||{},g=""+a+"/"+b,c){if($.extend(c,{type:a,id:b}),e(a,b,c),d.remote)return u.clearChanged(a,b),v[g]=$.extend(!0,{},c),v[g]}else{if(v[g]===!1)return!1;if(v[g])return $.extend(!0,{},v[g]);if(c=f(a,b),c===!1)return u.clearChanged(a,b),v[g]=!1,!1}return m(c)?(u.markAsChanged(a,b,c,d),v[g]=!1,!1):(v[g]=$.extend(!0,{},c),l(c)?u.markAsChanged(a,b,v[g],d):u.clearChanged(a,b),$.extend(!0,{},c))},u.clearChanged=function(a,b){var c;return a&&b?(c=""+a+"/"+b,delete w[c]):w={},g(),window.clearTimeout(B)},u.isMarkedAsDeleted=function(a,b){return m(u.cache(a,b))},u.markAsChanged=function(a,b,c,d){var e;return d=d||{},e=""+a+"/"+b,w[e]=c,g(),d.silent?void 0:o()},u.markAllAsChanged=function(){return u.findAll().pipe(function(a){var b,c,d,e;for(d=0,e=a.length;e>d;d++)c=a[d],b=""+c.type+"/"+c.id,w[b]=c;g(),o()})},u.changedObjects=function(){var a,b,c,d,e,f,g;e=w,g=[];for(b in e)e.hasOwnProperty(b)&&(c=e[b],f=b.split("/"),d=f[0],a=f[1],c.type=d,c.id=a,g.push(c));return g},u.hasLocalChanges=function(a,b){return a?l(u.cache(a,b)):!$.isEmptyObject(w)},u.clear=function(){var b,c,d,e;b=a.defer();try{d=u.index(),e=function(){var a,b,e;for(e=[],a=0,b=d.length;b>a;a++)c=d[a],k(c)&&e.push(C.removeItem(c));return e}.call(this),v={},u.clearChanged(),b.resolve(),u.trigger("clear")}catch(f){b.reject(f)}return b.promise()},u.trigger=function(){var b,c,d;return b=arguments[0],c=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],(d=a).trigger.apply(d,["store:"+b].concat(Array.prototype.slice.call(c)))},u.on=function(b,c){return b=b.replace(/(^| )([^ ]+)/g,"$1store:$2"),a.on(b,c)},u.unbind=function(b,c){return b="store:"+b,a.unbind(b,c)},u.decoratePromises=function(a){return $.extend(y,a)};var A=!1;u.isBootstrapping=function(){return A},u.isPersistent=function(){try{if(!window.localStorage)return!1;if(localStorage.setItem("Storage-Test","1"),"1"!==localStorage.getItem("Storage-Test"))return!1;localStorage.removeItem("Storage-Test")}catch(a){return!1}return!0};var B,C={getItem:function(a){return window.localStorage.getItem(a)},setItem:function(a,b){return window.localStorage.setItem(a,b)},removeItem:function(a){return window.localStorage.removeItem(a)},key:function(a){return window.localStorage.key(a)},length:function(){return window.localStorage.length},clear:function(){return window.localStorage.clear()}};u.isPersistent()||(C={getItem:function(){return null},setItem:function(){return null},removeItem:function(){return null},key:function(){return null},length:function(){return 0},clear:function(){return null}}),c(),b(),a.store=u}function hoodieConfig(a){function b(b,c){var d,e;if(h[b]!==c)return h[b]=c,e={},e[b]=c,d="_"===b.charAt(0),a.store.update(f,g,e,{silent:d})}function c(a){return h[a]}function d(){return h={},a.store.remove(f,g)}function e(a){return b(a,void 0)}var f="$config",g="hoodie",h={};a.store.find(f,g).done(function(a){h=a}),a.on("account:signedOut",d),a.config={set:b,get:c,clear:d,remove:e}}function hoodieAccount(a){function b(b){return a.config.set(J,b)}function c(){return a.config.get(J)}function d(){return a.config.remove(J)}function e(b){return F.username!==b?(F.username=b,a.config.set("_account.username",b)):void 0}function f(b){return F.ownerHash!==b?(F.ownerHash=b,a.config.set("createdBy",b),a.config.set("_account.ownerHash",b)):void 0}function g(b){return b.userCtx.name?(E=!0,e(b.userCtx.name.replace(/^user(_anonymous)?\//,"")),f(b.userCtx.roles[0]),a.resolveWith(F.username)):F.hasAnonymousAccount()?(F.signIn(F.username,c()),void 0):(E=!1,F.trigger("error:unauthenticated"),a.reject())}function h(b){var c;if(b=b||{},b.reason)return a.rejectWith(b);var d=b;try{b=JSON.parse(d.responseText)}catch(e){c=e,b={error:d.responseText||"unknown"}}return a.rejectWith(b)}function i(a,b){return function(c){return F.trigger("signup",a),G._rev=c.rev,j(a,b)}}function j(b,c,d,e){return e||(e=a.defer()),window.setTimeout(function(){var a=C(b,c);a.done(e.resolve),a.fail(function(a){"unconfirmed"===a.error?j(b,c,d,e):e.reject.apply(e,arguments)})},300),e.promise()}function k(b){return b=b||{},function(c){var d,g;return d=a.defer(),g=c.name.replace(/^user(_anonymous)?\//,""),-1!==c.roles.indexOf("error")?(F.fetch(g).fail(d.reject).done(function(){return d.reject({error:"error",reason:G.$error})}),d.promise()):-1===c.roles.indexOf("confirmed")?d.reject({error:"unconfirmed",reason:"account has not been confirmed yet"}):(e(g),f(c.roles[0]),E=!0,b.silent||b.reauthenticated||(F.hasAnonymousAccount()?F.trigger("signin:anonymous",g):F.trigger("signin",g)),b.reauthenticated&&F.trigger("reauthenticated",g),F.fetch(),d.resolve(g,c.roles[0]))}}function l(){var b,c,d,e,f;return(d=a.config.get("_account.resetPasswordId"))?(f="$passwordReset/"+d,e="/_users/"+encodeURIComponent(""+I+":"+f),b=btoa(""+f+":"+d),c={headers:{Authorization:"Basic "+b}},z("passwordResetStatus",function(){return F.request("GET",e,c).pipe(m,n).fail(function(a){return"pending"===a.error?(window.setTimeout(l,1e3),void 0):F.trigger("password_reset:error")})})):a.rejectWith({error:"missing"})}function m(b){var c;return c=b.$error?b.$error:{error:"pending"},a.rejectWith(c)}function n(b){return 401===b.status?(a.config.remove("_account.resetPasswordId"),F.trigger("passwordreset"),a.resolve()):h(b)}function o(a,b,c){return C(F.username,a,{silent:!0}).pipe(function(){return F.fetch().pipe(x(a,b,c))})}function p(a,b){var e;return e=c(),o(e,a,b).done(function(){F.trigger("signup",a),d()})}function q(){return a.remote.disconnect(),G._deleted=!0,z("updateUsersDoc",function(){F.request("PUT",w(),{data:JSON.stringify(G),contentType:"application/json"})})}function r(b){return"not_found"===b.error?a.resolve():a.rejectWith(b)}function s(b){return b=b||{},F.trigger("cleanup"),E=b.authenticated,a.config.clear(),e(b.username),f(b.ownerHash||a.uuid()),a.resolve()}function t(){return s().then(function(){return F.trigger("signout")})}function u(a){var b;return b=a===F.ownerHash?"user_anonymous":"user",""+b+"/"+a}function v(a){return a=a||F.username,""+I+":"+u(a)}function w(a){return"/_users/"+encodeURIComponent(v(a))}function x(a,b,c){return function(){var d=$.extend({},G);b&&(d.$newUsername=b),d.updatedAt=D(),d.signedUpAt=d.signedUpAt||D(),null!==c&&(delete d.salt,delete d.password_sha,d.password=c);var e={data:JSON.stringify(d),contentType:"application/json"};return z("updateUsersDoc",function(){return F.request("PUT",w(),e).pipe(y(b,c||a),h)})}}function y(b,c){return function(){return a.remote.disconnect(),b?j(b,c,{silent:!0}):F.signIn(F.username,c)}}function z(a,b){return void 0!==H[a]&&"function"==typeof H[a].abort&&H[a].abort(),H[a]=b(),H[a]}function A(a,b){return void 0!==H[a]&&"function"==typeof H[a].state&&"pending"===H[a].state()?H[a]:(H[a]=b(),H[a])}function B(){return A("signOut",function(){return F.request("DELETE","/_session").pipe(null,h)})}function C(a,b,c){var d={data:{name:u(a),password:b}};return z("signIn",function(){var a=F.request("POST","/_session",d);return a.pipe(k(c),h)})}function D(){return new Date}var E,F={},G={},H={},I="org.couchdb.user";F.username=a.config.get("_account.username"),F.ownerHash=a.config.get("_account.ownerHash"),F.authenticate=function(){var b;return E===!1?a.reject():E===!0?a.resolveWith(F.username):H.signOut&&"pending"===H.signOut.state()?H.signOut.then(a.rejectWith):H.signIn&&"pending"===H.signIn.state()?H.signIn:void 0===F.username?B().then(function(){return E=!1,a.reject()}):(b=function(){return F.request("GET","/_session").pipe(g,h)},A("authenticate",b))},F.signUp=function(b,c){if(void 0===c&&(c=""),!b)return a.rejectWith({error:"username must be set"});if(F.hasAnonymousAccount())return p(b,c);if(F.hasAccount())return a.rejectWith({error:"you have to sign out first"});b=b.toLowerCase();var d={data:JSON.stringify({_id:v(b),name:u(b),type:"user",roles:[],password:c,ownerHash:F.ownerHash,database:F.db(),updatedAt:D(),createdAt:D(),signedUpAt:b!==F.ownerHash?D():void 0}),contentType:"application/json"};return F.request("PUT",w(b),d).pipe(i(b,c),h)},F.anonymousSignUp=function(){var c,d;return c=a.uuid(10),d=F.ownerHash,F.signUp(d,c).done(function(){return b(c),F.trigger("signup:anonymous",d)})},F.hasAccount=function(){return!!F.username},F.hasAnonymousAccount=function(){return void 0!==c()};var J="_account.anonymousPassword";F.signIn=function(a,b){return null===a&&(a=""),void 0===b&&(b=""),a=a.toLowerCase(),a!==F.username?F.signOut({silent:!0}).pipe(function(){return C(a,b)}):C(a,b,{reauthenticated:!0})},F.signOut=function(b){return b=b||{},F.hasAccount()?(a.remote.disconnect(),B().pipe(t)):s().then(function(){return b.silent?void 0:F.trigger("signout")})},F.on=function(b,c){return b=b.replace(/(^| )([^ ]+)/g,"$1account:$2"),a.on(b,c)},F.trigger=function(){var b,c;b=arguments[0],c=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],a.trigger.apply(a,["account:"+b].concat(Array.prototype.slice.call(c)))},F.request=function(b,c,d){return d=d||{},a.request.apply(a,arguments)},F.db=function(){return"user/"+F.ownerHash},F.fetch=function(b){return void 0===b&&(b=F.username),b?A("fetch",function(){return F.request("GET",w(b)).pipe(null,h).done(function(a){return G=a})}):a.rejectWith({error:"unauthenticated",reason:"not logged in"})},F.changePassword=function(b,c){return F.username?(a.remote.disconnect(),F.fetch().pipe(x(b,null,c),h)):a.rejectWith({error:"unauthenticated",reason:"not logged in"})},F.resetPassword=function(b){var c,d,e,f;return(f=a.config.get("_account.resetPasswordId"))?l():(f=""+b+"/"+a.uuid(),a.config.set("_account.resetPasswordId",f),d=""+I+":$passwordReset/"+f,c={_id:d,name:"$passwordReset/"+f,type:"user",roles:[],password:f,createdAt:D(),updatedAt:D()},e={data:JSON.stringify(c),contentType:"application/json"},z("resetPassword",function(){return F.request("PUT","/_users/"+encodeURIComponent(d),e).pipe(null,h).done(l)}))},F.changeUsername=function(a,b){return b=b||"",o(a,b.toLowerCase())},F.destroy=function(){return F.hasAccount()?F.fetch().pipe(q,r).pipe(t):t()},a.account=F,F.ownerHash||f(a.uuid()),window.setTimeout(F.authenticate),l()}function hoodieRemote(a){function b(){var b,c,d,e,g,h,i;for(h=a.store.index(),e=0,g=h.length;g>e;e++)c=h[e],i=c.split(/\//),d=i[0],b=i[1],f.markAsKnownObject({type:d,id:b})}function c(){return f.connected=!0,a.on("store:idle",f.push),f.sync()}function d(){return f.name=a.account.db(),c()}var e=hoodieRemoteBase(a,{name:a.account.db(),connected:!0,prefix:""}),f=Object.create(e);f.connect=function g(){return a.account.authenticate().pipe(g)},f.disconnect=function(){return a.unbind("store:idle",f.push),e.disconnect.apply(f,arguments)},f.getSinceNr=function(){return a.config.get("_remote.since")||0},f.setSinceNr=function(b){return a.config.set("_remote.since",b)},f.push=function(b){if(!f.isConnected()){var c=new window.ConnectionError("Not connected: could not push local changes to remote");return a.rejectWith(c)}$.isArray(b)||(b=a.store.changedObjects());var d=e.push.apply(f,[b]);return d.fail(a.checkConnection),d},f.on=function(b,c){return b=b.replace(/(^| )([^ ]+)/g,"$1remote:$2"),a.on(b,c)},f.one=function(b,c){return b=b.replace(/(^| )([^ ]+)/g,"$1remote:$2"),a.one(b,c)},f.trigger=function(){var b,c,d;return b=arguments[0],c=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],(d=a).trigger.apply(d,["remote:"+b].concat(Array.prototype.slice.call(c)))},b(),a.on("account:signin",d),a.on("account:reauthenticated",c),a.on("account:signout",f.disconnect),a.on("reconnected",f.connect),a.remote=f}!function(a){"use strict";function b(a){var d=this;if(!(d instanceof b))throw new Error("usage: new Hoodie(url);");d.baseUrl!==a||a.replace(/\/+$/,""),d.extend=function(a){a(d)},d.extend(hoodieEvents),d.extend(hoodiePromises),d.extend(hoodieRequest),d.extend(hoodieConnection),d.extend(hoodieUUID),d.extend(hoodieDispose),d.extend(hoodieOpen),d.extend(hoodieStore),d.extend(hoodieConfig),d.extend(hoodieAccount),d.extend(hoodieRemote),c(d)}function c(a){for(var b=0;b<d.length;b++)d[b](a)}var d=[];b.extend=function(a){d.push(a)},"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=b:"function"==typeof define&&define.amd?define("hoodie",[],function(){return b}):a.Hoodie=b}(window),Hoodie.Errors={INVALID_KEY:function(a){var b=a.id?"id":"type";return new Error("invalid "+b+"'"+a[b]+"': numbers and lowercase letters allowed only")},INVALID_ARGUMENTS:function(a){return new Error(a)},NOT_FOUND:function(a,b){return new Error(""+a+" with "+b+" could not be found")}};