// Hoodie.js - 0.5.3
// https://github.com/hoodiehq/hoodie.js
// Copyright 2012 - 2014 https://github.com/hoodiehq/
// Licensed Apache License 2.0

!function(e){"object"==typeof exports?module.exports=e():"function"==typeof define&&define.amd?define(e):"undefined"!=typeof window?window.Hoodie=e():"undefined"!=typeof global?global.Hoodie=e():"undefined"!=typeof self&&(self.Hoodie=e())}(function(){return function e(o,n,d){function f(t,u){if(!n[t]){if(!o[t]){var l="function"==typeof require&&require;if(!u&&l)return l(t,!0);if(i)return i(t,!0);throw new Error("Cannot find module '"+t+"'")}var p=n[t]={exports:{}};o[t][0].call(p.exports,function(e){var n=o[t][1][e];return f(n?n:e)},p,p.exports,e,o,n,d)}return n[t].exports}for(var i="function"==typeof require&&require,t=0;t<d.length;t++)f(d[t]);return f}({1:[function(e,o){function n(e){if(!e||"[object Object]"!==f.call(e)||e.nodeType||e.setInterval)return!1;var o=d.call(e,"constructor"),n=d.call(e.constructor.prototype,"isPrototypeOf");if(e.constructor&&!o&&!n)return!1;var i;for(i in e);return void 0===i||d.call(e,i)}var d=Object.prototype.hasOwnProperty,f=Object.prototype.toString;o.exports=function i(){var e,o,d,f,t,u,l=arguments[0]||{},p=1,c=arguments.length,s=!1;for("boolean"==typeof l&&(s=l,l=arguments[1]||{},p=2),"object"!=typeof l&&"function"!=typeof l&&(l={});c>p;p++)if(null!=(e=arguments[p]))for(o in e)d=l[o],f=e[o],l!==f&&(s&&f&&(n(f)||(t=Array.isArray(f)))?(t?(t=!1,u=d&&Array.isArray(d)?d:[]):u=d&&n(d)?d:{},l[o]=i(s,u,f)):void 0!==f&&(l[o]=f));return l}},{}],2:[function(e,o){function n(e){function o(o){return e.config.set(R,o)}function n(){return e.config.get(R)}function t(){return e.config.unset(R)}function u(){e.on("remote:error:unauthenticated",l)}function l(){return M=void 0,N.authenticate()}function p(o){return N.username!==o?(N.username=o,e.config.set("_account.username",o)):void 0}function c(o){return N.ownerHash!==o?(N.ownerHash=o,e.config.set("createdBy",o),e.config.set("_account.ownerHash",o)):void 0}function s(o){return o.userCtx.name?(M=!0,p(o.userCtx.name.replace(/^user(_anonymous)?\//,"")),c(o.userCtx.roles[0]),e.resolveWith(N.username)):N.hasAnonymousAccount()?N.signIn(N.username,n()):(M=!1,N.trigger("error:unauthenticated"),e.reject())}function y(e,o){return function(n){return N.trigger("signup",e),O._rev=n.rev,a(e,o)}}function w(o){return function(n){return"HoodieConflictError"===n.name&&(n.message="Username "+o+" already exists"),e.rejectWith(n)}}function a(o,n,f,i){return i||(i=e.defer()),d.setTimeout(function(){var e=K(o,n);e.done(i.resolve),e.fail(function(e){"HoodieAccountUnconfirmedError"===e.name?a(o,n,f,i):i.reject.apply(i,arguments)})},300),i.promise()}function b(o){return o=o||{},function(n){var d,f;return d=e.defer(),f=n.name.replace(/^user(_anonymous)?\//,""),-1!==n.roles.indexOf("error")?(N.fetch(f).fail(d.reject).done(function(){return d.reject(O.$error)}),d.promise()):-1===n.roles.indexOf("confirmed")?d.reject({name:"HoodieAccountUnconfirmedError",message:"Account has not been confirmed yet"}):(p(f),c(n.roles[0]),M=!0,o.silent||o.reauthenticated||(N.hasAnonymousAccount()?N.trigger("signin:anonymous",f):N.trigger("signin",f)),o.reauthenticated&&N.trigger("reauthenticated",f),N.fetch(),d.resolve(f,n.roles[0]))}}function r(o){var n;return o.$error?(n=o.$error,n.object=o,delete n.object.$error):n={name:"HoodiePendingError",message:"Password reset is still pending"},e.rejectWith(n)}function H(o){return"HoodieUnauthorizedError"===o.name?(e.config.unset("_account.resetPasswordId"),N.trigger("passwordreset"),e.resolve()):e.rejectWith(o)}function g(){var o=e.defer();return N.one("passwordreset",o.resolve),N.on("error:passwordreset",m),N.on("error:passwordreset",o.reject),o.always(function(){N.unbind("passwordreset",o.resolve),N.unbind("error:passwordreset",m),N.unbind("error:passwordreset",o.reject)}),o.promise()}function m(o){var n=o.object,d=n.name,f=d.substr(15),i="/_users/"+encodeURIComponent(Q+":"+d),t=btoa(d+":"+f);n._deleted=!0;var u={headers:{Authorization:"Basic "+t},contentType:"application/json",data:JSON.stringify(n)};N.request("PUT",i,u),e.config.unset("_account.resetPasswordId")}function x(e,o,n){return K(N.username,e,{silent:!0}).then(function(){return N.fetch().then(C(e,o,n))})}function j(e,o){var d=n();return x(d,e,o).done(function(){N.trigger("signup",e),t()})}function h(){return e.remote.disconnect(),O._deleted=!0,F("updateUsersDoc",function(){N.request("PUT",B(),{data:JSON.stringify(O),contentType:"application/json"})})}function k(o){return"HoodieNotFoundError"===o.name?e.resolve():e.rejectWith(o)}function q(o){return o=o||{},N.trigger("cleanup"),M=o.authenticated,e.config.clear(),p(o.username),c(o.ownerHash||e.generateId()),e.resolve()}function v(){return q().then(function(){return N.trigger("signout")})}function z(e){var o;return o=e===N.ownerHash?"user_anonymous":"user",""+o+"/"+e}function A(e){return e=e||N.username,""+Q+":"+z(e)}function B(e){return"/_users/"+encodeURIComponent(A(e))}function C(e,o,n){return function(){var d=i({},O);o&&(d.$newUsername=o),d.updatedAt=L(),d.signedUpAt=d.signedUpAt||L(),void 0!==n&&(delete d.salt,delete d.password_sha,d.password=n);var f={data:JSON.stringify(d),contentType:"application/json"};return F("updateUsersDoc",function(){return N.request("PUT",B(),f).then(D(o,n||e))})}}function D(o,n){return function(){return e.remote.disconnect(),o?E(N.username,n).then(function(){return N.signIn(o,n)}):N.signIn(N.username,n)}}function E(o,n,f){f||(f=e.defer());var i={data:{name:z(o),password:n}};return F("signIn",function(){return N.request("POST","/_session",i)}).done(function(){d.setTimeout(E,300,o,n,f)}).fail(function(e){return 401===e.status?f.resolve():(f.reject(e),void 0)}),f.promise()}function F(e,o){return void 0!==P[e]&&"function"==typeof P[e].abort&&P[e].abort(),P[e]=o(),P[e]}function G(e,o){return void 0!==P[e]&&"function"==typeof P[e].state&&"pending"===P[e].state()?P[e]:(P[e]=o(),P[e])}function I(o){return e.store.hasLocalChanges()&&!o.ignoreLocalChanges?e.remote.push():e.resolve()}function J(){return G("signOut",function(){return N.request("DELETE","/_session")})}function K(e,o,n){var d={data:{name:z(e),password:o}};return F("signIn",function(){var e=N.request("POST","/_session",d);return e.then(b(n))})}function L(){return new Date}var M,N={},O={},P={},Q="org.couchdb.user";f(e,{context:N,namespace:"account"}),N.authenticate=function(){var o;return M===!1?e.reject():M===!0?e.resolveWith(N.username):P.signOut&&"pending"===P.signOut.state()?P.signOut.then(e.reject):P.signIn&&"pending"===P.signIn.state()?P.signIn:N.hasAccount()?(o=function(){return N.request("GET","/_session").then(s)},G("authenticate",o)):J().then(function(){return M=!1,e.reject()})},N.hasValidSession=function(){return N.hasAccount()?M===!0:!1},N.hasInvalidSession=function(){return N.hasAccount()?M===!1:!1},N.signUp=function(o,n){if(void 0===n&&(n=""),!o)return e.rejectWith("Username must be set.");if(N.hasAnonymousAccount())return j(o,n);if(N.hasAccount())return e.rejectWith("Must sign out first.");o=o.toLowerCase();var d={data:JSON.stringify({_id:A(o),name:z(o),type:"user",roles:[],password:n,ownerHash:N.ownerHash,database:N.db(),updatedAt:L(),createdAt:L(),signedUpAt:o!==N.ownerHash?L():void 0}),contentType:"application/json"};return N.request("PUT",B(o),d).then(y(o,n),w(o))},N.anonymousSignUp=function(){var n,d;return n=e.generateId(10),d=N.ownerHash,N.signUp(d,n).done(function(){return o(n),N.trigger("signup:anonymous",d)})},N.hasAccount=function(){return!!N.username},N.hasAnonymousAccount=function(){return N.username===N.ownerHash};var R="_account.anonymousPassword";N.signIn=function(o,n,d){var f,i=function(){return N.signOut({silent:!0}).then(function(){return K(o,n)})};return d=d||{},null===o&&(o=""),void 0===n&&(n=""),o=o.toLowerCase(),o!==N.username?d.moveData?e.store.findAll().then(function(e){f=e}).then(i).done(function(){f.forEach(function(o){var n=o.type;("$config"!==n||"hoodie"!==o.id)&&(delete o.type,o.createdBy=e.account.ownerHash,e.store.add(n,o))})}):i():K(o,n,{reauthenticated:!0})},N.signOut=function(o){return o=o||{},N.hasAccount()?I(o).then(e.remote.disconnect).then(J).then(v):q().then(function(){return o.silent?void 0:N.trigger("signout")})},N.request=function(o,n,d){return d=d||{},e.request.apply(e,arguments)},N.db=function(){return"user/"+N.ownerHash},N.fetch=function(o){return void 0===o&&(o=N.username),o?G("fetch",function(){return N.request("GET",B(o)).done(function(e){return O=e})}):e.rejectWith({name:"HoodieUnauthorizedError",message:"Not signed in"})},N.changePassword=function(o,n){return N.username?(e.remote.disconnect(),N.fetch().then(C(o,null,n))):e.rejectWith({name:"HoodieUnauthorizedError",message:"Not signed in"})},N.resetPassword=function(o){var n,d,f,i;return(i=e.config.get("_account.resetPasswordId"))?N.checkPasswordReset():(i=""+o+"/"+e.generateId(),e.config.set("_account.resetPasswordId",i),d=""+Q+":$passwordReset/"+i,n={_id:d,name:"$passwordReset/"+i,type:"user",roles:[],password:i,createdAt:L(),updatedAt:L()},f={data:JSON.stringify(n),contentType:"application/json"},F("resetPassword",function(){return N.request("PUT","/_users/"+encodeURIComponent(d),f).done(N.checkPasswordReset).then(g)}))},N.checkPasswordReset=function(){var o,n,f,i,t;return(f=e.config.get("_account.resetPasswordId"))?(t="$passwordReset/"+f,i="/_users/"+encodeURIComponent(Q+":"+t),o=btoa(t+":"+f),n={headers:{Authorization:"Basic "+o}},F("passwordResetStatus",function(){return N.request("GET",i,n).then(r,H).fail(function(e){return"HoodiePendingError"===e.name?(d.setTimeout(N.checkPasswordReset,1e3),void 0):N.trigger("error:passwordreset",e)})})):e.rejectWith("No pending password reset.")},N.changeUsername=function(e,o){return o=o||"",x(e,o.toLowerCase())},N.destroy=function(){return N.hasAccount()?N.fetch().then(h,k).then(v):v()},N.subscribeToOutsideEvents=function(){u(),delete N.subscribeToOutsideEvents},e.account=N,e.account.ownerHash=e.config.get("_account.ownerHash"),e.account.ownerHash||c(e.generateId())}var d="undefined"!=typeof self?self:"undefined"!=typeof window?window:{},f=e("../events"),i=e("extend");o.exports=n},{"../events":9,extend:1}],3:[function(e,o){function n(e){function o(o){return o?e.config.set("_remote.since",o):e.config.get("_remote.since")||0}function n(){e.on("remote:connect",function(){e.on("store:idle",d.push),d.push()}),e.on("remote:disconnect",function(){e.unbind("store:idle",d.push)}),e.on("disconnected",d.disconnect),e.on("reconnected",d.connect),e.on("account:signin",d.connect),e.on("account:signin:anonymous",d.connect),e.on("account:reauthenticated",d.connect),e.on("account:signout",d.disconnect)}var d=e.open(e.account.db(),{connected:!0,prefix:"",since:o,defaultObjectsToPush:e.store.changedObjects,knownObjects:e.store.index().map(function(e){var o=e.split(/\//);return{type:o[0],id:o[1]}})}),f=d.connect;d.connect=function(){return e.account.hasAccount()?f(e.account.db()):e.rejectWith("User has no database to connect to")},d.trigger=function(){var o;o=arguments[0];var n=2<=arguments.length?Array.prototype.slice.call(arguments,1):[];return e.trigger.apply(e,["remote:"+o].concat(Array.prototype.slice.call(n)))},d.on=function(o,n){return o=o.replace(/(^| )([^ ]+)/g,"$1remote:$2"),e.on(o,n)},d.unbind=function(o,n){return o=o.replace(/(^| )([^ ]+)/g,"$1remote:$2"),e.unbind(o,n)},d.subscribeToOutsideEvents=function(){n(),delete d.subscribeToOutsideEvents},e.remote=d}o.exports=n},{}],4:[function(e,o){function n(e){var o="$config",n="hoodie",d={},f={};f.set=function(f,i){var t,u;if(d[f]!==i)return d[f]=i,u={},u[f]=i,t="_"===f.charAt(0),e.store.updateOrAdd(o,n,u,{silent:t})},f.get=function(e){return d[e]},f.clear=function(){return d={},e.store.remove(o,n)},f.unset=function(e){return f.set(e,void 0)},e.store.find(o,n).done(function(e){d=e}),e.config=f}o.exports=n},{}],5:[function(e,o){function n(e){function o(){return i=3e4,u=d.setTimeout(e.checkConnection,i),e.isConnected()||(e.trigger("reconnected"),f=!0),e.resolve()}function n(){return i=3e3,u=d.setTimeout(e.checkConnection,i),e.isConnected()&&(e.trigger("disconnected"),f=!1),e.reject()}var f=!0,i=3e4,t=null,u=null;e.checkConnection=function(){var f=t;return f&&"pending"===f.state()?f:(d.clearTimeout(u),t=e.request("GET","/").then(o,n))},e.isConnected=function(){return f}}var d="undefined"!=typeof self?self:"undefined"!=typeof window?window:{};o.exports=n},{}],6:[function(e,o){function n(e){if("string"==typeof e&&(e={message:e}),!e.message)throw new Error("FATAL: error.message must be set");e.name||(e.name="HoodieError"),e.message=e.message.replace(d,function(o){var n=o.match(f)[0];return e[n]}),i(this,e)}var d=/\{\{\s*\w+\s*\}\}/g,f=/\w+/,i=e("extend");n.prototype=new Error,n.prototype.constructor=n,o.exports=n},{extend:1}],7:[function(e,o){function n(e){return e.name="HoodieObjectIdError",e.message='"{{id}}" is invalid object id. {{rules}}.',new d(e)}var d=e("./error"),f=/^[a-z0-9\-]+$/;n.isInvalid=function(e,o){return!(o||f).test(e||"")},n.isValid=function(e,o){return(o||f).test(e||"")},n.prototype.rules="Lowercase letters, numbers and dashes allowed only. Must start with a letter",o.exports=n},{"./error":6}],8:[function(e,o){function n(e){return e.name="HoodieObjectTypeError",e.message='"{{type}}" is invalid object type. {{rules}}.',new d(e)}var d=e("./error"),f=/^[a-z$][a-z0-9]+$/;n.isInvalid=function(e,o){return!(o||f).test(e||"")},n.isValid=function(e,o){return(o||f).test(e||"")},n.prototype.rules="lowercase letters, numbers and dashes allowed only. Must start with a letter",o.exports=n},{"./error":6}],9:[function(e,o){function n(e,o){function n(o,n){var d,f,i,t;for(d=o.split(" "),i=0,t=d.length;t>i;i++)f=u+d[i],e.eventsCallbacks[f]=e.eventsCallbacks[f]||[],e.eventsCallbacks[f].push(n)}function d(o,n){o=u+o;var d=function(){e.unbind(o,d),n.apply(null,arguments)};e.bind(o,d)}function f(){var o,n,d,f,i,t;if(o=1<=arguments.length?Array.prototype.slice.call(arguments,0):[],d=o.shift(),d=u+d,f=e.eventsCallbacks[d]){for(i=0,t=f.length;t>i;i++)n=f[i],n.apply(null,o);return!0}}function i(o,n){var d,f,i,t,l,p;if(!o)return u||(e.eventsCallbacks={}),p=Object.keys(e.eventsCallbacks),p=p.filter(function(e){return 0===e.indexOf(u)}),p.forEach(function(o){delete e.eventsCallbacks[o]}),void 0;if(o=u+o,i=e.eventsCallbacks[o]){if(!n)return delete e.eventsCallbacks[o],void 0;for(f=t=0,l=i.length;l>t;f=++t)if(d=i[f],d===n){i=i.slice(),i.splice(f,1),e.eventsCallbacks[o]=i;break}}}var t=e,u="";o=o||{},e.eventsCallbacks||(e.eventsCallbacks={}),o.context&&(t=o.context,u=o.namespace+":"),t.bind=n,t.on=n,t.one=d,t.trigger=f,t.unbind=i,t.off=i}o.exports=n},{}],10:[function(e,o){function n(e){function o(o,d,i){var l,p,c;return i=i||{},l={type:o,dataType:"json"},/^http/.test(d)||(d=(e.baseUrl||"")+u+d),/^http/.test(d)&&(l.xhrFields={withCredentials:!0},l.crossDomain=!0),l.url=d,p=t(f(l,i)),c=p.then(null,n),c.abort=p.abort,c}function n(o){var n;try{n=i(o)}catch(d){n=o.responseText?o.responseText:{name:"HoodieConnectionError",message:"Could not connect to Hoodie server at {{url}}.",url:e.baseUrl||"/"}}return e.rejectWith(n).promise()}function i(e){var o=JSON.parse(e.responseText);return o.name=l[e.status],o.name||(o.name=d.hoodiefyRequestErrorName(o.error)),o.status=e.status,o.message=o.reason||"",o.message=o.message.charAt(0).toUpperCase()+o.message.slice(1),delete o.error,delete o.reason,o}var t=$.ajax,u="/_api",l={400:"HoodieRequestError",401:"HoodieUnauthorizedError",403:"HoodieRequestError",404:"HoodieNotFoundError",409:"HoodieConflictError",412:"HoodieConflictError",500:"HoodieServerError"};e.request=o}var d=e("../utils/index"),f=e("extend");o.exports=n},{"../utils/index":20,extend:1}],11:[function(e,o){function n(e){function o(e){if(i.isInvalid(e.type))return new i({type:e.type});if(e.id)return t.isInvalid(e.id)?new t({id:e.id}):void 0}function n(e,o,n,d){var f;if(void 0===n&&(n=!1),d=d||{},f=""+e+"/"+o,n){if(u(n,{type:e,id:o}),b(e,o,n),d.remote)return s(e,o),C[f]=u(!0,{},n),C[f]}else{if(C[f]===!1)return!1;if(C[f])return u(!0,{},C[f]);if(n=r(e,o),n===!1)return s(e,o),C[f]=!1,!1}return j(n)?(c(e,o,n,d),C[f]=!1,!1):(C[f]=u(!0,{},n),x(n)?c(e,o,C[f],d):s(e,o),u(!0,{},n))}function l(){var e,o,d,f,i,t,u;if(o=J.getItem("_dirty"))for(o=o.split(","),i=0,t=o.length;t>i;i++)u=o[i].split("/"),f=u[0],e=u[1],d=n(f,e)}function p(){e.on("account:cleanup",G.clear),e.on("account:signup",y),e.on("remote:bootstrap:start",q),e.on("remote:bootstrap:end",v),e.on("remote:change",w),e.on("remote:push",a)}function c(e,o,n,d){var f;d=d||{},f=""+e+"/"+o,D[f]=n,H(),d.silent||k()}function s(e,o){var n;return e&&o?(n=""+e+"/"+o,delete D[n]):D={},H(),d.clearTimeout(K)}function y(){return G.findAll().pipe(function(e){var o,n,d,f;for(d=0,f=e.length;f>d;d++)n=e[d],o=""+n.type+"/"+n.id,D[o]=n;H(),k()})}function w(e,o){"remove"===e?G.remove(o.type,o.id,{remote:!0,update:o}):G.save(o.type,o.id,o,{remote:!0})}function a(e){h("sync",e)}function b(e,o,n){var d,f;return d=""+e+"/"+o,f=u({},n),delete f.type,delete f.id,J.setItem(d,JSON.stringify(f))}function r(e,o){var n,d;n=""+e+"/"+o;var f=J.getItem(n);return f?(d=JSON.parse(f),d.type=e,d.id=o,d):!1}function H(){try{if($.isEmptyObject(D))J.removeItem("_dirty");else{var e=Object.keys(D);J.setItem("_dirty",e.join(","))}}catch(o){}}function g(){return JSON.stringify(new Date).replace(/['"]/g,"")}function m(e){return L.test(e)}function x(e){return e.updatedAt?e._syncedAt?e._syncedAt<e.updatedAt:!0:!1}function j(e){return e._deleted===!0}function h(e,o,n){G.trigger(e,u(!0,{},o),n),G.trigger(o.type+":"+e,u(!0,{},o),n),G.trigger(e+":"+o.type,u(!0,{},o),n),"new"!==e&&(G.trigger(o.type+":"+o.id+":"+e,u(!0,{},o),n),G.trigger(e+":"+o.type+":"+o.id,u(!0,{},o),n)),"sync"!==e&&(G.trigger("change",e,u(!0,{},o),n),G.trigger(o.type+":change",e,u(!0,{},o),n),G.trigger("change:"+o.type,e,u(!0,{},o),n),"new"!==e&&(G.trigger(o.type+":"+o.id+":change",e,u(!0,{},o),n),G.trigger("change:"+o.type+":"+o.id,e,u(!0,{},o),n)))}function k(){G.trigger("dirty"),d.clearTimeout(K),K=d.setTimeout(function(){G.trigger("idle",G.changedObjects())},F)}function q(){I=!0,G.trigger("bootstrap:start")}function v(){var e,o,n,d;for(I=!1;E.length>0;)e=E.shift(),o=e[0],n=e[1],d=e[2],B[o].apply(B,n).then(d.resolve,d.reject);G.trigger("bootstrap:end")}function z(o,n){var d=e.defer();return E.push([o,n,d]),d.promise()}function A(){G.isPersistent()||(J={getItem:function(){return null},setItem:function(){return null},removeItem:function(){return null},key:function(){return null},length:function(){return 0}})}var B={},C={},D={},E=[],F=2e3;B.save=function(o,d){var f,i,t,u,l,p;if(d=d||{},G.isBootstrapping()&&!d.remote)return z("save",arguments);if(o.id?(f=n(o.type,o.id),l="object"!=typeof f):(l=!0,o.id=e.generateId()),l?o.createdBy=o.createdBy||e.account.ownerHash:f.createdBy&&(o.createdBy=f.createdBy),!l)for(p in f)if(!o.hasOwnProperty(p))switch(p.charAt(0)){case"_":d.remote&&(o[p]=f[p]);break;case"$":d.remote||(o[p]=f[p])}d.remote?o._syncedAt=g():d.silent||(o.updatedAt=g(),o.createdAt=o.createdAt||o.updatedAt),d.local?o._$local=!0:delete o._$local,i=e.defer();try{o=n(o.type,o.id,o,d),i.resolve(o,l).promise(),u=l?"add":"update",h(u,o,d)}catch(c){t=c,i.reject(t.toString())}return i.promise()},B.find=function(o,d){var f,i;if(G.isBootstrapping())return z("find",arguments);try{return i=n(o,d),i?e.resolveWith(i):e.rejectWith({name:"HoodieNotFoundError",message:'"{{type}}" with id "{{id}}" could not be found'})}catch(t){return f=t,e.rejectWith(f)}},B.findAll=function(o){var d,f,i,t,u,l,p,c,s;if(null==o&&(o=function(){return!0}),G.isBootstrapping())return z("findAll",arguments);l=G.index(),"string"==typeof o&&(s=o,o=function(e){return e.type===s}),f=e.defer();try{c=function(){var e,f,i,c;for(c=[],e=0,f=l.length;f>e;e++)u=l[e],m(u)&&(i=u.split("/"),d=i[0],t=i[1],p=n(d,t),p&&o(p)&&c.push(p));return c}.call(this),c.sort(function(e,o){return e.createdAt>o.createdAt?-1:e.createdAt<o.createdAt?1:0}),f.resolve(c).promise()}catch(y){i=y,f.reject(i).promise()}return f.promise()},B.remove=function(o,d,f){var i,t,u;return f=f||{},G.isBootstrapping()&&!f.remote?z("remove",arguments):(i=o+"/"+d,t=n(o,d),f.remote&&(J.removeItem(i),u=C[i]&&j(C[i]),C[i]=!1,s(o,d),u&&t)?e.resolveWith(t):t?(t._syncedAt?(t._deleted=!0,n(o,d,t)):(i=o+"/"+d,J.removeItem(i),C[i]=!1,s(o,d)),f.update&&(t=f.update,delete f.update),h("remove",t,f),e.resolveWith(t)):e.rejectWith({name:"HoodieNotFoundError",message:'"{{type}}" with id "{{id}}"" could not be found'}))},B.removeAll=function(e,o){return G.findAll(e).then(function(e){var n,d,f,i;for(i=[],d=0,f=e.length;f>d;d++)n=e[d],i.push(G.remove(n.type,n.id,o));return i})};var G=f(e,{validate:o,backend:{save:B.save,find:B.find,findAll:B.findAll,remove:B.remove,removeAll:B.removeAll}});G.index=function(){var e,o,n,d,f;for(n=[],e=d=0,f=J.length();f>=0?f>d:d>f;e=f>=0?++d:--d)o=J.key(e),m(o)&&n.push(o);return n},G.changedObjects=function(){var e,o,n,d,f,i,t;f=D,t=[];for(o in f)f.hasOwnProperty(o)&&(n=f[o],i=o.split("/"),d=i[0],e=i[1],n.type=d,n.id=e,t.push(n));return t},G.hasLocalChanges=function(e,o){if(!e)return!$.isEmptyObject(D);var d=[e,o].join("/");return D[d]?!0:x(n(e,o))},G.clear=function(){var o,n,d,f;o=e.defer();try{d=G.index(),f=function(){var e,o,f;for(f=[],e=0,o=d.length;o>e;e++)n=d[e],m(n)&&f.push(J.removeItem(n));return f}.call(this),C={},s(),o.resolve(),G.trigger("clear")}catch(i){o.reject(i)}return o.promise()};var I=!1;G.isBootstrapping=function(){return I},G.isPersistent=function(){try{if(!d.localStorage)return!1;if(localStorage.setItem("Storage-Test","1"),"1"!==localStorage.getItem("Storage-Test"))return!1;localStorage.removeItem("Storage-Test")}catch(e){return!1}return!0};var J={getItem:function(e){return d.localStorage.getItem(e)},setItem:function(e,o){return d.localStorage.setItem(e,o)},removeItem:function(e){return d.localStorage.removeItem(e)},key:function(e){return d.localStorage.key(e)},length:function(){return d.localStorage.length}};G.subscribeToOutsideEvents=function(){p(),delete G.subscribeToOutsideEvents};var K,L=new RegExp(/^[a-z$][a-z0-9]+\/[a-z0-9]+$/);e.store=G,G.bootstrapDirtyObjects=function(){l(),delete G.bootstrapDirtyObjects},G.patchIfNotPersistant=function(){A(),delete G.patchIfNotPersistant}}var d="undefined"!=typeof self?self:"undefined"!=typeof window?window:{},f=e("./store"),i=e("../error/object_type"),t=e("../error/object_id"),u=e("extend"),u=e("extend");o.exports=n},{"../error/object_id":7,"../error/object_type":8,"./store":14,extend:1}],12:[function(e,o){function n(e,o){function n(e){return"function"==typeof h?h(e):h=e}function t(e){var o,n;n=i({},e);for(o in n)if(n.hasOwnProperty(o)){if(-1!==B.indexOf(o))continue;if(!/^_/.test(o))continue;delete n[o]}return n._id=""+n.type+"/"+n.id,m.prefix&&(n._id=""+m.prefix+n._id),delete n.id,n}function u(e){var o,n,d;return o=e._id||e.id,delete e._id,m.prefix&&(o=o.replace(j,"")),d=o.match(/([^\/]+)\/(.*)/),n=d[0],e.type=d[1],e.id=d[2],e}function l(e){var o,n,d,f;for(f=[],n=0,d=e.length;d>n;n++)o=e[n],f.push(u(o));return f}function p(e){var o,n,d,f;try{f=e._rev.split(/-/),n=f[0],o=f[1]}catch(i){}return n=parseInt(n,10)||0,d=c(),e._$local&&(d+="-local"),e._rev=""+(n+1)+"-"+d,e._revisions={start:1,ids:[d]},o?(e._revisions.start+=n,e._revisions.ids.push(o)):void 0}function c(){return e.generateId(9)}function s(e){return e.rows.map(function(e){return e.doc})}function y(){var e;return e=m.getSinceNr(),m.isConnected()&&!k?"/_changes?include_docs=true&since="+e+"&heartbeat=10000&feed=longpoll":"/_changes?include_docs=true&since="+e}function w(){q&&q.abort()}function a(e){return n(e.last_seq),H(e.results),m.isConnected()?m.pull():void 0}function b(o,n){if(m.isConnected())switch(o.status){case 401:return m.trigger("error:unauthenticated",n),m.disconnect();case 404:return d.setTimeout(m.pull,3e3);case 500:return m.trigger("error:server",n),d.setTimeout(m.pull,3e3),e.checkConnection();default:return"abort"===o.statusText?m.pull():(d.setTimeout(m.pull,3e3),e.checkConnection())}}function r(){k=!1,m.trigger("bootstrap:end")}function H(e){var o,n,d,f,i;for(f=0,i=e.length;i>f;f++)if(o=e[f].doc,!m.prefix||0===o._id.indexOf(m.prefix)){if(d=u(o),d._deleted){if(!m.isKnownObject(d))continue;n="remove",m.isKnownObject(d)}else m.isKnownObject(d)?n="update":(n="add",m.markAsKnownObject(d));m.trigger(n,d),m.trigger(n+":"+d.type,d),m.trigger(n+":"+d.type+":"+d.id,d),m.trigger("change",n,d),m.trigger("change:"+d.type,n,d),m.trigger("change:"+d.type+":"+d.id,n,d)}}var g={};g.find=function(e,o){var n;return n=e+"/"+o,m.prefix&&(n=m.prefix+n),n="/"+encodeURIComponent(n),m.request("GET",n).then(u)},g.findAll=function(e){var o,n,d;switch(n="/_all_docs?include_docs=true",!0){case void 0!==e&&""!==m.prefix:d=m.prefix+e+"/";break;case void 0!==e:d=e+"/";break;case""!==m.prefix:d=m.prefix;break;default:d=""}return d&&(o=d.replace(/.$/,function(e){var o;return o=e.charCodeAt(0),String.fromCharCode(o+1)}),n=""+n+'&startkey="'+encodeURIComponent(d)+'"&endkey="'+encodeURIComponent(o)+'"'),m.request("GET",n).then(s).then(l)},g.save=function(o){var n;return o.id||(o.id=e.generateId()),o=t(o),n="/"+encodeURIComponent(o._id),m.request("PUT",n,{data:o})},g.remove=function(e,o){return m.update(e,o,{_deleted:!0})},g.removeAll=function(e){return m.updateAll(e,{_deleted:!0})};var m=f(e,{name:o.name,backend:{save:g.save,find:g.find,findAll:g.findAll,remove:g.remove,removeAll:g.removeAll}}),x=null;m.connected=!1,m.prefix="";var j=new RegExp("^");void 0!==o.name&&(x=o.name),void 0!==o.prefix&&(m.prefix=o.prefix,j=new RegExp("^"+m.prefix)),null!==o.baseUrl&&(m.baseUrl=o.baseUrl),m.request=function(o,n,d){return d=d||{},x&&(n="/"+encodeURIComponent(x)+n),m.baseUrl&&(n=""+m.baseUrl+n),d.contentType=d.contentType||"application/json",("POST"===o||"PUT"===o)&&(d.dataType=d.dataType||"json",d.processData=d.processData||!1,d.data=JSON.stringify(d.data)),e.request(o,n,d)},m.isKnownObject=function(e){var o=""+e.type+"/"+e.id;return void 0!==A[o]?A[o]:void 0},m.markAsKnownObject=function(e){var o=""+e.type+"/"+e.id;return A[o]=1,A[o]},m.connect=function(e){return e&&(x=e),m.connected=!0,m.trigger("connect"),m.bootstrap().then(function(){m.push()})},m.disconnect=function(){m.connected=!1,m.trigger("disconnect"),q&&q.abort(),z&&z.abort()},m.isConnected=function(){return m.connected};var h=o.since||0;m.getSinceNr=function(){return"function"==typeof h?h():h};var k=!1;m.bootstrap=function(){return k=!0,m.trigger("bootstrap:start"),m.pull().done(r)};var q,v;m.pull=function(){return q=m.request("GET",y()),m.isConnected()&&(d.clearTimeout(v),v=d.setTimeout(w,25e3)),q.done(a).fail(b)};var z;m.push=function(o){var n,d,f,u;if($.isArray(o)||(o=C()),0===o.length)return e.resolveWith([]);for(d=[],f=0,u=o.length;u>f;f++)n=i(!0,{},o[f]),p(n),n=t(n),d.push(n);return z=m.request("POST","/_bulk_docs",{data:{docs:d,new_edits:!1}}),z.done(function(){for(var e=0;e<o.length;e++)m.trigger("push",o[e])}),z},m.sync=function(e){return m.push(e).then(m.pull)};var A={},B=["_id","_rev","_deleted","_revisions","_attachments"],C=function(){return[]};if(o.defaultObjectsToPush&&(C=$.isArray(o.defaultObjectsToPush)?function(){return o.defaultObjectsToPush}:o.defaultObjectsToPush),o.knownObjects)for(var D=0;D<o.knownObjects.length;D++)m.markAsKnownObject({type:o.knownObjects[D].type,id:o.knownObjects[D].id});return m}var d="undefined"!=typeof self?self:"undefined"!=typeof window?window:{},f=e("./store"),i=e("extend");o.exports=n},{"./store":14,extend:1}],13:[function(e,o){function n(e,o,n){var f=n.name||"store",i=n.type,t=n.id,u={};return t||(d(e,{context:u,namespace:f+":"+i}),u.save=function(e,n,d){return o.save(i,e,n,d)},u.add=function(e,n){return o.add(i,e,n)},u.find=function(e){return o.find(i,e)},u.findOrAdd=function(e,n){return o.findOrAdd(i,e,n)},u.findAll=function(e){return o.findAll(i,e)},u.update=function(e,n,d){return o.update(i,e,n,d)},u.updateAll=function(e,n){return o.updateAll(i,e,n)},u.remove=function(e,n){return o.remove(i,e,n)},u.removeAll=function(e){return o.removeAll(i,e)}),t&&(d(e,{context:u,namespace:f+":"+i+":"+t}),u.save=function(e,n){return o.save(i,t,e,n)},u.find=function(){return o.find(i,t)},u.update=function(e,n){return o.update(i,t,e,n)},u.remove=function(e){return o.remove(i,t,e)}),u.decoratePromises=o.decoratePromises,u.validate=o.validate,u}var d=e("../events");o.exports=n},{"../events":9}],14:[function(e,o){function n(e,o){function n(e){return l(e,c)}var p={},c={hoodie:e},s=o.name||"store",y=function r(n,f){var i=l(!0,{type:n,id:f},o);return d(e,r,i)};if(f(e,{context:y,namespace:s}),y.validate=o.validate,o.validate||(y.validate=function(e){if(!e)return new i({name:"InvalidObjectError",message:"No object passed."});if(t.isInvalid(e.type,a))return new t({type:e.type,rules:b});if(e.id)return u.isInvalid(e.id,a)?new u({id:e.id,rules:b}):void 0}),y.save=function(o,d,f,i){i=i?l(!0,{},i):{};var t=l(!0,{},f,{type:o,id:d}),u=y.validate(t,i||{});return u?e.rejectWith(u):n(p.save(t,i||{}))},y.add=function(e,o,n){return void 0===o&&(o={}),n=n||{},y.save(e,o.id,o,n)},y.find=function(e,o){return n(p.find(e,o))},y.findOrAdd=function(e,o,d){function f(){var n;return n=l(!0,{id:o},d),y.add(e,n)}null===d&&(d={});var i=y.find(e,o).then(null,f);return n(i)},y.findAll=function(e,o){return n(p.findAll(e,o))},y.update=function(o,d,f,i){function t(n){var t,u,p;return u=l(!0,{},n),"function"==typeof f&&(f=f(u)),f?(t=function(){var e=[];for(var o in f)if(f.hasOwnProperty(o)){if(p=f[o],n[o]!==p==!1)continue;u[o]=p,e.push(o)}return e}(),t.length||i?y.save(o,d,u,i):e.resolveWith(u)):e.resolveWith(n)}var u=y.find(o,d).then(t);return n(u)},y.updateOrAdd=function(e,o,d,f){function i(){var n=l(!0,{},d,{id:o});return y.add(e,n,f)}var t=y.update(e,o,d,f).then(null,i);return n(t)},y.updateAll=function(o,d,f){var i;switch(f=f||{},!0){case"string"==typeof o:i=y.findAll(o);break;case e.isPromise(o):i=o;break;case $.isArray(o):i=e.defer().resolve(o).promise();break;default:i=y.findAll()}return i=i.then(function(e){var o,n;return $.isArray(e)||(e=[e]),n=function(){var n,i,t;for(t=[],n=0,i=e.length;i>n;n++)o=e[n],t.push(y.update(o.type,o.id,d,f));return t}(),$.when.apply(null,n)}),n(i)},y.remove=function(e,o,d){return n(p.remove(e,o,d||{}))},y.removeAll=function(e,o){return n(p.removeAll(e,o||{}))},y.decoratePromises=function(e){return l(c,e)},!o.backend)throw new Error("options.backend must be passed");var w="save find findAll remove removeAll".split(" ");w.forEach(function(e){if(!o.backend[e])throw new Error("options.backend."+e+" must be passed.");p[e]=o.backend[e]});var a=/^[^\/]+$/,b="/ not allowed";return y}var d=e("./scoped"),f=e("../events"),i=e("../error/error"),t=e("../error/object_type"),u=e("../error/object_id"),l=e("extend");o.exports=n},{"../error/error":6,"../error/object_id":7,"../error/object_type":8,"../events":9,"./scoped":13,extend:1}],15:[function(e,o){function n(e){function o(){e.on("store:change",l)}function n(o){var n=e.defer(),d=e.store(o.type,o.id);return d.on("remove",function(e){return e.type=e.type.substr(1),e.$processedAt?n.resolve(e):(n.reject(new i({message:"Task has been cancelled",task:e})),void 0)}),d.on("update",function(o){var d=o.$error;o.$error&&(o.type=o.type.substr(1),delete o.$error,d.object=o,d.message=d.message||"Something went wrong",n.reject(new i(d)),e.store.remove("$"+o.type,o.id))}),n.promise()}function u(o){var n,d=o.type,f=o.id,i=e.store.remove(d,f);return o._rev?(n=e.defer(),e.one("store:sync:"+d+":"+f,n.resolve),i.fail(n.reject),n.promise()):i}function l(e,o,n){"$"===o.type[0]&&(o.type=o.type.substr(1),y(e,o,n))}function p(o){var n,d="$";return o&&(d+=o),n=function(e){return 0===e.type.indexOf(d)},e.store.findAll(n)}function c(e){return e.map(function(e){return a.cancel(e.type.substr(1),e.id)})}function s(e,o){return e.map(function(e){return a.restart(e.type.substr(1),e.id,o)})}function y(e,o,n){var d;return"add"===e&&(e="start"),"remove"===e&&o.cancelledAt&&(e="cancel"),"remove"===e&&o.$processedAt&&(e="success"),"update"===e&&o.$error?(e="error",d=o.$error,delete o.$error,a.trigger("error",d,o,n),a.trigger(o.type+":error",d,o,n),a.trigger(o.type+":"+o.id+":error",d,o,n),n=t({},n,{error:d}),a.trigger("change","error",o,n),a.trigger(o.type+":change","error",o,n),a.trigger(o.type+":"+o.id+":change","error",o,n),void 0):(("start"===e||"cancel"===e||"success"===e)&&(a.trigger(e,o,n),a.trigger(o.type+":"+e,o,n),"start"!==e&&a.trigger(o.type+":"+o.id+":"+e,o,n),a.trigger("change",e,o,n),a.trigger(o.type+":change",e,o,n),"start"!==e&&a.trigger(o.type+":"+o.id+":change",e,o,n)),void 0)
}function w(){return JSON.stringify(new Date).replace(/['"]/g,"")}var a=function b(o,n){return f(e,b,{type:o,id:n})};d(e,{context:a,namespace:"task"}),a.start=function(o,d){return e.account.hasAccount()?e.store.add("$"+o,d).then(n):e.account.anonymousSignUp().then(function(){return a.start(o,d)})},a.cancel=function(o,n){return e.store.update("$"+o,n,{cancelledAt:w()}).then(u)},a.restart=function(e,o,n){var d=function(e){return t(e,n),delete e.$error,delete e.$processedAt,delete e.cancelledAt,a.start(e.type,e)};return a.cancel(e,o).then(d)},a.cancelAll=function(e){return p(e).then(c)},a.restartAll=function(e,o){return"object"==typeof e&&(o=e),p(e).then(function(e){s(e,o)})},a.subscribeToOutsideEvents=function(){o(),delete a.subscribeToOutsideEvents},e.task=a}var d=e("../events"),f=e("./scoped"),i=e("../error/error"),t=e("extend");o.exports=n},{"../error/error":6,"../events":9,"./scoped":16,extend:1}],16:[function(e,o){function n(e,o,n){var f=n.type,i=n.id,t={};return i||(d(e,{context:t,namespace:"task:"+f}),t.start=function(e){return o.start(f,e)},t.cancel=function(e){return o.cancel(f,e)},t.restart=function(e,n){return o.restart(f,e,n)},t.cancelAll=function(){return o.cancelAll(f)},t.restartAll=function(e){return o.restartAll(f,e)}),i&&(d(e,{context:t,namespace:"task:"+f+":"+i}),t.cancel=function(){return o.cancel(f,i)},t.restart=function(e){return o.restart(f,i,e)}),t}var d=e("../events");o.exports=n},{"../events":9}],17:[function(e,o){function n(e){var o=this;if(!(o instanceof n))throw new Error("usage: new Hoodie(url);");e&&(o.baseUrl=e.replace(/\/+$/,"")),o.extend=function(e){e(o)},o.extend(r),o.extend(l),o.extend(p),o.extend(c),o.extend(a),o.extend(s),o.extend(y),o.extend(w),o.store.patchIfNotPersistant(),o.extend(b),o.extend(u),o.extend(i),o.extend(t),o.account.username=o.config.get("_account.username"),o.account.checkPasswordReset(),o.on("account:signout",o.config.clear),o.store.subscribeToOutsideEvents(),o.store.bootstrapDirtyObjects(),o.remote.subscribeToOutsideEvents(),o.task.subscribeToOutsideEvents(),o.account.authenticate().then(function(){o.remote.connect()}),f.addEventListener("online",o.checkConnection,!1),f.addEventListener("offline",o.checkConnection,!1),o.checkConnection(),d(o)}function d(e){for(var o=0;o<H.length;o++)H[o](e)}var f="undefined"!=typeof self?self:"undefined"!=typeof window?window:{},i=e("./core/account"),t=e("./core/account/remote"),u=e("./core/config"),l=e("./utils/promises"),p=e("./core/request"),c=e("./core/connection"),s=e("./utils/dispose"),y=e("./utils/open"),w=e("./core/store/local"),a=e("./utils/generate_id"),b=e("./core/task/index"),r=e("./core/events"),H=[];n.extend=function(e){H.push(e)},o.exports=n},{"./core/account":2,"./core/account/remote":3,"./core/config":4,"./core/connection":5,"./core/events":9,"./core/request":10,"./core/store/local":11,"./core/task/index":15,"./utils/dispose":18,"./utils/generate_id":19,"./utils/open":21,"./utils/promises":22}],18:[function(e,o){function n(e){function o(){e.trigger("dispose"),e.unbind()}e.dispose=o}o.exports=n},{}],19:[function(e,o){function n(e){function o(e){var o="";for(void 0===e&&(e=7),d=0;e>d;d++){var i=Math.random()*f,t=n[Math.floor(i)];o+=String(t).charAt(0)}return o}var n,d,f;n="0123456789abcdefghijklmnopqrstuvwxyz".split(""),f=n.length,e.generateId=o}o.exports=n},{}],20:[function(e,o){o.exports={now:function(){return JSON.stringify(new Date).replace(/['"]/g,"")},hoodiefyRequestErrorName:function(e){return e=e.replace(/(^\w|_\w)/g,function(e){return(e[1]||e[0]).toUpperCase()}),"Hoodie"+e+"Error"}}},{}],21:[function(e,o){function n(e){function o(o,n){return n=n||{},f(n,{name:o}),d(e,n)}e.open=o}var d=e("../core/store/remote"),f=e("extend"),f=e("extend");o.exports=n},{"../core/store/remote":12,extend:1}],22:[function(e,o){function n(e){function o(e){return!(!e||"function"!=typeof e.done||"function"==typeof e.resolve)}function n(){return l().resolve().promise()}function i(){return l().reject().promise()}function t(){var e=l();return e.resolve.apply(e,arguments).promise()}function u(e){var o=l(),n=new f(e);return o.reject(n).promise()}var l=d.jQuery.Deferred;e.defer=l,e.isPromise=o,e.resolve=n,e.reject=i,e.resolveWith=t,e.rejectWith=u}var d="undefined"!=typeof self?self:"undefined"!=typeof window?window:{},f=e("../core/error/error");o.exports=n},{"../core/error/error":6}]},{},[17])(17)});