//  hoodie 0.2.3
"use strict";function hoodieEvents(a){function b(a,b){var c,d,e,g;for(c=a.split(" "),e=0,g=c.length;g>e;e++)d=c[e],f[d]=f[d]||[],f[d].push(b)}function c(a,c){b(a,function(){e(a,c),c.apply(null,arguments)})}function d(){var a,b,c,d,e,g;if(a=1<=arguments.length?Array.prototype.slice.call(arguments,0):[],c=a.shift(),d=f[c]){for(e=0,g=d.length;g>e;e++)b=d[e],b.apply(null,a);return!0}}function e(a,b){var c,d,e,g,h;if(!a)return f={},void 0;if(e=f[a]){if(!b)return delete f[a],void 0;for(d=g=0,h=e.length;h>g;d=++g)if(c=e[d],c===b){e=e.slice(),e.splice(d,1),f[a]=e;break}}}var f={};a.bind=b,a.on=b,a.one=c,a.trigger=d,a.unbind=e,a.off=e}function hoodiePromises(a){function b(a){return!(!a||"function"!=typeof a.done||"function"==typeof a.resolve)}function c(){return g().resolve().promise()}function d(){return g().reject().promise()}function e(){var a=g();return a.resolve.apply(a,arguments).promise()}function f(){var a=g();return a.reject.apply(a,arguments).promise()}var g=window.jQuery.Deferred;a.defer=g,a.isPromise=b,a.resolve=c,a.reject=d,a.resolveWith=e,a.rejectWith=f}function hoodieRequest(a){function b(b,f,g){var h,i,j;return g=g||{},/^http/.test(f)||(f=""+a.baseUrl+f),h={type:b,url:f,xhrFields:{withCredentials:!0},crossDomain:!0,dataType:"json"},i=e(d(h,g)),j=i.then(null,c),j.abort=i.abort,j}function c(b){var c;try{c=JSON.parse(b.responseText)}catch(d){c={error:b.responseText||"Cannot connect to Hoodie server at "+a.baseUrl}}return a.rejectWith(c).promise()}var d=$.extend,e=$.ajax;a.request=b}function hoodieConnection(a){function b(){var b=h;return b&&"pending"===b.state()?b:h=a.request("GET","/").pipe(d,e)}function c(){return f}function d(){return g=3e4,window.setTimeout(b,g),a.isOnline()||(a.trigger("reconnected"),f=!0),a.resolve()}function e(){return g=3e3,window.setTimeout(b,g),a.isOnline()&&(a.trigger("disconnected"),f=!1),a.reject()}var f=!0,g=3e4,h=null;a.isOnline=c,a.checkConnection=b}function hoodieUUID(a){function b(a){var b,c,d;return void 0===a&&(a=7),b="0123456789abcdefghijklmnopqrstuvwxyz".split(""),d=b.length,function(){var e,f=[];for(c=e=0;a>=0?a>e:e>a;c=a>=0?++e:--e){var g=Math.random()*d;f.push(b[0]=String(g).charAt(0))}return f}().join("")}a.uuid=b}function hoodieDispose(a){function b(){a.trigger("dispose")}a.dispose=b}function hoodieOpen(a){function b(b,d){return d=d||{},c(d,{name:b}),new Hoodie.Remote(a,d)}var c=window.jQuery.extend;a.open=b}function hoodieStore(a){a.store=new Hoodie.LocalStore(a)}function hoodieConfig(a){function b(b,c){var d,e;if(h[b]!==c)return h[b]=c,e={},e[b]=c,d="_"===b.charAt(0),a.store.update(f,g,e,{silent:d})}function c(a){return h[a]}function d(){return h={},a.store.remove(f,g)}function e(a){return b(a,void 0)}var f="$config",g="hoodie",h={};a.store.find(f,g).done(function(a){h=a}),a.on("account:signedOut",d),a.config={set:b,get:c,clear:d,remove:e}}function hoodieAccount(a){function b(b){return a.config.set(J,b)}function c(){return a.config.get(J)}function d(){return a.config.remove(J)}function e(b){return F.username!==b?(F.username=b,a.config.set("_account.username",b)):void 0}function f(b){return F.ownerHash!==b?(F.ownerHash=b,a.config.set("createdBy",b),a.config.set("_account.ownerHash",b)):void 0}function g(b){return b.userCtx.name?(E=!0,e(b.userCtx.name.replace(/^user(_anonymous)?\//,"")),f(b.userCtx.roles[0]),a.defer().resolve(F.username).promise()):F.hasAnonymousAccount()?(F.signIn(F.username,c()),void 0):(E=!1,F.trigger("error:unauthenticated"),a.defer().reject().promise())}function h(b){var c;if(b=b||{},b.reason)return a.defer().reject(b).promise();var d=b;try{b=JSON.parse(d.responseText)}catch(e){c=e,b={error:d.responseText||"unknown"}}return a.defer().reject(b).promise()}function i(a,b){return function(c){return F.trigger("signup",a),G._rev=c.rev,j(a,b)}}function j(b,c,d,e){return e||(e=a.defer()),window.setTimeout(function(){var a=C(b,c);a.done(e.resolve),a.fail(function(a){"unconfirmed"===a.error?j(b,c,d,e):e.reject.apply(e,arguments)})},300),e.promise()}function k(b){return b=b||{},function(c){var d,g;return d=a.defer(),g=c.name.replace(/^user(_anonymous)?\//,""),-1!==c.roles.indexOf("error")?(F.fetch(g).fail(d.reject).done(function(){return d.reject({error:"error",reason:G.$error})}),d.promise()):-1===c.roles.indexOf("confirmed")?d.reject({error:"unconfirmed",reason:"account has not been confirmed yet"}):(e(g),f(c.roles[0]),E=!0,b.silent||b.reauthenticated||(F.hasAnonymousAccount()?F.trigger("signin:anonymous",g):F.trigger("signin",g)),b.reauthenticated&&F.trigger("reauthenticated",g),F.fetch(),d.resolve(g,c.roles[0]))}}function l(){var b,c,d,e,f;return(d=a.config.get("_account.resetPasswordId"))?(f="$passwordReset/"+d,e="/_users/"+encodeURIComponent(""+I+":"+f),b=btoa(""+f+":"+d),c={headers:{Authorization:"Basic "+b}},z("passwordResetStatus",function(){return F.request("GET",e,c).pipe(m,n).fail(function(a){return"pending"===a.error?(window.setTimeout(l,1e3),void 0):F.trigger("password_reset:error")})})):a.defer().reject({error:"missing"}).promise()}function m(b){var c=a.defer();return b.$error?c.reject(b.$error):c.reject({error:"pending"}),c.promise()}function n(b){return 401===b.status?(a.config.remove("_account.resetPasswordId"),F.trigger("passwordreset"),a.defer().resolve()):h(b)}function o(a,b,c){return C(F.username,a,{silent:!0}).pipe(function(){return F.fetch().pipe(x(a,b,c))})}function p(a,b){var e;return e=c(),o(e,a,b).done(function(){F.trigger("signup",a),d()})}function q(){return a.remote.disconnect(),G._deleted=!0,z("updateUsersDoc",function(){F.request("PUT",w(),{data:JSON.stringify(G),contentType:"application/json"})})}function r(b){return"not_found"===b.error?a.defer().resolve().promise():a.defer().reject(b).promise()}function s(b){return b=b||{},F.trigger("cleanup"),E=b.authenticated,a.config.clear(),e(b.username),f(b.ownerHash||a.uuid()),a.defer().resolve().promise()}function t(){return s().then(function(){return F.trigger("signout")})}function u(a){var b;return b=a===F.ownerHash?"user_anonymous":"user",""+b+"/"+a}function v(a){return a=a||F.username,""+I+":"+u(a)}function w(a){return"/_users/"+encodeURIComponent(v(a))}function x(a,b,c){return function(){var d=$.extend({},G);b&&(d.$newUsername=b),d.updatedAt=D(),d.signedUpAt=d.signedUpAt||D(),null!==c&&(delete d.salt,delete d.password_sha,d.password=c);var e={data:JSON.stringify(d),contentType:"application/json"};return z("updateUsersDoc",function(){return F.request("PUT",w(),e).pipe(y(b,c||a),h)})}}function y(b,c){return function(){return a.remote.disconnect(),b?j(b,c,{silent:!0}):F.signIn(F.username,c)}}function z(a,b){return void 0!==H[a]&&"function"==typeof H[a].abort&&H[a].abort(),H[a]=b(),H[a]}function A(a,b){return void 0!==H[a]&&"function"==typeof H[a].state&&"pending"===H[a].state()?H[a]:(H[a]=b(),H[a])}function B(){return A("signOut",function(){return F.request("DELETE","/_session").pipe(null,h)})}function C(a,b,c){var d={data:{name:u(a),password:b}};return z("signIn",function(){var a=F.request("POST","/_session",d);return a.pipe(k(c),h)})}function D(){return new Date}var E,F={},G={},H={},I="org.couchdb.user";F.username=a.config.get("_account.username"),F.ownerHash=a.config.get("_account.ownerHash"),F.authenticate=function(){var b;return E===!1?a.defer().reject().promise():E===!0?a.defer().resolve(F.username).promise():H.signOut&&"pending"===H.signOut.state()?H.signOut.then(a.rejectWith):H.signIn&&"pending"===H.signIn.state()?H.signIn:void 0===F.username?B().then(function(){return E=!1,a.rejectWith()}):(b=function(){return F.request("GET","/_session").pipe(g,h)},A("authenticate",b))},F.signUp=function(b,c){if(void 0===c&&(c=""),!b)return a.defer().reject({error:"username must be set"}).promise();if(F.hasAnonymousAccount())return p(b,c);if(F.hasAccount())return a.defer().reject({error:"you have to sign out first"}).promise();b=b.toLowerCase();var d={data:JSON.stringify({_id:v(b),name:u(b),type:"user",roles:[],password:c,ownerHash:F.ownerHash,database:F.db(),updatedAt:D(),createdAt:D(),signedUpAt:b!==F.ownerHash?D():void 0}),contentType:"application/json"};return F.request("PUT",w(b),d).pipe(i(b,c),h)},F.anonymousSignUp=function(){var c,d;return c=a.uuid(10),d=F.ownerHash,F.signUp(d,c).done(function(){return b(c),F.trigger("signup:anonymous",d)})},F.hasAccount=function(){return!!F.username},F.hasAnonymousAccount=function(){return void 0!==c()};var J="_account.anonymousPassword";F.signIn=function(a,b){return null===a&&(a=""),void 0===b&&(b=""),a=a.toLowerCase(),a!==F.username?F.signOut({silent:!0}).pipe(function(){return C(a,b)}):C(a,b,{reauthenticated:!0})},F.signOut=function(b){return b=b||{},F.hasAccount()?(a.remote.disconnect(),B().pipe(t)):s().then(function(){return b.silent?void 0:F.trigger("signout")})},F.on=function(b,c){return b=b.replace(/(^| )([^ ]+)/g,"$1account:$2"),a.on(b,c)},F.trigger=function(){var b,c;b=arguments[0],c=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],a.trigger.apply(a,["account:"+b].concat(Array.prototype.slice.call(c)))},F.request=function(b,c,d){return d=d||{},a.request.apply(a,arguments)},F.db=function(){return"user/"+F.ownerHash},F.fetch=function(b){return void 0===b&&(b=F.username),b?A("fetch",function(){return F.request("GET",w(b)).pipe(null,h).done(function(a){return G=a})}):a.defer().reject({error:"unauthenticated",reason:"not logged in"}).promise()},F.changePassword=function(b,c){return F.username?(a.remote.disconnect(),F.fetch().pipe(x(b,null,c),h)):a.defer().reject({error:"unauthenticated",reason:"not logged in"}).promise()},F.resetPassword=function(b){var c,d,e,f;return(f=a.config.get("_account.resetPasswordId"))?l():(f=""+b+"/"+a.uuid(),a.config.set("_account.resetPasswordId",f),d=""+I+":$passwordReset/"+f,c={_id:d,name:"$passwordReset/"+f,type:"user",roles:[],password:f,createdAt:D(),updatedAt:D()},e={data:JSON.stringify(c),contentType:"application/json"},z("resetPassword",function(){return F.request("PUT","/_users/"+encodeURIComponent(d),e).pipe(null,h).done(l)}))},F.changeUsername=function(a,b){return b=b||"",o(a,b.toLowerCase())},F.destroy=function(){return F.hasAccount()?F.fetch().pipe(q,r).pipe(t):t()},a.account=F,F.ownerHash||f(a.uuid()),window.setTimeout(F.authenticate),l()}function hoodieRemote(a){a.remote=new Hoodie.AccountRemote(a)}Object.deepExtend=function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},function(a){function b(a){var d=this;if(!(d instanceof b))throw new Error("usage: new Hoodie(url);");d.baseUrl=a?a.replace(/\/+$/,""):"/_api",d.extend=function(a){a(d)},d.extend(hoodieEvents),d.extend(hoodiePromises),d.extend(hoodieRequest),d.extend(hoodieConnection),d.extend(hoodieUUID),d.extend(hoodieDispose),d.extend(hoodieOpen),d.extend(hoodieStore),d.extend(hoodieConfig),d.extend(hoodieAccount),d.extend(hoodieRemote),c(d)}function c(a){for(var b=0;b<d.length;b++)d[b](a)}var d=[];b.extend=function(a){d.push(a)},"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=b:"function"==typeof define&&define.amd?define("hoodie",[],function(){return b}):a.Hoodie=b}(window),Hoodie.Store=function(){function a(a){this.hoodie=a}return a.prototype.save=function(a,b,c,d){var e;return null===d&&(d={}),e=this.hoodie.defer(),"object"!=typeof c||Array.isArray(c)?(e.reject(Hoodie.Errors.INVALID_ARGUMENTS("invalid object")),e.promise()):b&&!this._isValidId(b)?e.reject(Hoodie.Errors.INVALID_KEY({id:b})).promise():this._isValidType(a)?e:e.reject(Hoodie.Errors.INVALID_KEY({type:a})).promise()},a.prototype.add=function(a,b,c){return void 0===b&&(b={}),c=c||{},this.save(a,b.id,b)},a.prototype.update=function(a,b,c,d){var e,f,g=this;return e=this.hoodie.defer(),f=this.find(a,b).pipe(function(f){var h,i,j;return i=$.extend(!0,{},f),"function"==typeof c&&(c=c(i)),c?(h=function(){var a=[];for(var b in c)if(c.hasOwnProperty(b)){if(j=c[b],f[b]!==j==!1)continue;i[b]=j,a.push(b)}return a}(),h.length||d?(g.save(a,b,i,d).then(e.resolve,e.reject),void 0):e.resolve(i)):e.resolve(f)}),f.fail(function(){return g.save(a,b,c,d).then(e.resolve,e.reject)}),e.promise()},a.prototype.updateAll=function(a,b,c){var d,e=this;switch(c=c||{},!0){case"string"==typeof a:d=this.findAll(a);break;case this.hoodie.isPromise(a):d=a;break;case $.isArray(a):d=this.hoodie.defer().resolve(a).promise();break;default:d=this.findAll()}return d.pipe(function(a){var d,f,g;return d=e.hoodie.defer(),$.isArray(a)||(a=[a]),g=function(){var d,e,g;for(g=[],d=0,e=a.length;e>d;d++)f=a[d],g.push(this.update(f.type,f.id,b,c));return g}.call(e),$.when.apply(null,g).then(d.resolve),d.promise()})},a.prototype.find=function(a,b){var c;return c=this.hoodie.defer(),"string"!=typeof a||"string"!=typeof b?c.reject(Hoodie.Errors.INVALID_ARGUMENTS("type & id are required")).promise():c},a.prototype.findOrAdd=function(a,b,c){var d,e=this;return null===c&&(c={}),d=this.hoodie.defer(),this.find(a,b).done(d.resolve).fail(function(){var f;return f=$.extend(!0,{id:b},c),e.add(a,f).then(d.resolve,d.reject)}),d.promise()},a.prototype.findAll=function(){return this.hoodie.defer()},a.prototype.remove=function(a,b,c){var d;return null===c&&(c={}),d=this.hoodie.defer(),"string"!=typeof a||"string"!=typeof b?d.reject(Hoodie.Errors.INVALID_ARGUMENTS("type & id are required")).promise():d},a.prototype.removeAll=function(a,b){var c=this;return b=b||{},this.findAll(a).pipe(function(a){var d,e,f,g;for(g=[],e=0,f=a.length;f>e;e++)d=a[e],g.push(c.remove(d.type,d.id,b));return g})},a.prototype._now=function(){return new Date},a.prototype._isValidId=function(a){return new RegExp(/^[^\/]+$/).test(a)},a.prototype._isValidType=function(a){return new RegExp(/^[^\/]+$/).test(a)},a}(),Hoodie.Errors={INVALID_KEY:function(a){var b=a.id?"id":"type";return new Error("invalid "+b+" '"+a[b]+"': numbers and lowercase letters allowed only")},INVALID_ARGUMENTS:function(a){return new Error(a)},NOT_FOUND:function(a,b){return new Error(""+a+" with "+b+" could not be found")}};var ConnectionError;Hoodie.Remote=function(a){function b(a,b){this.hoodie=a,b=b||{},this._handlePullResults=this._handlePullResults.bind(this),this._handlePullError=this._handlePullError.bind(this),this._handlePullSuccess=this._handlePullSuccess.bind(this),this._restartPullRequest=this._restartPullRequest.bind(this),this._mapDocsFromFindAll=this._mapDocsFromFindAll.bind(this),this._parseAllFromRemote=this._parseAllFromRemote.bind(this),this._parseFromRemote=this._parseFromRemote.bind(this),this.sync=this.sync.bind(this),this.push=this.push.bind(this),this.pull=this.pull.bind(this),this.disconnect=this.disconnect.bind(this),this.connect=this.connect.bind(this),void 0!==b.name&&(this.name=b.name),void 0!==b.prefix&&(this.prefix=b.prefix),void 0!==b.connected&&(this.connected=b.connected),null!==b.baseUrl&&(this.baseUrl=b.baseUrl),this._knownObjects={},this.isConnected()&&this.connect()}return Object.deepExtend(b,a),b.prototype.name=null,b.prototype.connected=!1,b.prototype.prefix="",b.prototype.request=function(a,b,c){return c=c||{},this.name&&(b="/"+encodeURIComponent(this.name)+b),this.baseUrl&&(b=""+this.baseUrl+b),c.contentType=c.contentType||"application/json",("POST"===a||"PUT"===a)&&(c.dataType=c.dataType||"json",c.processData=c.processData||!1,c.data=JSON.stringify(c.data)),this.hoodie.request(a,b,c)},b.prototype.get=function(){return console.log.apply(console,[".get() not yet implemented"].concat(Array.prototype.slice.call(arguments)))},b.prototype.post=function(){return console.log.apply(console,[".post() not yet implemented"].concat(Array.prototype.slice.call(arguments)))},b.prototype.find=function(a,c){var d,e;return d=b.__super__.find.apply(this,arguments),this.hoodie.isPromise(d)?d:(e=""+a+"/"+c,this.prefix&&(e=this.prefix+e),e="/"+encodeURIComponent(e),this.request("GET",e).pipe(this._parseFromRemote))},b.prototype.findAll=function(a){var c,d,e,f;if(c=b.__super__.findAll.apply(this,arguments),this.hoodie.isPromise(c))return c;switch(e="/_all_docs?include_docs=true",!0){case void 0!==a&&""!==this.prefix:f=""+this.prefix+a+"/";break;case void 0!==a:f=""+a+"/";break;case""!==this.prefix:f=this.prefix;break;default:f=""}return f&&(d=f.replace(/.$/,function(a){var b;return b=a.charCodeAt(0),String.fromCharCode(b+1)}),e=""+e+'&startkey="'+encodeURIComponent(f)+'"&endkey="'+encodeURIComponent(d)+'"'),this.request("GET",e).pipe(this._mapDocsFromFindAll).pipe(this._parseAllFromRemote)},b.prototype.save=function(a,c,d){var e,f;return e=b.__super__.save.apply(this,arguments),this.hoodie.isPromise(e)?e:(c||(c=this.hoodie.uuid()),d=$.extend({type:a,id:c},d),d=this._parseForRemote(d),f="/"+encodeURIComponent(d._id),this.request("PUT",f,{data:d}))},b.prototype.remove=function(a,b){return this.update(a,b,{_deleted:!0})},b.prototype.removeAll=function(a){return this.updateAll(a,{_deleted:!0})},b.prototype.isKnownObject=function(a){var b=""+a.type+"/"+a.id;return void 0!==this._knownObjects[b]?this._knownObjects[b]:void 0},b.prototype.markAsKnownObject=function(a){var b=""+a.type+"/"+a.id;return this._knownObjects[b]=1,this._knownObjects[b]},b.prototype.connect=function(){return this.connected=!0,this.bootstrap()},b.prototype.disconnect=function(){this.connected=!1,void 0!==this._pullRequest&&this._pullRequest.abort(),void 0!==this._pushRequest&&this._pushRequest.abort()},b.prototype.isConnected=function(){return this.connected},b.prototype.getSinceNr=function(){return this._since||0},b.prototype.setSinceNr=function(a){return this._since=a,this._since},b.prototype.bootstrap=function(){return this.trigger("bootstrap:start"),this.pull().done(this._handleBootstrapSuccess.bind(this))},b.prototype.pull=function(){return this._pullRequest=this.request("GET",this._pullUrl()),this.isConnected()&&(window.clearTimeout(this._pullRequestTimeout),this._pullRequestTimeout=window.setTimeout(this._restartPullRequest,25e3)),this._pullRequest.then(this._handlePullSuccess,this._handlePullError)},b.prototype.push=function(a){var b,c,d,e;if(!(void 0!==a?a.length:void 0))return this.hoodie.resolveWith([]);for(c=[],d=0,e=a.length;e>d;d++)b=a[d],this._addRevisionTo(b),b=this._parseForRemote(b),c.push(b);return this._pushRequest=this.request("POST","/_bulk_docs",{data:{docs:c,new_edits:!1}}),this._pushRequest},b.prototype.sync=function(a){return this.push(a).pipe(this.pull)},b.prototype.on=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1"+this.name+":$2"),this.hoodie.on(a,b)},b.prototype.one=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1"+this.name+":$2"),this.hoodie.one(a,b)},b.prototype.trigger=function(){var a,b,c;return a=arguments[0],b=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],(c=this.hoodie).trigger.apply(c,[""+this.name+":"+a].concat(Array.prototype.slice.call(b)))},b.prototype._validSpecialAttributes=["_id","_rev","_deleted","_revisions","_attachments"],b.prototype._parseForRemote=function(a){var b,c;c=$.extend({},a);for(b in c)if(c.hasOwnProperty(b)){if(-1!==this._validSpecialAttributes.indexOf(b))continue;if(!/^_/.test(b))continue;delete c[b]}return c._id=""+c.type+"/"+c.id,this.prefix&&(c._id=""+this.prefix+c._id),delete c.id,c},b.prototype._parseFromRemote=function(a){var b,c,d;return b=a._id||a.id,delete a._id,this.prefix&&(b=b.replace(new RegExp("^"+this.prefix),"")),d=b.match(/([^\/]+)\/(.*)/),c=d[0],a.type=d[1],a.id=d[2],a},b.prototype._parseAllFromRemote=function(a){var b,c,d,e;for(e=[],c=0,d=a.length;d>c;c++)b=a[c],e.push(this._parseFromRemote(b));return e},b.prototype._addRevisionTo=function(a){var b,c,d,e;try{e=a._rev.split(/-/),c=e[0],b=e[1]}catch(f){}return c=parseInt(c,10)||0,d=this._generateNewRevisionId(),a._$local&&(d+="-local"),a._rev=""+(c+1)+"-"+d,a._revisions={start:1,ids:[d]},b?(a._revisions.start+=c,a._revisions.ids.push(b)):void 0},b.prototype._generateNewRevisionId=function(){return this.hoodie.uuid(9)},b.prototype._mapDocsFromFindAll=function(a){return a.rows.map(function(a){return a.doc})},b.prototype._pullUrl=function(){var a;return a=this.getSinceNr(),this.isConnected()?"/_changes?include_docs=true&since="+a+"&heartbeat=10000&feed=longpoll":"/_changes?include_docs=true&since="+a},b.prototype._restartPullRequest=function(){this._pullRequest&&this._pullRequest.abort()},b.prototype._handlePullSuccess=function(a){return this.setSinceNr(a.last_seq),this._handlePullResults(a.results),this.isConnected()?this.pull():void 0},b.prototype._handlePullError=function(a,b){if(this.isConnected())switch(a.status){case 401:return this.trigger("error:unauthenticated",b),this.disconnect();case 404:return window.setTimeout(this.pull,3e3);case 500:return this.trigger("error:server",b),window.setTimeout(this.pull,3e3),this.hoodie.checkConnection();default:return"abort"===a.statusText?this.pull():(window.setTimeout(this.pull,3e3),this.hoodie.checkConnection())}},b.prototype._handleBootstrapSuccess=function(){this.trigger("bootstrap:end")},b.prototype._handlePullResults=function(a){var b,c,d,e,f,g=[];for(e=0,f=a.length;f>e;e++)if(b=a[e].doc,!this.prefix||0===b._id.indexOf(this.prefix)){if(d=this._parseFromRemote(b),d._deleted){if(!this.isKnownObject(d))continue;c="remove",this.isKnownObject(d)}else this.isKnownObject(d)?c="update":(c="add",this.markAsKnownObject(d));this.trigger(""+c,d),this.trigger(""+c+":"+d.type,d),this.trigger(""+c+":"+d.type+":"+d.id,d),this.trigger("change",c,d),this.trigger("change:"+d.type,c,d),g.push(this.trigger("change:"+d.type+":"+d.id,c,d))}return g},b}(Hoodie.Store),ConnectionError=function(a){function b(a,c){this.message=a,this.data=c,b.__super__.constructor.apply(this,arguments)}return Object.deepExtend(b,a),b.prototype.name="ConnectionError",b}(Error),Hoodie.LocalStore=function(a){function b(a){this.hoodie=a,this.clear=this.clear.bind(this),this.markAllAsChanged=this.markAllAsChanged.bind(this),this._triggerDirtyAndIdleEvents=this._triggerDirtyAndIdleEvents.bind(this),this._handleRemoteChange=this._handleRemoteChange.bind(this),this._startBootstrappingMode=this._startBootstrappingMode.bind(this),this._endBootstrappingMode=this._endBootstrappingMode.bind(this),this._cached={},this._dirty={},this._queue=[],this._promiseApi={hoodie:this.hoodie},this.isPersistent()||(this.db={getItem:function(){return null},setItem:function(){return null},removeItem:function(){return null},key:function(){return null},length:function(){return 0},clear:function(){return null}}),this._subscribeToOutsideEvents(),this._bootstrapDirtyObjects()}return Object.deepExtend(b,a),b.prototype.idleTimeout=2e3,b.prototype.db={getItem:function(a){return window.localStorage.getItem(a)},setItem:function(a,b){return window.localStorage.setItem(a,b)},removeItem:function(a){return window.localStorage.removeItem(a)},key:function(a){return window.localStorage.key(a)},length:function(){return window.localStorage.length},clear:function(){return window.localStorage.clear()}},b.prototype.save=function(a,c,d,e){var f,g,h,i,j,k,l;if(e=e||{},g=b.__super__.save.apply(this,arguments),this.hoodie.isPromise(g))return this._decoratePromise(g);if(this.isBootstrapping())return this._enqueue("save",arguments);if(l=$.extend(!0,{},d),c?(f=this.cache(a,c),j="object"!=typeof f):(j=!0,c=this.hoodie.uuid()),j&&this.hoodie.account&&(l.createdBy=l.createdBy||this.hoodie.account.ownerHash),!j)for(k in f)if(!l.hasOwnProperty(k))switch(k.charAt(0)){case"_":e.remote&&(l[k]=f[k]);break;case"$":e.remote||(l[k]=f[k])}e.remote?l._syncedAt=this._now():e.silent||(l.updatedAt=this._now(),l.createdAt=l.createdAt||l.updatedAt),e.local?l._$local=!0:delete l._$local;try{l=this.cache(a,c,l,e),g.resolve(l,j).promise(),i=j?"add":"update",this._triggerEvents(i,l,e)}catch(m){h=m,g.reject(h).promise()}return this._decoratePromise(g.promise())},b.prototype.find=function(a,c){var d,e,f;if(d=b.__super__.find.apply(this,arguments),this.hoodie.isPromise(d))return this._decoratePromise(d);if(this.isBootstrapping())return this._enqueue("find",arguments);try{f=this.cache(a,c),f||d.reject(Hoodie.Errors.NOT_FOUND(a,c)).promise(),d.resolve(f)}catch(g){e=g,d.reject(e)}return this._decoratePromise(d.promise())},b.prototype.findAll=function(a){var c,d,e,f,g,h,i,j,k;if(null==a&&(a=function(){return!0}),d=b.__super__.findAll.apply(this,arguments),this.hoodie.isPromise(d))return this._decoratePromise(d);if(this.isBootstrapping())return this._enqueue("findAll",arguments);h=this.index(),"string"==typeof a&&(k=a,a=function(a){return a.type===k});try{j=function(){var b,d,e,j;for(j=[],b=0,d=h.length;d>b;b++)g=h[b],this._isSemanticId(g)&&(e=g.split("/"),c=e[0],f=e[1],i=this.cache(c,f),i&&a(i)&&j.push(i));return j}.call(this),j.sort(function(a,b){return a.createdAt>b.createdAt?-1:a.createdAt<b.createdAt?1:0}),d.resolve(j).promise()}catch(l){e=l,d.reject(e).promise()}return this._decoratePromise(d.promise())},b.prototype.remove=function(a,c,d){var e,f,g,h,i;return d=d||{},e=b.__super__.remove.apply(this,arguments),this.hoodie.isPromise(e)?this._decoratePromise(e):this.isBootstrapping()?this._enqueue("remove",arguments):(f=""+a+"/"+c,d.remote&&(this.db.removeItem(f),h=this._cached[f]&&this._isMarkedAsDeleted(this._cached[f]),this._cached[f]=!1,this.clearChanged(a,c),h)?void 0:(g=this.cache(a,c))?(g._syncedAt?(g._deleted=!0,this.cache(a,c,g)):(f=""+a+"/"+c,this.db.removeItem(f),this._cached[f]=!1,this.clearChanged(a,c)),this._triggerEvents("remove",g,d),i=e.resolve(g).promise(),this._decoratePromise(i)):this._decoratePromise(e.reject(Hoodie.Errors.NOT_FOUND(a,c)).promise()))},b.prototype.update=function(){return this._decoratePromise(b.__super__.update.apply(this,arguments))},b.prototype.updateAll=function(){return this._decoratePromise(b.__super__.updateAll.apply(this,arguments))},b.prototype.removeAll=function(){return this._decoratePromise(b.__super__.removeAll.apply(this,arguments))},b.prototype.index=function(){var a,b,c,d,e;for(c=[],a=d=0,e=this.db.length();e>=0?e>d:d>e;a=e>=0?++d:--d)b=this.db.key(a),this._isSemanticId(b)&&c.push(b);return c},b.prototype.cache=function(a,b,c,d){var e;if(void 0===c&&(c=!1),d=d||{},e=""+a+"/"+b,c){if($.extend(c,{type:a,id:b}),this._setObject(a,b,c),d.remote)return this.clearChanged(a,b),this._cached[e]=$.extend(!0,{},c),this._cached[e]}else{if(this._cached[e]===!1)return!1;if(this._cached[e])return $.extend(!0,{},this._cached[e]);if(c=this._getObject(a,b),c===!1)return this.clearChanged(a,b),this._cached[e]=!1,!1}return this._isMarkedAsDeleted(c)?(this.markAsChanged(a,b,c,d),this._cached[e]=!1,!1):(this._cached[e]=$.extend(!0,{},c),this._hasLocalChanges(c)?this.markAsChanged(a,b,this._cached[e],d):this.clearChanged(a,b),$.extend(!0,{},c))},b.prototype.clearChanged=function(a,b){var c;return a&&b?(c=""+a+"/"+b,delete this._dirty[c]):this._dirty={},this._saveDirtyIds(),window.clearTimeout(this._dirtyTimeout)},b.prototype.isMarkedAsDeleted=function(a,b){return this._isMarkedAsDeleted(this.cache(a,b))},b.prototype.markAsChanged=function(a,b,c,d){var e;return d=d||{},e=""+a+"/"+b,this._dirty[e]=c,this._saveDirtyIds(),d.silent?void 0:this._triggerDirtyAndIdleEvents()},b.prototype.markAllAsChanged=function(){var a=this;return this.findAll().pipe(function(b){var c,d,e,f;for(e=0,f=b.length;f>e;e++)d=b[e],c=""+d.type+"/"+d.id,a._dirty[c]=d;a._saveDirtyIds(),a._triggerDirtyAndIdleEvents()})},b.prototype.changedObjects=function(){var a,b,c,d,e,f,g;e=this._dirty,g=[];for(b in e)e.hasOwnProperty(b)&&(c=e[b],f=b.split("/"),d=f[0],a=f[1],c.type=d,c.id=a,g.push(c));return g},b.prototype.hasLocalChanges=function(a,b){return a?this._hasLocalChanges(this.cache(a,b)):!$.isEmptyObject(this._dirty)},b.prototype.clear=function(){var a,b,c,d;a=this.hoodie.defer();try{c=this.index(),d=function(){var a,d,e;for(e=[],a=0,d=c.length;d>a;a++)b=c[a],this._isSemanticId(b)&&e.push(this.db.removeItem(b));return e}.call(this),this._cached={},this.clearChanged(),a.resolve(),this.trigger("clear")}catch(e){a.reject(e)}return a.promise()},b.prototype.isPersistent=function(){try{if(!window.localStorage)return!1;if(localStorage.setItem("Storage-Test","1"),"1"!==localStorage.getItem("Storage-Test"))return!1;localStorage.removeItem("Storage-Test")}catch(a){return!1}return!0},b.prototype.trigger=function(){var a,b,c;return a=arguments[0],b=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],(c=this.hoodie).trigger.apply(c,["store:"+a].concat(Array.prototype.slice.call(b)))},b.prototype.on=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1store:$2"),this.hoodie.on(a,b)},b.prototype.unbind=function(a,b){return a="store:"+a,this.hoodie.unbind(a,b)},b.prototype.decoratePromises=function(a){return $.extend(this._promiseApi,a)},b.prototype._bootstrapping=!1,b.prototype.isBootstrapping=function(){return this._bootstrapping},b.prototype._bootstrapDirtyObjects=function(){var a,b,c,d,e,f,g;if(b=this.db.getItem("_dirty"))for(b=b.split(","),e=0,f=b.length;f>e;e++)g=b[e].split("/"),d=g[0],a=g[1],c=this.cache(d,a)},b.prototype._subscribeToOutsideEvents=function(){this.hoodie.on("account:cleanup",this.clear),this.hoodie.on("account:signup",this.markAllAsChanged),this.hoodie.on("remote:bootstrap:start",this._startBootstrappingMode),this.hoodie.on("remote:bootstrap:end",this._endBootstrappingMode),this.hoodie.on("remote:change",this._handleRemoteChange)},b.prototype._handleRemoteChange=function(a,b){"remove"===a?this.remove(b.type,b.id,{remote:!0}):this.save(b.type,b.id,b,{remote:!0})},b.prototype._setObject=function(a,b,c){var d,e;return d=""+a+"/"+b,e=$.extend({},c),delete e.type,delete e.id,this.db.setItem(d,JSON.stringify(e))},b.prototype._getObject=function(a,b){var c,d;c=""+a+"/"+b;var e=this.db.getItem(c);return e?(d=JSON.parse(e),d.type=a,d.id=b,d):!1},b.prototype._saveDirtyIds=function(){if($.isEmptyObject(this._dirty))return this.db.removeItem("_dirty");var a=Object.keys(this._dirty);return this.db.setItem("_dirty",a.join(","))},b.prototype._now=function(){return JSON.stringify(new Date).replace(/"/g,"")},b.prototype._isValidId=function(a){return new RegExp(/^[a-z0-9\-]+$/).test(a)},b.prototype._isValidType=function(a){return new RegExp(/^[a-z$][a-z0-9]+$/).test(a)},b.prototype._isSemanticId=function(a){return new RegExp(/^[a-z$][a-z0-9]+\/[a-z0-9]+$/).test(a)},b.prototype._hasLocalChanges=function(a){return a.updatedAt?a._syncedAt?a._syncedAt<a.updatedAt:!0:!1},b.prototype._isMarkedAsDeleted=function(a){return a._deleted===!0},b.prototype._triggerEvents=function(a,b,c){this.trigger(a,b,c),this.trigger(""+a+":"+b.type,b,c),"new"!==a&&this.trigger(""+a+":"+b.type+":"+b.id,b,c),this.trigger("change",a,b,c),this.trigger("change:"+b.type,a,b,c),"new"!==a&&this.trigger("change:"+b.type+":"+b.id,a,b,c)},b.prototype._triggerDirtyAndIdleEvents=function(){var a=this;this.trigger("dirty"),window.clearTimeout(this._dirtyTimeout),this._dirtyTimeout=window.setTimeout(function(){a.trigger("idle",a.changedObjects())},this.idleTimeout)},b.prototype._decoratePromise=function(a){return $.extend(a,this._promiseApi)},b.prototype._startBootstrappingMode=function(){this._bootstrapping=!0,this.trigger("bootstrap:start")},b.prototype._endBootstrappingMode=function(){var a,b,c,d;for(this._bootstrapping=!1;this._queue.length>0;)a=this._queue.shift(),b=a[0],c=a[1],d=a[2],this[b].apply(this,c).then(d.resolve,d.reject);this.trigger("bootstrap:end")},b.prototype._enqueue=function(a,b){var c=this.hoodie.defer();return this._queue.push([a,b,c]),c.promise()},b}(Hoodie.Store),Hoodie.AccountRemote=function(a){function b(a,c){this.hoodie=a,c=c||{},this.name=this.hoodie.account.db(),this.connected=!0,c.prefix="",this.push=this.push.bind(this),this.hoodie.on("account:signin",this._handleSignIn.bind(this)),this.hoodie.on("account:reauthenticated",this._connect.bind(this)),this.hoodie.on("account:signout",this.disconnect.bind(this)),this.hoodie.on("reconnected",this.connect.bind(this)),b.__super__.constructor.call(this,this.hoodie,c),this.loadListOfKnownObjectsFromLocalStore()}return Object.deepExtend(b,a),b.prototype.connected=!0,b.prototype.connect=function(){return this.hoodie.account.authenticate().pipe(this._connect.bind(this))},b.prototype.disconnect=function(){return this.hoodie.unbind("store:idle",this.push),b.__super__.disconnect.apply(this,arguments)
},b.prototype.loadListOfKnownObjectsFromLocalStore=function(){var a,b,c,d,e,f,g;for(f=this.hoodie.store.index(),d=0,e=f.length;e>d;d++)b=f[d],g=b.split(/\//),c=g[0],a=g[1],this.markAsKnownObject({type:c,id:a})},b.prototype.getSinceNr=function(){return this.hoodie.config.get("_remote.since")||0},b.prototype.setSinceNr=function(a){return this.hoodie.config.set("_remote.since",a)},b.prototype.push=function(a){if(!this.isConnected()){var c=new window.ConnectionError("Not connected: could not push local changes to remote");return this.hoodie.rejectWith(c)}$.isArray(a)||(a=this.hoodie.store.changedObjects());var d=b.__super__.push.apply(this,[a]);return d.fail(this.hoodie.checkConnection),d},b.prototype.on=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1remote:$2"),this.hoodie.on(a,b)},b.prototype.one=function(a,b){return a=a.replace(/(^| )([^ ]+)/g,"$1remote:$2"),this.hoodie.one(a,b)},b.prototype.trigger=function(){var a,b,c;return a=arguments[0],b=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],(c=this.hoodie).trigger.apply(c,["remote:"+a].concat(Array.prototype.slice.call(b)))},b.prototype._connect=function(){return this.connected=!0,this.hoodie.on("store:idle",this.push),this.sync()},b.prototype._handleSignIn=function(){return this.name=this.hoodie.account.db(),this._connect()},b}(Hoodie.Remote);