//  hoodie 0.3.0
function hoodieEvents(a){function b(a,b){var c,d,e,g;for(c=a.split(" "),e=0,g=c.length;g>e;e++)d=c[e],f[d]=f[d]||[],f[d].push(b)}function c(a,c){b(a,function(){e(a,c),c.apply(null,arguments)})}function d(){var a,b,c,d,e,g;if(a=1<=arguments.length?Array.prototype.slice.call(arguments,0):[],c=a.shift(),d=f[c]){for(e=0,g=d.length;g>e;e++)b=d[e],b.apply(null,a);return!0}}function e(a,b){var c,d,e,g,h;if(!a)return f={},void 0;if(e=f[a]){if(!b)return delete f[a],void 0;for(d=g=0,h=e.length;h>g;d=++g)if(c=e[d],c===b){e=e.slice(),e.splice(d,1),f[a]=e;break}}}var f={};a.bind=b,a.on=b,a.one=c,a.trigger=d,a.unbind=e,a.off=e}function hoodiePromises(a){function b(a){return!(!a||"function"!=typeof a.done||"function"==typeof a.resolve)}function c(){return g().resolve().promise()}function d(){return g().reject().promise()}function e(){var a=g();return a.resolve.apply(a,arguments).promise()}function f(){var a=g();return a.reject.apply(a,arguments).promise()}var g=window.jQuery.Deferred;a.defer=g,a.isPromise=b,a.resolve=c,a.reject=d,a.resolveWith=e,a.rejectWith=f}function hoodieRequest(a){function b(b,f,g){var h,i,j;return g=g||{},/^http/.test(f)||(f=""+a.baseUrl+f),h={type:b,url:f,xhrFields:{withCredentials:!0},crossDomain:!0,dataType:"json"},i=e(d(h,g)),j=i.then(null,c),j.abort=i.abort,j}function c(b){var c;try{c=JSON.parse(b.responseText)}catch(d){c={error:b.responseText||"Cannot connect to Hoodie server at "+a.baseUrl}}return a.rejectWith(c).promise()}var d=$.extend,e=$.ajax;a.request=b}function hoodieConnection(a){"use strict";function b(){return e=3e4,window.setTimeout(a.checkConnection,e),a.isOnline()||(a.trigger("reconnected"),d=!0),a.resolve()}function c(){return e=3e3,window.setTimeout(a.checkConnection,e),a.isOnline()&&(a.trigger("disconnected"),d=!1),a.reject()}var d=!0,e=3e4,f=null;a.checkConnection=function(){var d=f;return d&&"pending"===d.state()?d:f=a.request("GET","/").then(b,c)},a.isOnline=function(){return d}}function hoodieUUID(a){function b(a){var b,c,d;return void 0===a&&(a=7),b="0123456789abcdefghijklmnopqrstuvwxyz".split(""),d=b.length,function(){var e,f=[];for(c=e=0;a>=0?a>e:e>a;c=a>=0?++e:--e){var g=Math.random()*d;f.push(b[0]=String(g).charAt(0))}return f}().join("")}a.uuid=b}function hoodieDispose(a){function b(){a.trigger("dispose"),a.unbind()}a.dispose=b}function hoodieOpen(a){function b(b,d){return d=d||{},c(d,{name:b}),hoodieRemoteStore(a,d)}var c=window.jQuery.extend;a.open=b}function hoodieStoreApi(a,b){function c(a){return new RegExp(/^[^\/]+$/).test(a||"")}function d(a){return new RegExp(/^[^\/]+$/).test(a||"")}function e(a){return $.extend(a,j)}function f(){var b=a.resolveWith.apply(null,arguments);return e(b)}function g(){var b=a.rejectWith.apply(null,arguments);return e(b)}var h={},i={},j={hoodie:a},k=b.name||"store";if(h.validate=b.validate,b.validate||(h.validate=function(a){if(!a)return Hoodie.Errors.INVALID_ARGUMENTS("no object passed");if(!d(a.type))return Hoodie.Errors.INVALID_KEY({type:a.type});if(a.id)return c(a.id)?void 0:Hoodie.Errors.INVALID_KEY({id:a.id})}),h.save=function(a,b,c,d){d=d?$.extend(!0,{},d):{};var f=$.extend(!0,{},c,{type:a,id:b}),j=h.validate(f,d||{});return j?g(j):e(i.save(f,d||{}))},h.add=function(a,b,c){return void 0===b&&(b={}),c=c||{},h.save(a,b.id,b)},h.find=function(a,b){return e(i.find(a,b))},h.findOrAdd=function(a,b,c){function d(){var d;return d=$.extend(!0,{id:b},c),h.add(a,d)}null===c&&(c={});var f=h.find(a,b).then(null,d);return e(f)},h.findAll=function(a,b){return e(i.findAll(a,b))},h.update=function(a,b,c,d){function g(e){var g,i,j;return i=$.extend(!0,{},e),"function"==typeof c&&(c=c(i)),c?(g=function(){var a=[];for(var b in c)if(c.hasOwnProperty(b)){if(j=c[b],e[b]!==j==!1)continue;i[b]=j,a.push(b)}return a}(),g.length||d?h.save(a,b,i,d):f(i)):f(e)}function i(){return h.save(a,b,c,d)}var j=h.find(a,b).then(g,i);return e(j)},h.updateAll=function(b,c,d){var f;switch(d=d||{},!0){case"string"==typeof b:f=h.findAll(b);break;case a.isPromise(b):f=b;break;case $.isArray(b):f=a.defer().resolve(b).promise();break;default:f=h.findAll()}return f=f.then(function(a){var b,e;return $.isArray(a)||(a=[a]),e=function(){var e,f,g;for(g=[],e=0,f=a.length;f>e;e++)b=a[e],g.push(h.update(b.type,b.id,c,d));return g}(),$.when.apply(null,e)}),e(f)},h.remove=function(a,b,c){return e(i.remove(a,b,c||{}))},h.removeAll=function(a,b){return e(i.removeAll(a,b||{}))},h.decoratePromises=function(a){return $.extend(j,a)},h.trigger=function(){var b,c,d;return b=arguments[0],c=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],(d=a).trigger.apply(d,[k+":"+b].concat(Array.prototype.slice.call(c)))},h.on=function(b,c){return b=b.replace(/(^| )([^ ]+)/g,"$1"+k+":$2"),a.on(b,c)},h.unbind=function(b,c){return b=k+":"+b,a.unbind(b,c)},!b.backend)throw new Error("options.backend must be passed");var l="save find findAll remove removeAll".split(" ");return l.forEach(function(a){if(!b.backend[a])throw new Error("options.backend."+a+" must be passed.");i[a]=b.backend[a]}),h}function hoodieRemoteStore(a,b){function c(a){return r=a,q.trigger("pull",r),r}function d(a){var b,c;c=$.extend({},a);for(b in c)if(c.hasOwnProperty(b)){if(-1!==w.indexOf(b))continue;if(!/^_/.test(b))continue;delete c[b]}return c._id=""+c.type+"/"+c.id,q.prefix&&(c._id=""+q.prefix+c._id),delete c.id,c}function e(a){var b,c,d;return b=a._id||a.id,delete a._id,q.prefix&&(b=b.replace(new RegExp("^"+q.prefix),"")),d=b.match(/([^\/]+)\/(.*)/),c=d[0],a.type=d[1],a.id=d[2],a}function f(a){var b,c,d,f;for(f=[],c=0,d=a.length;d>c;c++)b=a[c],f.push(e(b));return f}function g(a){var b,c,d,e;try{e=a._rev.split(/-/),c=e[0],b=e[1]}catch(f){}return c=parseInt(c,10)||0,d=h(),a._$local&&(d+="-local"),a._rev=""+(c+1)+"-"+d,a._revisions={start:1,ids:[d]},b?(a._revisions.start+=c,a._revisions.ids.push(b)):void 0}function h(){return a.uuid(9)}function i(a){return a.rows.map(function(a){return a.doc})}function j(){var a;return a=q.getSinceNr(),q.isConnected()?"/_changes?include_docs=true&since="+a+"&heartbeat=10000&feed=longpoll":"/_changes?include_docs=true&since="+a}function k(){s&&s.abort()}function l(a){return c(a.last_seq),o(a.results),q.isConnected()?q.pull():void 0}function m(b,c){if(q.isConnected())switch(b.status){case 401:return q.trigger("error:unauthenticated",c),q.disconnect();case 404:return window.setTimeout(q.pull,3e3);case 500:return q.trigger("error:server",c),window.setTimeout(q.pull,3e3),a.checkConnection();default:return"abort"===b.statusText?q.pull():(window.setTimeout(q.pull,3e3),a.checkConnection())}}function n(){q.trigger("bootstrap:end")}function o(a){var b,c,d,f,g;for(f=0,g=a.length;g>f;f++)if(b=a[f].doc,!q.prefix||0===b._id.indexOf(q.prefix)){if(d=e(b),d._deleted){if(!q.isKnownObject(d))continue;c="remove",q.isKnownObject(d)}else q.isKnownObject(d)?c="update":(c="add",q.markAsKnownObject(d));q.trigger(c,d),q.trigger(c+":"+d.type,d),q.trigger(c+":"+d.type+":"+d.id,d),q.trigger("change",c,d),q.trigger("change:"+d.type,c,d),q.trigger("change:"+d.type+":"+d.id,c,d)}}var p={};p.find=function(a,b){var c;return c=a+"/"+b,q.prefix&&(c=q.prefix+c),c="/"+encodeURIComponent(c),q.request("GET",c).then(e)},p.findAll=function(a){var b,c,d;switch(c="/_all_docs?include_docs=true",!0){case void 0!==a&&""!==q.prefix:d=q.prefix+a+"/";break;case void 0!==a:d=a+"/";break;case""!==q.prefix:d=q.prefix;break;default:d=""}return d&&(b=d.replace(/.$/,function(a){var b;return b=a.charCodeAt(0),String.fromCharCode(b+1)}),c=""+c+'&startkey="'+encodeURIComponent(d)+'"&endkey="'+encodeURIComponent(b)+'"'),q.request("GET",c).then(i).then(f)},p.save=function(b){var c;return b.id||(b.id=a.uuid()),b=d(b),c="/"+encodeURIComponent(b._id),q.request("PUT",c,{data:b})},p.remove=function(a,b){return q.update(a,b,{_deleted:!0})},p.removeAll=function(a){return q.updateAll(a,{_deleted:!0})};var q=hoodieStoreApi(a,{name:b.name,backend:{save:p.save,find:p.find,findAll:p.findAll,remove:p.remove,removeAll:p.removeAll}});q.name=null,q.connected=!1,q.prefix="",void 0!==b.name&&(q.name=b.name),void 0!==b.prefix&&(q.prefix=b.prefix),null!==b.baseUrl&&(q.baseUrl=b.baseUrl),q.request=function(b,c,d){return d=d||{},q.name&&(c="/"+encodeURIComponent(q.name)+c),q.baseUrl&&(c=""+q.baseUrl+c),d.contentType=d.contentType||"application/json",("POST"===b||"PUT"===b)&&(d.dataType=d.dataType||"json",d.processData=d.processData||!1,d.data=JSON.stringify(d.data)),a.request(b,c,d)},q.isKnownObject=function(a){var b=""+a.type+"/"+a.id;return void 0!==v[b]?v[b]:void 0},q.markAsKnownObject=function(a){var b=""+a.type+"/"+a.id;return v[b]=1,v[b]},q.connect=function(){return q.connected=!0,q.trigger("connect"),q.bootstrap()},q.disconnect=function(){q.connected=!1,q.trigger("disconnect"),s&&s.abort(),u&&u.abort()},q.isConnected=function(){return q.connected};var r=b.since||0;q.getSinceNr=function(){return r},q.bootstrap=function(){return q.trigger("bootstrap:start"),q.pull().done(n.bind(this))};var s,t;q.pull=function(){return s=q.request("GET",j()),q.isConnected()&&(window.clearTimeout(t),t=window.setTimeout(k,25e3)),s.then(l,m)};var u;q.push=function(b){var c,e,f,h;if($.isArray(b)||(b=x()),0===b.length)return a.resolveWith([]);for(e=[],f=0,h=b.length;h>f;f++)c=b[f],g(c),c=d(c),e.push(c);return u=q.request("POST","/_bulk_docs",{data:{docs:e,new_edits:!1}})},q.sync=function(a){return q.push(a).then(q.pull)};var v={},w=["_id","_rev","_deleted","_revisions","_attachments"],x=function(){return[]};if(b.defaultObjectsToPush&&(x=$.isArray(b.defaultObjectsToPush)?function(){return b.defaultObjectsToPush}:b.defaultObjectsToPush),b.knownObjects)for(var y=0;y<b.knownObjects.length;y++)q.markAsKnownObject({type:b.knownObjects[y].type,id:b.knownObjects[y].id});return q}function hoodieStore(a){function b(a,b){return o(a)?arguments.length>0&&!n(b)?Hoodie.Errors.INVALID_KEY({id:b}):void 0:Hoodie.Errors.INVALID_KEY({type:a})}function c(a,b,c,d){var e;if(void 0===c&&(c=!1),d=d||{},e=""+a+"/"+b,c){if($.extend(c,{type:a,id:b}),j(a,b,c),d.remote)return g(a,b),z[e]=$.extend(!0,{},c),z[e]}else{if(z[e]===!1)return!1;if(z[e])return $.extend(!0,{},z[e]);if(c=k(a,b),c===!1)return g(a,b),z[e]=!1,!1}return r(c)?(f(a,b,c,d),z[e]=!1,!1):(z[e]=$.extend(!0,{},c),q(c)?f(a,b,z[e],d):g(a,b),$.extend(!0,{},c))}function d(){var a,b,d,e,f,g,h;if(b=F.getItem("_dirty"))for(b=b.split(","),f=0,g=b.length;g>f;f++)h=b[f].split("/"),e=h[0],a=h[1],d=c(e,a)}function e(){a.on("account:cleanup",D.clear),a.on("account:signup",h),a.on("remote:bootstrap:start",u),a.on("remote:bootstrap:end",v),a.on("remote:change",i)}function f(a,b,c,d){var e;return d=d||{},e=""+a+"/"+b,A[e]=c,l(),d.silent?void 0:t()}function g(a,b){var c;return a&&b?(c=""+a+"/"+b,delete A[c]):A={},l(),window.clearTimeout(G)}function h(){return D.findAll().pipe(function(a){var b,c,d,e;for(d=0,e=a.length;e>d;d++)c=a[d],b=""+c.type+"/"+c.id,A[b]=c;l(),t()})}function i(a,b){"remove"===a?D.remove(b.type,b.id,{remote:!0}):D.save(b.type,b.id,b,{remote:!0})}function j(a,b,c){var d,e;return d=""+a+"/"+b,e=$.extend({},c),delete e.type,delete e.id,F.setItem(d,JSON.stringify(e))}function k(a,b){var c,d;c=""+a+"/"+b;var e=F.getItem(c);return e?(d=JSON.parse(e),d.type=a,d.id=b,d):!1}function l(){try{if($.isEmptyObject(A))F.removeItem("_dirty");else{var a=Object.keys(A);F.setItem("_dirty",a.join(","))}}catch(b){}}function m(){return JSON.stringify(new Date).replace(/['"]/g,"")}function n(a){return new RegExp(/^[a-z0-9\-]+$/).test(a)}function o(a){return new RegExp(/^[a-z$][a-z0-9]+$/).test(a)}function p(a){return new RegExp(/^[a-z$][a-z0-9]+\/[a-z0-9]+$/).test(a)}function q(a){return a.updatedAt?a._syncedAt?a._syncedAt<a.updatedAt:!0:!1}function r(a){return a._deleted===!0}function s(a,b,c){D.trigger(a,b,c),D.trigger(""+a+":"+b.type,b,c),"new"!==a&&D.trigger(""+a+":"+b.type+":"+b.id,b,c),D.trigger("change",a,b,c),D.trigger("change:"+b.type,a,b,c),"new"!==a&&D.trigger("change:"+b.type+":"+b.id,a,b,c)}function t(){D.trigger("dirty"),window.clearTimeout(G),G=window.setTimeout(function(){D.trigger("idle",D.changedObjects())},C)}function u(){E=!0,D.trigger("bootstrap:start")}function v(){var a,b,c,d;for(E=!1;B.length>0;)a=B.shift(),b=a[0],c=a[1],d=a[2],D[b].apply(D,c).then(d.resolve,d.reject);D.trigger("bootstrap:end")}function w(b,c){var d=a.defer();return B.push([b,c,d]),d.promise()}function x(){D.isPersistent()||(F={getItem:function(){return null},setItem:function(){return null},removeItem:function(){return null},key:function(){return null},length:function(){return 0}})}var y={},z={},A={},B=[],C=2e3;y.save=function(b,d){var e,f,g,h,i,j;if(d=d||{},D.isBootstrapping())return w("save",arguments);if(b.id?(e=c(b.type,b.id),i="object"!=typeof e):(i=!0,b.id=a.uuid()),i?b.createdBy=b.createdBy||a.account.ownerHash:e.createdBy&&(b.createdBy=e.createdBy),!i)for(j in e)if(!b.hasOwnProperty(j))switch(j.charAt(0)){case"_":d.remote&&(b[j]=e[j]);break;case"$":d.remote||(b[j]=e[j])}d.remote?b._syncedAt=m():d.silent||(b.updatedAt=m(),b.createdAt=b.createdAt||b.updatedAt),d.local?b._$local=!0:delete b._$local,f=a.defer();try{b=c(b.type,b.id,b,d),f.resolve(b,i).promise(),h=i?"add":"update",s(h,b,d)}catch(k){g=k,f.reject(g.toString())}return f.promise()},y.find=function(b,d){var e,f,g;if(e=a.defer(),D.isBootstrapping())return w("find",arguments);try{g=c(b,d),g||e.reject(Hoodie.Errors.NOT_FOUND(b,d)).promise(),e.resolve(g)}catch(h){f=h,e.reject(f)}return e.promise()},y.findAll=function(b){var d,e,f,g,h,i,j,k,l;if(null==b&&(b=function(){return!0}),D.isBootstrapping())return w("findAll",arguments);i=D.index(),"string"==typeof b&&(l=b,b=function(a){return a.type===l}),e=a.defer();try{k=function(){var a,e,f,k;for(k=[],a=0,e=i.length;e>a;a++)h=i[a],p(h)&&(f=h.split("/"),d=f[0],g=f[1],j=c(d,g),j&&b(j)&&k.push(j));return k}.call(this),k.sort(function(a,b){return a.createdAt>b.createdAt?-1:a.createdAt<b.createdAt?1:0}),e.resolve(k).promise()}catch(m){f=m,e.reject(f).promise()}return e.promise()},y.remove=function(b,d,e){var f,h,i;return e=e||{},D.isBootstrapping()?w("remove",arguments):(f=b+"/"+d,h=c(b,d),e.remote&&(F.removeItem(f),i=z[f]&&r(z[f]),z[f]=!1,g(b,d),i&&h)?a.resolveWith(h):h?(h._syncedAt?(h._deleted=!0,c(b,d,h)):(f=b+"/"+d,F.removeItem(f),z[f]=!1,g(b,d)),s("remove",h,e),a.resolveWith(h)):a.rejectWith(Hoodie.Errors.NOT_FOUND(b,d)))},y.removeAll=function(a,b){return D.findAll(a).then(function(a){var c,d,e,f;for(f=[],d=0,e=a.length;e>d;d++)c=a[d],f.push(D.remove(c.type,c.id,b));return f})};var D=hoodieStoreApi(a,{validate:b,backend:{save:y.save,find:y.find,findAll:y.findAll,remove:y.remove,removeAll:y.removeAll}});D.index=function(){var a,b,c,d,e;for(c=[],a=d=0,e=F.length();e>=0?e>d:d>e;a=e>=0?++d:--d)b=F.key(a),p(b)&&c.push(b);return c},D.changedObjects=function(){var a,b,c,d,e,f,g;e=A,g=[];for(b in e)e.hasOwnProperty(b)&&(c=e[b],f=b.split("/"),d=f[0],a=f[1],c.type=d,c.id=a,g.push(c));return g},D.hasLocalChanges=function(a,b){if(!a)return!$.isEmptyObject(A);var d=[a,b].join("/");return A[d]?!0:q(c(a,b))},D.clear=function(){var b,c,d,e;b=a.defer();try{d=D.index(),e=function(){var a,b,e;for(e=[],a=0,b=d.length;b>a;a++)c=d[a],p(c)&&e.push(F.removeItem(c));return e}.call(this),z={},g(),b.resolve(),D.trigger("clear")}catch(f){b.reject(f)}return b.promise()};var E=!1;D.isBootstrapping=function(){return E},D.isPersistent=function(){try{if(!window.localStorage)return!1;if(localStorage.setItem("Storage-Test","1"),"1"!==localStorage.getItem("Storage-Test"))return!1;localStorage.removeItem("Storage-Test")}catch(a){return!1}return!0};var F={getItem:function(a){return window.localStorage.getItem(a)},setItem:function(a,b){return window.localStorage.setItem(a,b)},removeItem:function(a){return window.localStorage.removeItem(a)},key:function(a){return window.localStorage.key(a)},length:function(){return window.localStorage.length}};D.subscribeToOutsideEvents=function(){e(),delete D.subscribeToOutsideEvents};var G;a.store=D,D.bootstrapDirtyObjects=function(){d(),delete D.bootstrapDirtyObjects},D.patchIfNotPersistant=function(){x(),delete D.patchIfNotPersistant}}function hoodieConfig(a){var b="$config",c="hoodie",d={},e={};e.set=function(e,f){var g,h;if(d[e]!==f)return d[e]=f,h={},h[e]=f,g="_"===e.charAt(0),a.store.update(b,c,h,{silent:g})},e.get=function(a){return d[a]},e.clear=function(){return d={},a.store.remove(b,c)},e.remove=function(a){return e.set(a,void 0)},a.store.find(b,c).done(function(a){d=a}),a.config=e}function hoodieAccount(a){function b(b){return a.config.set(I,b)}function c(){return a.config.get(I)}function d(){return a.config.remove(I)}function e(b){return E.username!==b?(E.username=b,a.config.set("_account.username",b)):void 0}function f(b){return E.ownerHash!==b?(E.ownerHash=b,a.config.set("createdBy",b),a.config.set("_account.ownerHash",b)):void 0}function g(b){return b.userCtx.name?(D=!0,e(b.userCtx.name.replace(/^user(_anonymous)?\//,"")),f(b.userCtx.roles[0]),a.resolveWith(E.username)):E.hasAnonymousAccount()?E.signIn(E.username,c()):(D=!1,E.trigger("error:unauthenticated"),a.reject())}function h(b){var c;if(b=b||{},b.reason)return a.rejectWith(b);var d=b;try{b=JSON.parse(d.responseText)}catch(e){c=e,b={error:d.responseText||"unknown"}}return a.rejectWith(b)}function i(a,b){return function(c){return E.trigger("signup",a),F._rev=c.rev,j(a,b)}}function j(b,c,d,e){return e||(e=a.defer()),window.setTimeout(function(){var a=B(b,c);a.done(e.resolve),a.fail(function(a){"unconfirmed"===a.error?j(b,c,d,e):e.reject.apply(e,arguments)})},300),e.promise()}function k(b){return b=b||{},function(c){var d,g;return d=a.defer(),g=c.name.replace(/^user(_anonymous)?\//,""),-1!==c.roles.indexOf("error")?(E.fetch(g).fail(d.reject).done(function(){return d.reject({error:"error",reason:F.$error})}),d.promise()):-1===c.roles.indexOf("confirmed")?d.reject({error:"unconfirmed",reason:"account has not been confirmed yet"}):(e(g),f(c.roles[0]),D=!0,b.silent||b.reauthenticated||(E.hasAnonymousAccount()?E.trigger("signin:anonymous",g):E.trigger("signin",g)),b.reauthenticated&&E.trigger("reauthenticated",g),E.fetch(),d.resolve(g,c.roles[0]))}}function l(b){var c;return c=b.$error?b.$error:{error:"pending"},a.rejectWith(c)}function m(b){return 401===b.status?(a.config.remove("_account.resetPasswordId"),E.trigger("passwordreset"),a.resolve()):h(b)}function n(a,b,c){return B(E.username,a,{silent:!0}).then(function(){return E.fetch().then(w(a,b,c))})}function o(a,b){var e;return e=c(),n(e,a,b).done(function(){E.trigger("signup",a),d()})}function p(){return a.remote.disconnect(),F._deleted=!0,y("updateUsersDoc",function(){E.request("PUT",v(),{data:JSON.stringify(F),contentType:"application/json"})})}function q(b){return"not_found"===b.error?a.resolve():a.rejectWith(b)}function r(b){return b=b||{},E.trigger("cleanup"),D=b.authenticated,a.config.clear(),e(b.username),f(b.ownerHash||a.uuid()),a.resolve()}function s(){return r().then(function(){return E.trigger("signout")})}function t(a){var b;return b=a===E.ownerHash?"user_anonymous":"user",""+b+"/"+a}function u(a){return a=a||E.username,""+H+":"+t(a)}function v(a){return"/_users/"+encodeURIComponent(u(a))}function w(a,b,c){return function(){var d=$.extend({},F);b&&(d.$newUsername=b),d.updatedAt=C(),d.signedUpAt=d.signedUpAt||C(),null!==c&&(delete d.salt,delete d.password_sha,d.password=c);var e={data:JSON.stringify(d),contentType:"application/json"};return y("updateUsersDoc",function(){return E.request("PUT",v(),e).then(x(b,c||a),h)})}}function x(b,c){return function(){return a.remote.disconnect(),b?j(b,c,{silent:!0}):E.signIn(E.username,c)}}function y(a,b){return void 0!==G[a]&&"function"==typeof G[a].abort&&G[a].abort(),G[a]=b(),G[a]}function z(a,b){return void 0!==G[a]&&"function"==typeof G[a].state&&"pending"===G[a].state()?G[a]:(G[a]=b(),G[a])}function A(){return z("signOut",function(){return E.request("DELETE","/_session").then(null,h)})}function B(a,b,c){var d={data:{name:t(a),password:b}};return y("signIn",function(){var a=E.request("POST","/_session",d);return a.then(k(c),h)})}function C(){return new Date}var D,E={},F={},G={},H="org.couchdb.user";E.authenticate=function(){var b;return D===!1?a.reject():D===!0?a.resolveWith(E.username):G.signOut&&"pending"===G.signOut.state()?G.signOut.then(a.rejectWith):G.signIn&&"pending"===G.signIn.state()?G.signIn:void 0===E.username?A().then(function(){return D=!1,a.reject()}):(b=function(){return E.request("GET","/_session").then(g,h)},z("authenticate",b))},E.signUp=function(b,c){if(void 0===c&&(c=""),!b)return a.rejectWith({error:"username must be set"});if(E.hasAnonymousAccount())return o(b,c);if(E.hasAccount())return a.rejectWith({error:"you have to sign out first"});b=b.toLowerCase();var d={data:JSON.stringify({_id:u(b),name:t(b),type:"user",roles:[],password:c,ownerHash:E.ownerHash,database:E.db(),updatedAt:C(),createdAt:C(),signedUpAt:b!==E.ownerHash?C():void 0}),contentType:"application/json"};return E.request("PUT",v(b),d).then(i(b,c),h)},E.anonymousSignUp=function(){var c,d;return c=a.uuid(10),d=E.ownerHash,E.signUp(d,c).done(function(){return b(c),E.trigger("signup:anonymous",d)})},E.hasAccount=function(){return!!E.username},E.hasAnonymousAccount=function(){return void 0!==c()};var I="_account.anonymousPassword";E.signIn=function(a,b){return null===a&&(a=""),void 0===b&&(b=""),a=a.toLowerCase(),a!==E.username?E.signOut({silent:!0}).then(function(){return B(a,b)}):B(a,b,{reauthenticated:!0})},E.signOut=function(b){return b=b||{},E.hasAccount()?(a.remote.disconnect(),A().then(s)):r().then(function(){return b.silent?void 0:E.trigger("signout")})},E.on=function(b,c){return b=b.replace(/(^| )([^ ]+)/g,"$1account:$2"),a.on(b,c)},E.trigger=function(){var b,c;b=arguments[0],c=2<=arguments.length?Array.prototype.slice.call(arguments,1):[],a.trigger.apply(a,["account:"+b].concat(Array.prototype.slice.call(c)))},E.request=function(b,c,d){return d=d||{},a.request.apply(a,arguments)},E.db=function(){return"user/"+E.ownerHash},E.fetch=function(b){return void 0===b&&(b=E.username),b?z("fetch",function(){return E.request("GET",v(b)).then(null,h).done(function(a){return F=a})}):a.rejectWith({error:"unauthenticated",reason:"not logged in"})},E.changePassword=function(b,c){return E.username?(a.remote.disconnect(),E.fetch().then(w(b,null,c),h)):a.rejectWith({error:"unauthenticated",reason:"not logged in"})},E.resetPassword=function(b){var c,d,e,f;return(f=a.config.get("_account.resetPasswordId"))?E.checkPasswordReset():(f=""+b+"/"+a.uuid(),a.config.set("_account.resetPasswordId",f),d=""+H+":$passwordReset/"+f,c={_id:d,name:"$passwordReset/"+f,type:"user",roles:[],password:f,createdAt:C(),updatedAt:C()},e={data:JSON.stringify(c),contentType:"application/json"},y("resetPassword",function(){return E.request("PUT","/_users/"+encodeURIComponent(d),e).then(null,h).done(E.checkPasswordReset)}))},E.checkPasswordReset=function(){var b,c,d,e,f;return(d=a.config.get("_account.resetPasswordId"))?(f="$passwordReset/"+d,e="/_users/"+encodeURIComponent(H+":"+f),b=btoa(f+":"+d),c={headers:{Authorization:"Basic "+b}},y("passwordResetStatus",function(){return E.request("GET",e,c).then(l,m).fail(function(a){return"pending"===a.error?(window.setTimeout(E.checkPasswordReset,1e3),void 0):E.trigger("password_reset:error")})})):a.rejectWith({error:"missing"})},E.changeUsername=function(a,b){return b=b||"",n(a,b.toLowerCase())},E.destroy=function(){return E.hasAccount()?E.fetch().then(p,q).then(s):s()},a.account=E,a.account.ownerHash||f(a.uuid())}function hoodieRemote(a){function b(){c.on("disconnect",function(){a.unbind("store:idle",c.push)}),c.on("connect",function(){a.on("store:idle",c.push)}),c.on("pull",function(b){a.config.set("_remote.since",b)}),a.on("reconnected",c.connect),a.on("account:signin",function(){return c.name=a.account.db(),c.connect()}),a.on("account:reauthenticated",c.connect),a.on("account:signout",c.disconnect)}var c=a.open(a.account.db(),{connected:!0,prefix:"",since:a.config.get("_remote.since")||0,defaultObjectsToPush:a.store.changedObjects,knownObjects:a.store.index().map(function(a){var b=a.split(/\//);return{type:b[0],id:b[1]}})});c.subscribeToEvents=function(){b(),delete c.subscribeToEvents},a.remote=c}!function(a){"use strict";function b(a){var d=this;if(!(d instanceof b))throw new Error("usage: new Hoodie(url);");d.baseUrl=a?a.replace(/\/+$/,""):"/_api",d.extend=function(a){a(d)},d.extend(hoodieEvents),d.extend(hoodiePromises),d.extend(hoodieRequest),d.extend(hoodieConnection),d.extend(hoodieUUID),d.extend(hoodieDispose),d.extend(hoodieOpen),d.extend(hoodieStore),d.extend(hoodieConfig),d.extend(hoodieAccount),d.extend(hoodieRemote),c(d),d.account.username=d.config.get("_account.username"),d.account.ownerHash=d.config.get("_account.ownerHash"),d.account.checkPasswordReset(),d.on("account:signout",d.config.clear),d.store.patchIfNotPersistant(),d.store.subscribeToOutsideEvents(),d.store.bootstrapDirtyObjects(),d.remote.loadListOfKnownObjectsFromLocalStore(),d.remote.subscribeToEvents(),d.account.authenticate().then(d.remote.connect)}function c(a){for(var b=0;b<d.length;b++)d[b](a)}var d=[];b.extend=function(a){d.push(a)},"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=b:"function"==typeof define&&define.amd?define("hoodie",[],function(){return b}):a.Hoodie=b}(window),Hoodie.Errors={INVALID_KEY:function(a){var b=a.id?"id":"type";return new Error("invalid "+b+"'"+a[b]+"': numbers and lowercase letters allowed only")},INVALID_ARGUMENTS:function(a){return new Error(a)},NOT_FOUND:function(a,b){return new Error(""+a+" with "+b+" could not be found")}};