<!DOCTYPE html>  <html> <head>   <title>remote.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="account.html">                 account.coffee               </a>                                           <a class="source" href="hoodie.html">                 hoodie.coffee               </a>                                           <a class="source" href="instance.html">                 instance.coffee               </a>                                           <a class="source" href="remote.html">                 remote.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               remote.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Remote patched for Sharing.</p>

<p>The only difference is the pull URL, it adds a filter to assure that
only documents get pulled that belong to the sharing. This is importent
when an object gets removed from the sharing, by removing the sharing id
from the objects $sharings array and deleting the object. The filter
avoids that the deletion will be synchronized through the _changes feed.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">define</span> <span class="s1">&#39;hoodie/sharing/remote&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;hoodie/remote&#39;</span><span class="p">],</span> <span class="nf">(Remote) -&gt;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>'use strict'</p>             </td>             <td class="code">               <div class="highlight"><pre>  </pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>needs to to have the same name due to hoodie's loading mechanism
see: Hoodie::<em>load</em>modules</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">class</span> <span class="nx">Remote</span> <span class="k">extends</span> <span class="nx">Remote</span>
    </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>we only want to push stuff that belongs to this sharing</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">push : </span><span class="p">(</span><span class="nx">docs</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">unless</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">docs</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>walk through all changed docs, check if it's
1. the sharing object itself or
2. an object belonging to the sharing</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">docs = </span><span class="k">for</span> <span class="nx">obj</span> <span class="k">in</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">changed_docs</span><span class="p">()</span> <span class="k">when</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">id</span> <span class="o">is</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">sharing</span><span class="p">.</span><span class="nx">id</span> <span class="o">or</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$sharings</span> <span class="o">and</span> <span class="o">~</span><span class="nx">obj</span><span class="p">.</span><span class="nx">$sharings</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">@hoodie</span><span class="p">.</span><span class="nx">sharing</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
          <span class="nx">obj</span> 

      <span class="k">super</span><span class="p">(</span><span class="nx">docs</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>pull url</p>

<p>The pull URL has an addition filter to only pull for the documents
that belong to the sharing, see above</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">_pull_url : </span><span class="o">-&gt;</span>
      <span class="nv">since = </span><span class="nx">@hoodie</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;_remote.seq&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="mi">0</span>
      <span class="k">if</span> <span class="nx">@active</span> <span class="c1"># make a long poll request</span>
        <span class="s2">&quot;/#{encodeURIComponent @hoodie.account.db()}/_changes?filter=%24sharing_#{@hoodie.sharing.id}/owned&amp;include_docs=true&amp;since=#{since}&amp;heartbeat=10000&amp;feed=longpoll&quot;</span>
      <span class="k">else</span>
        <span class="s2">&quot;/#{encodeURIComponent @hoodie.account.db()}/_changes?filter=%24sharing_#{@hoodie.sharing.id}/owned&amp;include_docs=true&amp;since=#{since}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>add revision to object</p>

<p>in addition to the standard behavior, we check for the $docs<em>to</em>remove
attribute, to add new revision to these as well.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">_add_revision_to : </span><span class="nf">(obj) -&gt;</span>
      <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$docs_to_remove</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;obj.$docs_to_remove&quot;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$docs_to_remove</span>
        <span class="nx">@_add_revision_to</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">doc</span> <span class="k">of</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$docs_to_remove</span>

      <span class="k">super</span> <span class="nx">obj</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>handle push success</p>

<p>before handing over the docs (that have been replicated to the couch)
to the default procedure, we check for the $docs<em>to</em>remove attribute
again, and handle these documents upfront</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">_handle_push_success: </span><span class="p">(</span><span class="nx">docs</span><span class="p">,</span> <span class="nx">pushed_docs</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="o">=&gt;</span>
        <span class="k">for</span> <span class="nx">pushed_doc</span> <span class="k">in</span> <span class="nx">pushed_docs</span>
          <span class="k">if</span> <span class="nx">pushed_doc</span><span class="p">.</span><span class="nx">$docs_to_remove</span>
            <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">doc</span> <span class="k">of</span> <span class="nx">pushed_doc</span><span class="p">.</span><span class="nx">$docs_to_remove</span>
              <span class="p">[</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/\//</span>
              <span class="nv">update = _rev: </span><span class="nx">doc</span><span class="p">.</span><span class="nx">_rev</span>
              <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">update</span><span class="p">,</span> <span class="nv">remote: </span><span class="kc">true</span><span class="p">)</span> <span class="k">for</span> <span class="nx">doc</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">docs</span>

        <span class="k">super</span><span class="p">(</span><span class="nx">docs</span><span class="p">,</span> <span class="nx">pushed_docs</span><span class="p">)()</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 