<!DOCTYPE html><html lang="en"><head><title>src/hoodie/account</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="src/hoodie/account"><meta name="groc-project-path" content="src/hoodie/account.coffee"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/hoodie/account.coffee</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="hoodieaccount">Hoodie.Account</h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>tell something smart in here.</p></div></div><div class="code"><div class="wrapper"><span class="k">class</span> <span class="nx">Hoodie</span><span class="p">.</span><span class="nx">Account</span>
  
  <span class="c1"># Properties</span>
  <span class="c1"># ------------</span>
  <span class="nv">username    : </span><span class="kc">undefined</span>

  
  <span class="c1"># Constructor</span>
  <span class="c1"># ------------</span>
  <span class="nv">constructor : </span><span class="nf">(@hoodie) -&gt;</span>
    
    <span class="c1"># handle session</span>
    <span class="vi">@username = </span><span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;_account.username&#39;</span>
    <span class="vi">@owner    = </span><span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;_account.owner&#39;</span>

    <span class="c1"># the owner hash gets stored in every object created by the user.</span>
    <span class="c1"># Make sure we have one.</span>
    <span class="nx">unless</span> <span class="nx">@owner</span>
      <span class="vi">@owner = </span><span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">uuid</span><span class="p">()</span>
      <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;_account.owner&#39;</span><span class="p">,</span> <span class="nx">@owner</span>
    
    <span class="c1"># authenticate on next tick</span>
    <span class="c1"># window.setTimeout @authenticate</span>

    <span class="c1"># is there a pending password reset?</span>
    <span class="nx">@_checkPasswordResetStatus</span><span class="p">()</span>
  
  
  <span class="c1"># Authenticate</span>
  <span class="c1"># --------------</span>

  <span class="c1"># Use this method to assure that the user is authenticated:</span>
  <span class="c1"># `hoodie.my.account.authenticate().done( doSomething ).fail( handleError )`</span>
  <span class="nv">authenticate : </span><span class="o">=&gt;</span>
    <span class="nx">unless</span> <span class="nx">@username</span>
      <span class="k">return</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">defer</span><span class="p">().</span><span class="nx">reject</span><span class="p">().</span><span class="nx">promise</span><span class="p">()</span>
      
    <span class="k">if</span> <span class="nx">@_authenticated</span> <span class="o">is</span> <span class="kc">true</span>
      <span class="k">return</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">defer</span><span class="p">().</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">@username</span><span class="p">).</span><span class="nx">promise</span><span class="p">()</span>
      
    <span class="k">if</span> <span class="nx">@_authenticated</span> <span class="o">is</span> <span class="kc">false</span>
      <span class="k">return</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">defer</span><span class="p">().</span><span class="nx">reject</span><span class="p">().</span><span class="nx">promise</span><span class="p">()</span>
    
    <span class="c1"># @_authenticated is undefined</span>
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s2">&quot;/_session&quot;</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span> <span class="nx">@_handleAuthenticateSuccess</span><span class="p">,</span> <span class="nx">@_handleRequestError</span>
    
    
  <span class="c1"># sign up with username &amp; password</span>
  <span class="c1"># ----------------------------------</span>

  <span class="c1"># uses standard CouchDB API to create a new document in _users db.</span>
  <span class="c1"># The backend will automatically create a userDB based on the username</span>
  <span class="c1"># address and approve the account by adding a &quot;confirmed&quot; role to the</span>
  <span class="c1"># user doc. The account confirmation might take a while, so we keep trying</span>
  <span class="c1"># to sign in with a 300ms timeout.</span>
  <span class="c1">#</span>
  <span class="nv">signUp : </span><span class="nf">(username, password = &#39;&#39;) -&gt;</span>
    <span class="k">if</span> <span class="nx">@hasAnonymousAccount</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">@_upgradeAnonymousAccount</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">password</span>

    <span class="nv">options =</span>
      <span class="nv">data        : </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span>
        <span class="nv">_id        : </span><span class="nx">@_key</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span>
        <span class="nv">name       : </span><span class="nx">@_userKey</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span>
        <span class="nv">type       : </span><span class="s1">&#39;user&#39;</span>
        <span class="nv">roles      : </span><span class="p">[]</span>
        <span class="nv">password   : </span><span class="nx">password</span>
        <span class="nv">$owner     : </span><span class="nx">@owner</span>
        <span class="nv">database   : </span><span class="nx">@db</span><span class="p">()</span>
      <span class="nv">contentType : </span><span class="s1">&#39;application/json&#39;</span>

    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="nx">@_url</span><span class="p">(</span><span class="nx">username</span><span class="p">),</span> <span class="nx">options</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span> <span class="nx">@_handleSignUpSucces</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">),</span> <span class="nx">@_handleRequestError</span>

  
  <span class="c1"># anonymous sign up</span>
  <span class="c1"># -------------------</span>

  <span class="c1"># If the user did not sign up himself yet, but data needs to be transfered</span>
  <span class="c1"># to the couch, e.g. to send an email or to share data, the anonymousSignUp</span>
  <span class="c1"># method can be used. It generates a random password and stores it locally</span>
  <span class="c1"># in the browser.</span>
  <span class="c1">#</span>
  <span class="c1"># If the user signes up for real later, we change his username and password</span>
  <span class="c1"># internally instead of creating another user. </span>
  <span class="c1">#</span>
  <span class="nv">anonymousSignUp: </span><span class="o">-&gt;</span>
    <span class="nv">password = </span><span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">uuid</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="nv">username = </span><span class="nx">@owner</span>

    <span class="nx">@signUp</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">@_handleRequestError</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">done</span> <span class="o">=&gt;</span>
      <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;_account.anonymousPassword&#39;</span><span class="p">,</span> <span class="nx">password</span>


  <span class="c1"># hasAnonymousAccount</span>
  <span class="c1"># ---------------------</span>
  
  <span class="c1">#</span>
  <span class="nv">hasAnonymousAccount: </span><span class="o">-&gt;</span>
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;_account.anonymousPassword&#39;</span><span class="p">)</span><span class="o">?</span>


  <span class="c1"># sign in with username &amp; password</span>
  <span class="c1"># ----------------------------------</span>

  <span class="c1"># uses standard CouchDB API to create a new user session (POST /_session).</span>
  <span class="c1"># Besides the standard sign in we also check if the account has been confirmed</span>
  <span class="c1"># (roles include &quot;confirmed&quot; role).</span>
  <span class="c1">#</span>
  <span class="nv">signIn : </span><span class="nf">(username, password = &#39;&#39;) -&gt;</span>
    <span class="nv">options = data: </span>
                <span class="nv">name      : </span><span class="nx">@_userKey</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span>
                <span class="nv">password  : </span><span class="nx">password</span>

    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;/_session&#39;</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">@_handleSignInSuccess</span><span class="p">)</span>

  <span class="c1"># alias</span>
  <span class="nv">login: </span><span class="err">@</span><span class="o">::</span><span class="nx">signIn</span>


  <span class="c1"># sign out </span>
  <span class="c1"># ---------</span>

  <span class="c1"># uses standard CouchDB API to destroy a user session (DELETE /_session)</span>
  <span class="c1">#</span>
  <span class="c1"># TODO: handle errors</span>
  <span class="nv">signOut: </span><span class="o">-&gt;</span>
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">remote</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">()</span>
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="s1">&#39;DELETE&#39;</span><span class="p">,</span> <span class="s1">&#39;/_session&#39;</span><span class="p">).</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">@_handleSignOutSuccess</span><span class="p">)</span>

  <span class="c1"># alias</span>
  <span class="nv">logout: </span><span class="err">@</span><span class="o">::</span><span class="nx">signOut</span>
  
  
  <span class="c1"># On</span>
  <span class="c1"># ---</span>

  <span class="c1"># alias for `hoodie.on`</span>
  <span class="kc">on</span> <span class="o">:</span> <span class="nf">(event, cb) -&gt;</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;account:#{event}&quot;</span><span class="p">,</span> <span class="nx">cb</span>
  
  
  <span class="c1"># db</span>
  <span class="c1"># ----</span>

  <span class="c1"># return name of db</span>
  <span class="nv">db : </span><span class="o">-&gt;</span> <span class="s2">&quot;user/#{@owner}&quot;</span>
  
  
  <span class="c1"># fetch</span>
  <span class="c1"># -------</span>

  <span class="c1"># fetches _users doc from CouchDB and caches it in _doc</span>
  <span class="nv">fetch : </span><span class="p">(</span><span class="nv">username = </span><span class="nx">@username</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">unless</span> <span class="nx">username</span>
      <span class="k">return</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">defer</span><span class="p">().</span><span class="nx">reject</span><span class="p">(</span><span class="nv">error: </span><span class="s2">&quot;unauthenticated&quot;</span><span class="p">,</span> <span class="nv">reason: </span><span class="s2">&quot;not logged in&quot;</span><span class="p">).</span><span class="nx">promise</span><span class="p">()</span>
    
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">@_url</span><span class="p">(</span><span class="nx">username</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">@_handleRequestError</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">done</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="vi">@_doc = </span><span class="nx">response</span>
    

  <span class="c1"># change password</span>
  <span class="c1"># -----------------</span>

  <span class="c1"># Note: the hoodie API requires the currentPassword for security reasons,</span>
  <span class="c1"># but couchDb doesn&#39;t require it for a password change, so it&#39;s ignored</span>
  <span class="c1"># in this implementation of the hoodie API.</span>
  <span class="nv">changePassword : </span><span class="nf">(currentPassword, newPassword) -&gt;</span>

    <span class="nx">unless</span> <span class="nx">@username</span>
      <span class="k">return</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">defer</span><span class="p">().</span><span class="nx">reject</span><span class="p">(</span><span class="nv">error: </span><span class="s2">&quot;unauthenticated&quot;</span><span class="p">,</span> <span class="nv">reason: </span><span class="s2">&quot;not logged in&quot;</span><span class="p">).</span><span class="nx">promise</span><span class="p">()</span>
    
    <span class="nv">data = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">@_doc</span>
    <span class="nv">data.password = </span><span class="nx">newPassword</span>
    <span class="k">delete</span> <span class="nx">data</span><span class="p">.</span><span class="nx">salt</span>
    <span class="k">delete</span> <span class="nx">data</span><span class="p">.</span><span class="nx">password_sha</span>
    <span class="nv">options = </span>
      <span class="nv">data        : </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">data</span>
      <span class="nv">contentType : </span><span class="s2">&quot;application/json&quot;</span>

    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">remote</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">()</span>
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span>  <span class="nx">@_url</span><span class="p">(),</span> <span class="nx">options</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span> <span class="nx">@_handleChangePasswordSuccess</span><span class="p">(</span><span class="nx">newPassword</span><span class="p">),</span> <span class="nx">@_handleRequestError</span> <span class="p">)</span>


  <span class="c1"># reset password</span>
  <span class="c1"># ----------------</span>

  <span class="c1"># This is kind of a hack. We need to create an object anonymously</span>
  <span class="c1"># that is not exposed to others. The only CouchDB API othering such </span>
  <span class="c1"># functionality is the _users database.</span>
  <span class="c1"># </span>
  <span class="c1"># So we actualy sign up a new couchDB user with some special attributes.</span>
  <span class="c1"># It will be picked up by the password reset worker and destroyed</span>
  <span class="c1"># once the password was resetted.</span>
  <span class="nv">resetPassword : </span><span class="nf">(username) -&gt;</span>
    <span class="k">if</span> <span class="nv">resetPasswordId = </span><span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;_account.resetPasswordId&#39;</span>
      <span class="k">return</span> <span class="nx">@_checkPasswordResetStatus</span><span class="p">()</span>
      
    <span class="nv">resetPasswordId = </span><span class="s2">&quot;#{username}/#{@hoodie.my.store.uuid()}&quot;</span>
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;_account.resetPasswordId&#39;</span><span class="p">,</span> <span class="nx">resetPasswordId</span>
    
    <span class="nv">key = </span><span class="s2">&quot;#{@_prefix}:$passwordReset/#{resetPasswordId}&quot;</span>
    <span class="nv">data = </span>
      <span class="nv">_id       : </span><span class="nx">key</span>
      <span class="nv">name      : </span><span class="s2">&quot;$passwordReset/#{resetPasswordId}&quot;</span>
      <span class="nv">type      : </span><span class="s1">&#39;user&#39;</span>
      <span class="nv">password  : </span><span class="nx">resetPasswordId</span>
      <span class="nv">createdAt : </span><span class="k">new</span> <span class="nb">Date</span>
      <span class="nv">updatedAt : </span><span class="k">new</span> <span class="nb">Date</span>

    <span class="nv">options =</span>
      <span class="nv">data        : </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">data</span>
      <span class="nv">contentType : </span><span class="s2">&quot;application/json&quot;</span>
    
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span>  <span class="s2">&quot;/_users/#{encodeURIComponent key}&quot;</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">@_handleRequestError</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">done</span> <span class="nx">@_checkPasswordResetStatus</span>


  <span class="c1"># change username</span>
  <span class="c1"># -----------------</span>

  <span class="c1"># Note: the hoodie API requires the current password for security reasons,</span>
  <span class="c1"># but technically we cannot (yet) prevent the user to change the username </span>
  <span class="c1"># without knowing the current password, so it&#39;s not impulemented in the current</span>
  <span class="c1"># implementation of the hoodie API.</span>
  <span class="c1">#</span>
  <span class="c1"># But the current password is needed to login with the new username.</span>
  <span class="nv">changeUsername : </span><span class="nf">(currentPassword, newUsername) -&gt;</span>
    <span class="nx">@_changeUsernameAndPassword</span><span class="p">(</span><span class="nx">currentPassword</span><span class="p">,</span> <span class="nx">newUsername</span><span class="p">)</span>


  <span class="c1"># destroy</span>
  <span class="c1"># ---------</span>

  <span class="c1"># destroys a user&#39; account  </span>
  <span class="nv">destroy : </span><span class="o">-&gt;</span>
    <span class="nx">@fetch</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">@_handleFetchBeforeDestroySucces</span><span class="p">,</span> <span class="nx">@_handleRequestError</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">@_handleDestroySucces</span><span class="p">)</span>


  <span class="c1"># PRIVATE</span>
  <span class="c1"># ---------</span>

  <span class="c1"># default couchDB user doc prefix</span>
  <span class="nv">_prefix : </span><span class="s1">&#39;org.couchdb.user&#39;</span>
  
  <span class="c1"># CouchDB _users doc</span>
  <span class="nv">_doc : </span><span class="p">{}</span>

  <span class="c1"># setters</span>
  <span class="nv">_setUsername : </span><span class="nf">(@username) -&gt;</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;_account.username&#39;</span><span class="p">,</span> <span class="nx">@username</span>
  <span class="nv">_setOwner    : </span><span class="nf">(@owner)    -&gt;</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">set</span> <span class="s1">&#39;_account.owner&#39;</span><span class="p">,</span>    <span class="nx">@owner</span>

  <span class="c1">#</span>
  <span class="c1"># handle a successful authentication request.</span>
  <span class="c1"># </span>
  <span class="nv">_handleAuthenticateSuccess : </span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">defer = </span><span class="nx">@hoodie</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">userCtx</span><span class="p">.</span><span class="nx">name</span>
      <span class="vi">@_authenticated = </span><span class="kc">true</span>
      <span class="nx">@_setUsername</span> <span class="nx">response</span><span class="p">.</span><span class="nx">userCtx</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^user(_anonymous)?\//</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
      <span class="nx">@_setOwner</span>    <span class="nx">response</span><span class="p">.</span><span class="nx">userCtx</span><span class="p">.</span><span class="nx">roles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">@username</span>

    <span class="k">else</span>
      <span class="vi">@_authenticated = </span><span class="kc">false</span>
      <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">trigger</span> <span class="s1">&#39;account:error:unauthenticated&#39;</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">()</span>

    <span class="k">return</span> <span class="nx">defer</span><span class="p">.</span><span class="nx">promise</span><span class="p">()</span>

  <span class="c1">#</span>
  <span class="c1"># standard error handling for AJAX requests</span>
  <span class="c1">#</span>
  <span class="nv">_handleRequestError : </span><span class="p">(</span><span class="nv">xhr = </span><span class="p">{})</span> <span class="o">=&gt;</span>
    <span class="k">try</span>
      <span class="nv">error = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span><span class="p">)</span>
    <span class="k">catch</span> <span class="nx">e</span>
      <span class="nv">error = error: </span><span class="nx">xhr</span><span class="p">.</span><span class="nx">responseText</span> <span class="o">or</span> <span class="s2">&quot;unknown&quot;</span>
      
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">defer</span><span class="p">().</span><span class="nx">reject</span><span class="p">(</span><span class="nx">error</span><span class="p">).</span><span class="nx">promise</span><span class="p">()</span>
  
  <span class="c1"># </span>
  <span class="c1"># handle response of a successful signUp request. </span>
  <span class="c1"># Response looks like:</span>
  <span class="c1">#</span>
  <span class="c1">#     {</span>
  <span class="c1">#         &quot;ok&quot;: true,</span>
  <span class="c1">#         &quot;id&quot;: &quot;org.couchdb.user:furz&quot;,</span>
  <span class="c1">#         &quot;rev&quot;: &quot;1-e8747d9ae9776706da92810b1baa4248&quot;</span>
  <span class="c1">#     }</span>
  <span class="c1">#</span>
  <span class="nv">_handleSignUpSucces : </span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">defer = </span><span class="nx">@hoodie</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span>

    <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">trigger</span> <span class="s1">&#39;account:signup&#39;</span><span class="p">,</span> <span class="nx">username</span>
      <span class="vi">@_doc._rev = </span><span class="nx">response</span><span class="p">.</span><span class="nx">rev</span>
      <span class="nx">@_delayedSignIn</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span>

  <span class="nv">_delayedSignIn : </span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">defer = </span><span class="nx">@hoodie</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span> <span class="p">(</span> <span class="o">=&gt;</span>
      <span class="nv">promise = </span><span class="nx">@signIn</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span>
      <span class="nx">promise</span><span class="p">.</span><span class="nx">done</span><span class="p">(</span><span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">)</span>
      <span class="nx">promise</span><span class="p">.</span><span class="nx">fail</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">if</span> <span class="nx">error</span><span class="p">.</span><span class="nx">error</span> <span class="o">is</span> <span class="s1">&#39;unconfirmed&#39;</span>
          <span class="c1"># It might take a bit until the account has been confirmed</span>
          <span class="nx">@_delayedSignIn</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span> <span class="nx">arguments</span><span class="p">...</span>
    <span class="p">),</span> <span class="mi">300</span>

    <span class="k">return</span> <span class="nx">defer</span><span class="p">.</span><span class="nx">promise</span><span class="p">()</span>

  <span class="c1">#</span>
  <span class="c1"># handle a successful sign in to couchDB.</span>
  <span class="c1"># Response looks like:</span>
  <span class="c1">#</span>
  <span class="c1">#     {</span>
  <span class="c1">#         &quot;ok&quot;: true,</span>
  <span class="c1">#         &quot;name&quot;: &quot;test1&quot;,</span>
  <span class="c1">#         &quot;roles&quot;: [</span>
  <span class="c1">#             &quot;mvu85hy&quot;,</span>
  <span class="c1">#             &quot;confirmed&quot;</span>
  <span class="c1">#         ]</span>
  <span class="c1">#     }</span>
  <span class="c1">#</span>
  <span class="nv">_handleSignInSuccess : </span><span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">defer    = </span><span class="nx">@hoodie</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span>
    <span class="nv">username = </span><span class="nx">response</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/^user(_anonymous)?\//</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="c1"># if an error occured, the userDB worker stores it to the $error attribute</span>
    <span class="c1"># and adds the &quot;error&quot; role to the users doc object. If the user has the</span>
    <span class="c1"># &quot;error&quot; role, we need to fetch his _users doc to find out what the error</span>
    <span class="c1"># is, before we can reject the promise.</span>
    <span class="c1">#</span>
    <span class="k">if</span> <span class="o">~</span><span class="nx">response</span><span class="p">.</span><span class="nx">roles</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>
      <span class="nx">@fetch</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">done</span> <span class="o">=&gt;</span>
        <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span> <span class="nv">error: </span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="nv">reason: </span><span class="nx">@_doc</span><span class="p">.</span><span class="nx">$error</span>
      <span class="k">return</span> <span class="nx">defer</span><span class="p">.</span><span class="nx">promise</span><span class="p">()</span>

    <span class="c1"># When the userDB worker created the database for the user and everthing</span>
    <span class="c1"># worked out, it adds the role &quot;confirmed&quot; to the user. If the role is</span>
    <span class="c1"># not present yet, it might be that the worker didn&#39;t pick up the the </span>
    <span class="c1"># user doc yet, or there was an error. In this cases, we reject the promise</span>
    <span class="c1"># with an &quot;uncofirmed error&quot;</span>
    <span class="nx">unless</span> <span class="o">~</span><span class="nx">response</span><span class="p">.</span><span class="nx">roles</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;confirmed&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span> <span class="nv">error: </span><span class="s2">&quot;unconfirmed&quot;</span><span class="p">,</span> <span class="nv">reason: </span><span class="s2">&quot;account has not been confirmed yet&quot;</span>
    
    <span class="vi">@_authenticated = </span><span class="kc">true</span>
    <span class="nx">@_setUsername</span> <span class="nx">username</span>
    <span class="nx">@_setOwner</span>    <span class="nx">response</span><span class="p">.</span><span class="nx">roles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">trigger</span> <span class="s1">&#39;account:signin&#39;</span><span class="p">,</span> <span class="nx">@username</span>

    <span class="nx">@fetch</span><span class="p">()</span>
    <span class="nx">defer</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">@username</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span>
    

  <span class="c1">#</span>
  <span class="c1">#</span>
  <span class="c1">#</span>
  <span class="nv">_handleChangePasswordSuccess : </span><span class="nf">(newPassword) -&gt;</span>
    <span class="o">=&gt;</span> <span class="nx">@signIn</span><span class="p">(</span><span class="nx">@username</span><span class="p">,</span> <span class="nx">newPassword</span><span class="p">)</span>

  <span class="c1">#</span>
  <span class="c1">#</span>
  <span class="c1">#</span>
  <span class="nv">_handleSignOutSuccess : </span><span class="o">=&gt;</span>
    <span class="k">delete</span> <span class="nx">@username</span>
    <span class="k">delete</span> <span class="nx">@owner</span>
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
    <span class="vi">@_authenticated = </span><span class="kc">false</span>
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">trigger</span> <span class="s1">&#39;account:signout&#39;</span>

  <span class="c1">#</span>
  <span class="c1"># check for the status of a password reset. It might take</span>
  <span class="c1"># a while until the password reset worker picks up the job</span>
  <span class="c1"># and updates it</span>
  <span class="c1">#</span>
  <span class="c1"># If a password reset request was successful, the $passwordRequest</span>
  <span class="c1"># doc gets removed from _users by the worker, therefore a 401 is</span>
  <span class="c1"># what we are waiting for.</span>
  <span class="c1">#</span>
  <span class="c1"># Once called, it continues to request the status update with a</span>
  <span class="c1"># 1s timeout.</span>
  <span class="c1">#</span>
  <span class="nv">_checkPasswordResetStatus : </span><span class="o">=&gt;</span>

    <span class="c1"># reject if there is no pending password reset request</span>
    <span class="nv">resetPasswordId = </span><span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;_account.resetPasswordId&#39;</span>
    <span class="nx">unless</span> <span class="nx">resetPasswordId</span>
      <span class="k">return</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">defer</span><span class="p">().</span><span class="nx">reject</span><span class="p">(</span><span class="nv">error: </span><span class="s2">&quot;missing&quot;</span><span class="p">).</span><span class="nx">promise</span><span class="p">()</span>
      
    <span class="c1"># send request to check status of password reset</span>
    <span class="nv">username  = </span><span class="s2">&quot;$passwordReset/#{resetPasswordId}&quot;</span>
    <span class="nv">url       = </span><span class="s2">&quot;/_users/#{encodeURIComponent &quot;</span><span class="c1">#{@_prefix}:#{username}&quot;}&quot;</span>
    <span class="nv">hash      = </span><span class="nx">btoa</span> <span class="s2">&quot;#{username}:#{resetPasswordId}&quot;</span>
    <span class="nv">options   =</span>
      <span class="nv">headers:</span>
        <span class="nv">Authorization : </span><span class="s2">&quot;Basic #{hash}&quot;</span>

    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">@_handlePasswordResetStatusRequestSuccess</span><span class="p">,</span> <span class="nx">@_handlePasswordResetStatusRequestError</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">fail</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nx">error</span><span class="p">.</span><span class="nx">error</span> <span class="o">is</span> <span class="s1">&#39;pending&#39;</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span> <span class="nx">@_checkPasswordResetStatus</span><span class="p">,</span> <span class="mi">1000</span>
        <span class="k">return</span>

      <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">trigger</span> <span class="s1">&#39;account:password_reset:error&#39;</span>

  <span class="nv">_handlePasswordResetStatusRequestSuccess : </span><span class="o">=&gt;</span>
    <span class="nv">defer = </span><span class="nx">@hoodie</span><span class="p">.</span><span class="nx">defer</span><span class="p">()</span>

    <span class="k">if</span> <span class="nx">response</span><span class="p">.</span><span class="nx">$error</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span> <span class="nv">error: </span><span class="nx">response</span><span class="p">.</span><span class="nx">$error</span>
    <span class="k">else</span>
      <span class="nx">defer</span><span class="p">.</span><span class="nx">reject</span> <span class="nv">error: </span><span class="s1">&#39;pending&#39;</span>

    <span class="k">return</span> <span class="nx">defer</span><span class="p">.</span><span class="nx">promise</span><span class="p">()</span>


  <span class="nv">_handlePasswordResetStatusRequestError : </span><span class="p">(</span><span class="nx">xhr</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">if</span> <span class="nx">xhr</span><span class="p">.</span><span class="nx">status</span> <span class="o">is</span> <span class="mi">401</span>
      <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">defer</span><span class="p">().</span><span class="nx">resolve</span><span class="p">()</span>

      <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">remove</span> <span class="s1">&#39;_account.resetPasswordId&#39;</span>
      <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">trigger</span> <span class="s1">&#39;account:password_reset:success&#39;</span>
    <span class="k">else</span>
      <span class="nx">@_handleRequestError</span><span class="p">(</span><span class="nx">xhr</span><span class="p">)</span>


  <span class="c1">#</span>
  <span class="c1"># change username and password in 3 steps</span>
  <span class="c1"># </span>
  <span class="c1"># 1. assure we have a valid session</span>
  <span class="c1"># 2. update _users doc with new username and new password (if provided)</span>
  <span class="c1"># 3. sign in with new credentials to create new sesion.</span>
  <span class="c1">#</span>
  <span class="nv">_changeUsernameAndPassword : </span><span class="nf">(currentPassword, newUsername, newPassword) -&gt;</span>
    <span class="nx">@authenticate</span><span class="p">().</span><span class="nx">pipe</span> <span class="o">=&gt;</span>

      <span class="c1"># prepare updated _users doc</span>
      <span class="nv">data = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">@_doc</span>
      <span class="nx">data</span><span class="p">.</span><span class="nv">$newUsername = </span><span class="nx">newUsername</span>

      <span class="c1"># trigger password update when newPassword set</span>
      <span class="k">if</span> <span class="nx">newPassword</span>
        <span class="k">delete</span> <span class="nx">data</span><span class="p">.</span><span class="nx">salt</span>
        <span class="k">delete</span> <span class="nx">data</span><span class="p">.</span><span class="nx">password_sha</span>
        <span class="nv">data.password = </span><span class="nx">newPassword</span>

      <span class="nv">options =</span>
        <span class="nv">data        : </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">data</span>
        <span class="nv">contentType : </span><span class="s1">&#39;application/json&#39;</span>

      <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span><span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="nx">@_url</span><span class="p">(),</span> <span class="nx">options</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">pipe</span> <span class="o">=&gt;</span>
        <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">remote</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">()</span>
        <span class="nx">@_delayedSignIn</span> <span class="nx">newUsername</span><span class="p">,</span> <span class="nx">newPassword</span> <span class="o">or</span> <span class="nx">currentPassword</span>
  
  <span class="c1">#</span>
  <span class="c1"># turn an anonymous account into a real account</span>
  <span class="c1">#</span>
  <span class="nv">_upgradeAnonymousAccount : </span><span class="nf">(username, password) -&gt;</span>
    <span class="nv">currentPassword = </span><span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;_account.anonymousPassword&#39;</span>
    <span class="nx">@_changeUsernameAndPassword</span><span class="p">(</span><span class="nx">currentPassword</span><span class="p">,</span> <span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">done</span> <span class="o">=&gt;</span> 
      <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">remove</span> <span class="s1">&#39;_account.anonymousPassword&#39;</span>

  <span class="c1">#</span>
  <span class="c1">#</span>
  <span class="c1">#</span>
  <span class="nv">_handleFetchBeforeDestroySucces : </span><span class="o">=&gt;</span>
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">remote</span><span class="p">.</span><span class="nx">disconnect</span><span class="p">()</span>
    <span class="vi">@_doc._deleted = </span><span class="kc">true</span>
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">request</span> <span class="s1">&#39;PUT&#39;</span><span class="p">,</span> <span class="nx">@_url</span><span class="p">(),</span>
      <span class="nv">data        : </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">@_doc</span>
      <span class="nv">contentType : </span><span class="s1">&#39;application/json&#39;</span>

  <span class="c1">#</span>
  <span class="c1">#</span>
  <span class="c1">#</span>
  <span class="nv">_handleDestroySucces : </span><span class="o">=&gt;</span>
    <span class="k">delete</span> <span class="nx">@username</span>
    <span class="k">delete</span> <span class="nx">@owner</span>
    <span class="k">delete</span> <span class="nx">@_authenticated</span>

  <span class="c1">#</span>
  <span class="c1">#</span>
  <span class="c1">#</span>
  <span class="nv">_userKey : </span><span class="nf">(username) -&gt;</span>
    <span class="k">if</span> <span class="nx">username</span> <span class="o">is</span> <span class="nx">@owner</span>
      <span class="s2">&quot;user_anonymous/#{username}&quot;</span>
    <span class="k">else</span>
      <span class="s2">&quot;user/#{username}&quot;</span>

  <span class="c1">#</span>
  <span class="nv">_key : </span><span class="nf">(username = @username) -&gt;</span>
    <span class="s2">&quot;#{@_prefix}:#{@_userKey(username)}&quot;</span>

  <span class="c1">#</span>
  <span class="nv">_url : </span><span class="nf">(username = @username) -&gt;</span>
    <span class="s2">&quot;/_users/#{encodeURIComponent @_key(username)}&quot;</span></div></div></div></div></body></html>