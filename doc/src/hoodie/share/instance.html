<!DOCTYPE html><html lang="en"><head><title>src/hoodie/share/instance</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="src/hoodie/share/instance"><meta name="groc-project-path" content="src/hoodie/share/instance.coffee"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/hoodie/share/instance.coffee</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="k">class</span> <span class="nx">Hoodie</span><span class="p">.</span><span class="nx">Share</span><span class="p">.</span><span class="nx">Instance</span> <span class="k">extends</span> <span class="nx">Hoodie</span><span class="p">.</span><span class="nx">RemoteStore</span>

  <span class="c1"># constructor</span>
  <span class="c1"># -------------</span>
  
  <span class="c1"># initializes a new share &amp; returns a promise.</span>
  <span class="c1">#</span>
  <span class="c1"># ### Options</span>
  <span class="c1">#</span>
  <span class="c1">#     id:            (optional, defaults to random uuid)</span>
  <span class="c1">#                    name of share.</span>
  <span class="c1">#     objects:       (optional)</span>
  <span class="c1">#                    array of objects that should be shared</span>
  <span class="c1">#     access:        (default: false)</span>
  <span class="c1">#                    **false**</span>
  <span class="c1">#                    only the creator has access.</span>
  <span class="c1">#                    **true**</span>
  <span class="c1">#                    public sharing, read &amp; write access</span>
  <span class="c1">#                    **{ read: true }**</span>
  <span class="c1">#                    public sharing, read only</span>
  <span class="c1">#                    **[user1, user2]**</span>
  <span class="c1">#                    only user1 &amp; user2 have access</span>
  <span class="c1">#                    **{ read: [user1, user2] }**</span>
  <span class="c1">#                    only user1 &amp; user2 have access (read only)</span>
  <span class="c1">#                    **{ read: true, write: [user1, user2] }**</span>
  <span class="c1">#                    public sharing, but only user1 &amp; user 2 can edit</span>
  <span class="c1">#     continuous:    (default: false)</span>
  <span class="c1">#                    if set to true, the shared objects will be</span>
  <span class="c1">#                    continuously updated.</span>
  <span class="c1">#     password:      (optional)</span>
  <span class="c1">#                    a sharing can be optionally protected with a password.</span>
  <span class="c1">#</span>
  <span class="c1"># Examples</span>
  <span class="c1">#</span>
  <span class="c1"># </span>
  <span class="c1">#     # share my todo list with Joey and Frank</span>
  <span class="c1">#     hoodie.share.create</span>
  <span class="c1">#       access : [</span>
  <span class="c1">#         &quot;joey@example.com&quot;</span>
  <span class="c1">#         &quot;frank@example.com&quot;</span>
  <span class="c1">#       ]</span>
  <span class="c1">#       objects : [</span>
  <span class="c1">#         todoList, todo1, todo2, todo3</span>
  <span class="c1">#       ]</span>
  <span class="c1">#</span>
  <span class="nv">constructor: </span><span class="nf">(options = {}) -&gt;</span>
    
    <span class="vi">@hoodie = </span><span class="nx">@constructor</span><span class="p">.</span><span class="nx">hoodie</span>

    <span class="c1"># setting attributes</span>
    <span class="p">{</span><span class="nx">id</span><span class="p">,</span> <span class="nx">access</span><span class="p">,</span> <span class="nx">continuous</span><span class="p">,</span> <span class="nx">password</span><span class="p">}</span> <span class="o">=</span> <span class="nx">options</span>
    <span class="nx">@set</span> <span class="p">{</span><span class="nx">id</span><span class="p">,</span> <span class="nx">access</span><span class="p">,</span> <span class="nx">continuous</span><span class="p">,</span> <span class="nx">password</span><span class="p">}</span>

    <span class="c1"># generate an id unless one has been provided</span>
    <span class="nx">@id</span> <span class="o">or=</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">uuid</span><span class="p">()</span>
  
  
  <span class="c1"># set</span>
  <span class="c1"># -----</span>
  
  <span class="c1"># set an attribute, without making the change persistent yet.</span>
  <span class="c1"># alternatively, a hash of key/value pairs can be passed</span>
  <span class="nv">_memory: </span><span class="p">{}</span>
  <span class="nv">set : </span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">key</span> <span class="o">is</span> <span class="s1">&#39;object&#39;</span>
      <span class="err">@</span><span class="p">[</span><span class="nx">_key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@_memory</span><span class="p">[</span><span class="nx">_key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span> <span class="k">for</span> <span class="nx">_key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">key</span> 
    <span class="k">else</span> 
      <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>  <span class="o">=</span> <span class="nx">@_memory</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>  <span class="o">=</span> <span class="nx">value</span>

    <span class="c1"># make sure share is private if invitees are set</span>
    <span class="vi">@private = @_memory.private = </span><span class="kc">true</span> <span class="k">if</span> <span class="nx">@invitees</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span>

    <span class="k">return</span> <span class="kc">undefined</span>
    
  
  <span class="c1"># get</span>
  <span class="c1"># -----</span>
  
  <span class="c1"># get an attribute</span>
  <span class="nv">get : </span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
  
  
  <span class="c1"># save</span>
  <span class="c1"># ------</span>
  
  <span class="c1"># make changes made with `.set` persistent. An optional</span>
  <span class="c1"># key/value update can be passed as first argument</span>
  <span class="c1">#</span>
  <span class="c1"># Obviously, sharing object only works if my local data</span>
  <span class="c1"># gets synchronized. To make this happen for users without</span>
  <span class="c1"># an account, we do an anonymous signUp.</span>
  <span class="nv">save : </span><span class="nf">(update = {}, options) -&gt;</span>
    
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">account</span><span class="p">.</span><span class="nx">anonymousSignUp</span><span class="p">()</span>

    <span class="nx">@set</span><span class="p">(</span><span class="nx">update</span><span class="p">)</span> <span class="k">if</span> <span class="nx">update</span>
    <span class="nv">_handleUpdate = </span><span class="p">(</span><span class="nx">properties</span><span class="p">,</span> <span class="nx">wasCreated</span><span class="p">)</span> <span class="o">=&gt;</span> 
      <span class="c1"># reset memory</span>
      <span class="vi">@_memory = </span><span class="p">{}</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="k">this</span><span class="p">,</span> <span class="nx">properties</span>
      <span class="k">return</span> <span class="k">this</span>

    <span class="c1"># persist memory to store</span>
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="s2">&quot;$share&quot;</span><span class="p">,</span> <span class="nx">@id</span><span class="p">,</span> <span class="nx">@_memory</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">_handleUpdate</span><span class="p">)</span>
    
  
  <span class="c1"># add</span>
  <span class="c1"># -----</span>
  
  <span class="c1"># add one or multiple objects to share. A promise that will</span>
  <span class="c1"># resolve with an array of objects can be passed as well.</span>
  <span class="c1">#</span>
  <span class="c1"># usage</span>
  <span class="c1">#</span>
  <span class="c1"># share.add(todoObject)</span>
  <span class="c1"># share.add([todoObject1, todoObject2, todoObject3])</span>
  <span class="c1"># share.add( hoodie.my.store.findAll (obj) -&gt; obj.isShared )</span>
  <span class="nv">add: </span><span class="nf">(objects) -&gt;</span>
    <span class="nx">@toggle</span> <span class="nx">objects</span><span class="p">,</span> <span class="kc">true</span>
    
      
  <span class="c1"># remove</span>
  <span class="c1"># --------</span>
  
  <span class="c1"># remove one or multiple objects from share. A promise that will</span>
  <span class="c1"># resolve with an array of objects can be passed as well.</span>
  <span class="c1">#</span>
  <span class="c1"># usage</span>
  <span class="c1">#</span>
  <span class="c1"># share.remove(todoObject)</span>
  <span class="c1"># share.remove([todoObject1, todoObject2, todoObject3])</span>
  <span class="c1"># share.remove( hoodie.my.store.findAll (obj) -&gt; obj.isShared )</span>
  <span class="nv">remove: </span><span class="nf">(objects) -&gt;</span> 
    <span class="nx">@toggle</span> <span class="nx">objects</span><span class="p">,</span> <span class="kc">false</span>
  
  
  <span class="c1"># toggle</span>
  <span class="c1"># --------</span>

  <span class="c1"># add or remove, depending on passed flag or current state</span>
  <span class="nv">toggle: </span><span class="nf">(objects, doAdd) -&gt;</span>
    
    <span class="c1"># normalize input</span>
    <span class="nx">unless</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">isPromise</span><span class="p">(</span><span class="nx">objects</span><span class="p">)</span> <span class="o">or</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">objects</span><span class="p">)</span>
      <span class="nv">objects = </span><span class="p">[</span><span class="nx">objects</span><span class="p">]</span>
    
    <span class="c1"># get the update method to add/remove an object to/from share</span>
    <span class="nv">updateMethod = </span><span class="k">switch</span> <span class="nx">doAdd</span>
      <span class="k">when</span> <span class="kc">true</span>  <span class="k">then</span> <span class="nx">@_add</span>
      <span class="k">when</span> <span class="kc">false</span> <span class="k">then</span> <span class="nx">@_remove</span>
      <span class="k">else</span> <span class="nx">@_toggle</span>
    
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">updateAll</span><span class="p">(</span><span class="nx">objects</span><span class="p">,</span> <span class="nx">updateMethod</span><span class="p">)</span>
    
  
  <span class="c1"># sync</span>
  <span class="c1"># ------</span>

  <span class="c1">#</span>
  <span class="c1"># 1. find all objects that belong to share and that have local changes</span>
  <span class="c1"># 2. combine these with the docs that have been removed from the share</span>
  <span class="c1"># 3. sync all these with share&#39;s remote</span>
  <span class="c1">#</span>
  <span class="nv">sync: </span><span class="o">=&gt;</span>
    <span class="nx">@save</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">pipe</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">findAll</span><span class="p">(</span><span class="nx">@_isMySharedObjectAndChanged</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span> <span class="p">(</span><span class="nx">sharedObjectsThatChanged</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">remote</span><span class="p">.</span><span class="nx">sync</span><span class="p">(</span><span class="nx">sharedObjectsThatChanged</span><span class="p">)</span>
      <span class="p">.</span><span class="k">then</span> <span class="nx">@_handleRemoteChanges</span>


  <span class="c1"># destroy</span>
  <span class="c1"># ---------</span>

  <span class="c1"># remove all objects from share, then destroy share itself</span>
  <span class="nv">destroy : </span><span class="o">=&gt;</span>
    <span class="nx">@remove</span><span class="p">(</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">findAll</span><span class="p">(</span><span class="nx">@_isMySharedObject</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">.</span><span class="k">then</span> <span class="o">=&gt;</span>
      <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">destroy</span><span class="p">(</span><span class="s2">&quot;$share&quot;</span><span class="p">,</span> <span class="nx">@id</span><span class="p">)</span>
    
    
  <span class="c1"># Private</span>
  <span class="c1"># ---------</span>

  <span class="c1"># _add</span>
  <span class="c1">#</span>
  <span class="c1"># returns a hash update to update the passed object</span>
  <span class="c1"># so that it gets added to the share</span>
  <span class="nv">_add: </span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">=&gt;</span> 
    <span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span> <span class="o">or=</span> <span class="p">{}</span>
    <span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span><span class="p">[</span><span class="nx">@id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>

    <span class="nv">$shares: </span><span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span><span class="p">[</span><span class="nx">@id</span><span class="p">]</span>

  
  <span class="c1"># _remove</span>
  <span class="c1">#</span>
  <span class="c1"># returns a hash update to update the passed object</span>
  <span class="c1"># so that it gets removed from the current share </span>
  <span class="nv">_remove : </span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">return</span> <span class="p">{}</span> <span class="nx">unless</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span>

    <span class="k">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span><span class="p">[</span><span class="nx">@id</span><span class="p">]</span>
    <span class="nx">obj</span><span class="p">.</span><span class="nv">$shares = </span><span class="kc">undefined</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isEmptyObject</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span>
    <span class="nv">$shares: </span><span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span>
      

  <span class="c1"># depending on whether the passed object belongs to the</span>
  <span class="c1"># share or not, an update will be returned to add/remove </span>
  <span class="c1"># it to/from share</span>
  <span class="nv">_toggle : </span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">=&gt;</span> 
    <span class="k">try</span>
      <span class="nv">doAdd = </span><span class="o">~</span><span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">@id</span>
    <span class="k">catch</span> <span class="nx">e</span>
      <span class="nv">doAdd = </span><span class="kc">true</span>

    <span class="k">if</span> <span class="nx">doAdd</span>
      <span class="nx">@_add</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">@_remove</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>

  <span class="c1"># all objects which $shares hash has share.id as key</span>
  <span class="nv">_isMySharedObject: </span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span><span class="o">?</span><span class="p">[</span><span class="nx">@id</span><span class="p">]</span><span class="o">?</span>
  
  <span class="c1"># an object belongs to Share if it has the same id (its the actual share object)</span>
  <span class="c1"># or its $shares hash has share.id as key</span>
  <span class="nv">_isMySharedObjectAndChanged: </span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">belongsToMe = </span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span> <span class="o">is</span> <span class="nx">@id</span> <span class="o">or</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span><span class="o">?</span><span class="p">[</span><span class="nx">@id</span><span class="p">]</span><span class="o">?</span>
    <span class="k">return</span> <span class="nx">belongsToMe</span> <span class="o">and</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">isDirty</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>

  <span class="c1">#</span>
  <span class="nv">_handleRemoteChanges: </span><span class="o">-&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;_handleRemoteChanges&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...</span></div></div></div></div></body></html>