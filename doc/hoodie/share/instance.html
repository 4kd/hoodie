<!DOCTYPE html><html lang="en"><head><title>hoodie/share/instance</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="hoodie/share/instance"><meta name="groc-project-path" content="src/hoodie/share/instance.coffee"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/hoodie/share/instance.coffee</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="k">class</span> <span class="nx">Hoodie</span><span class="p">.</span><span class="nx">Share</span><span class="p">.</span><span class="nx">Instance</span> <span class="k">extends</span> <span class="nx">Hoodie</span><span class="p">.</span><span class="nx">RemoteStore</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="default-values">default values</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>shares are not accessible to others by default.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">access: </span><span class="kc">false</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="constructor">constructor</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>initializes a new share &amp; returns a promise.</p>

<h3 id="options">Options</h3>

<pre><code>id:            (optional, defaults to random uuid)
               name of share.
access:        (default: false)
               **false**
               only the creator has access.
               **true**
               public sharing, read &amp; write access
               **{ read: true }**
               public sharing, read only
               **[user1, user2]**
               only user1 &amp; user2 have access
               **{ read: [user1, user2] }**
               only user1 &amp; user2 have access (read only)
               **{ read: true, write: [user1, user2] }**
               public sharing, but only user1 &amp; user 2 can edit
password:      (optional)
               a sharing can be optionally protected with a password.
</code></pre>

<p>Examples</p>

<pre><code># share my todo list with Joey and Frank
hoodie.share.create
  access : [
    "joey@example.com"
    "frank@example.com"
  ]
  objects : [
    todoList, todo1, todo2, todo3
  ]
</code></pre></div></div><div class="code"><div class="wrapper">  <span class="nv">constructor: </span><span class="nf">(options = {}) -&gt;</span>

    <span class="nx">@set</span> <span class="nx">options</span>
    <span class="vi">@id = </span><span class="nx">options</span><span class="p">.</span><span class="nx">id</span> <span class="o">or</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">uuid</span><span class="p">()</span>
  
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="set">set</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set an attribute, without making the change persistent yet.
alternatively, a hash of key/value pairs can be passed</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_memory: </span><span class="p">{}</span>
  <span class="nv">_allowed_options: </span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">,</span> <span class="s2">&quot;password&quot;</span><span class="p">]</span>
  <span class="nv">set : </span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">key</span> <span class="o">is</span> <span class="s1">&#39;object&#39;</span>
      <span class="k">for</span> <span class="nx">_key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">key</span> <span class="k">when</span> <span class="nx">_key</span> <span class="k">in</span> <span class="nx">@_allowed_options</span>
        <span class="err">@</span><span class="p">[</span><span class="nx">_key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@_memory</span><span class="p">[</span><span class="nx">_key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span> 
    <span class="k">else</span> 
      <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>  <span class="o">=</span> <span class="nx">@_memory</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>  <span class="o">=</span> <span class="nx">value</span> <span class="k">if</span> <span class="nx">key</span> <span class="k">in</span> <span class="nx">@_allowed_options</span>

    <span class="k">return</span> <span class="kc">undefined</span>
    
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="get">get</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>get an attribute</p></div></div><div class="code"><div class="wrapper">  <span class="nv">get : </span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
  
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="save">save</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make changes made with <code>.set</code> persistent. An optional
key/value update can be passed as first argument</p>

<p>Obviously, sharing object only works if my local data
gets synchronized. To make this happen for users without
an account, we do an anonymous signUp.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">save : </span><span class="nf">(update = {}, options) -&gt;</span>
    
    <span class="nx">unless</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">account</span><span class="p">.</span><span class="nx">hasAccount</span><span class="p">()</span>
      <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">account</span><span class="p">.</span><span class="nx">anonymousSignUp</span><span class="p">()</span>

    <span class="nx">@set</span><span class="p">(</span><span class="nx">update</span><span class="p">)</span> <span class="k">if</span> <span class="nx">update</span>
    <span class="nv">_handleUpdate = </span><span class="p">(</span><span class="nx">properties</span><span class="p">,</span> <span class="nx">wasCreated</span><span class="p">)</span> <span class="o">=&gt;</span> </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>reset memory</p></div></div><div class="code"><div class="wrapper">      <span class="vi">@_memory = </span><span class="p">{}</span>
      <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span> <span class="k">this</span><span class="p">,</span> <span class="nx">properties</span>
      <span class="k">return</span> <span class="k">this</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>persist memory to store</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="s2">&quot;$share&quot;</span><span class="p">,</span> <span class="nx">@id</span><span class="p">,</span> <span class="nx">@_memory</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">_handleUpdate</span><span class="p">)</span>
    
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="add">add</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add one or multiple objects to share. A promise that will
resolve with an array of objects can be passed as well.</p>

<p>usage</p>

<p>share.add(todoObject)
share.add([todoObject1, todoObject2, todoObject3])
share.add([todoObject1, todoObject2, todoObject3], ["name", "city"])
share.add( hoodie.my.store.findAll (obj) -> obj.isShared )</p></div></div><div class="code"><div class="wrapper">  <span class="nv">add : </span><span class="nf">(objects, sharedAttributes = true) -&gt;</span>
    <span class="nx">@toggle</span> <span class="nx">objects</span><span class="p">,</span> <span class="nx">sharedAttributes</span>
    
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="remove">remove</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remove one or multiple objects from share. A promise that will
resolve with an array of objects can be passed as well.</p>

<p>usage</p>

<p>share.remove(todoObject)
share.remove([todoObject1, todoObject2, todoObject3])
share.remove( hoodie.my.store.findAll (obj) -> obj.isShared )</p></div></div><div class="code"><div class="wrapper">  <span class="nv">remove : </span><span class="nf">(objects) -&gt;</span> 
    <span class="nx">@toggle</span> <span class="nx">objects</span><span class="p">,</span> <span class="kc">false</span>
  
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="toggle">toggle</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add or remove, depending on passed flag or current state</p></div></div><div class="code"><div class="wrapper">  <span class="nv">toggle : </span><span class="nf">(objects, filter) -&gt;</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>normalize input</p></div></div><div class="code"><div class="wrapper">    <span class="nx">unless</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">isPromise</span><span class="p">(</span><span class="nx">objects</span><span class="p">)</span> <span class="o">or</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">objects</span><span class="p">)</span>
      <span class="nv">objects = </span><span class="p">[</span><span class="nx">objects</span><span class="p">]</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>get the update method to add/remove an object to/from share</p></div></div><div class="code"><div class="wrapper">    <span class="nv">updateMethod = </span><span class="k">switch</span> <span class="nx">filter</span>
      <span class="k">when</span> <span class="kc">undefined</span>  <span class="k">then</span> <span class="nx">@_toggle</span>
      <span class="k">when</span> <span class="kc">false</span>      <span class="k">then</span> <span class="nx">@_remove</span>
      <span class="k">else</span> <span class="nx">@_add</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span>
    
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">updateAll</span><span class="p">(</span><span class="nx">objects</span><span class="p">,</span> <span class="nx">updateMethod</span><span class="p">)</span>
    
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="sync">sync</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><ol>
<li>find all objects that belong to share and that have local changes</li>
<li>combine these with the docs that have been removed from the share</li>
<li>sync all these with share's remote</li>
</ol></div></div><div class="code"><div class="wrapper">  <span class="nv">sync : </span><span class="o">=&gt;</span>
    <span class="nx">@save</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">@findAllObjects</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">remote</span><span class="p">.</span><span class="nx">sync</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="destroy">destroy</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remove all objects from share, then destroy share itself</p></div></div><div class="code"><div class="wrapper">  <span class="nv">destroy : </span><span class="o">=&gt;</span>
    <span class="nx">@remove</span><span class="p">(</span> <span class="nx">@findAllObjects</span><span class="p">()</span> <span class="p">)</span>
    <span class="p">.</span><span class="k">then</span> <span class="o">=&gt;</span>
      <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">destroy</span><span class="p">(</span><span class="s2">&quot;$share&quot;</span><span class="p">,</span> <span class="nx">@id</span><span class="p">)</span>
    
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="findallobjects">findAllObjects</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">findAllObjects : </span><span class="o">=&gt;</span>
    <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">findAll</span><span class="p">(</span><span class="nx">@_isMySharedObjectAndChanged</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="private">Private</h2></div></div><div class="code"><div class="wrapper">  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>_add</p>

<p>returns another function that will update a object
to be shared based on the passed filter</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_add : </span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">=&gt;</span> 
      <span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span> <span class="o">or=</span> <span class="p">{}</span>
      <span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span><span class="p">[</span><span class="nx">@id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">filter</span>

      <span class="nv">$shares: </span><span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>_remove</p>

<p>returns a hash update to update the passed object
so that it gets removed from the current share </p></div></div><div class="code"><div class="wrapper">  <span class="nv">_remove : </span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">return</span> <span class="p">{}</span> <span class="nx">unless</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span>

    <span class="k">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span><span class="p">[</span><span class="nx">@id</span><span class="p">]</span>
    <span class="nx">obj</span><span class="p">.</span><span class="nv">$shares = </span><span class="kc">undefined</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isEmptyObject</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span>
    <span class="nv">$shares: </span><span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>depending on whether the passed object belongs to the
share or not, an update will be returned to add/remove 
it to/from share</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_toggle : </span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">=&gt;</span> 
    <span class="k">try</span>
      <span class="nv">doAdd = </span><span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span><span class="p">[</span><span class="nx">@id</span><span class="p">]</span> <span class="o">is</span> <span class="kc">undefined</span> <span class="o">or</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span><span class="p">[</span><span class="nx">@id</span><span class="p">]</span> <span class="o">is</span> <span class="kc">false</span>
    <span class="k">catch</span> <span class="nx">e</span>
      <span class="nv">doAdd = </span><span class="kc">true</span>

    <span class="k">if</span> <span class="nx">doAdd</span>
      <span class="nx">@_add</span><span class="p">(</span><span class="kc">true</span><span class="p">)(</span><span class="nx">obj</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nx">@_remove</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>all objects which $shares hash has share.id as key</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_isMySharedObject : </span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span><span class="o">?</span><span class="p">[</span><span class="nx">@id</span><span class="p">]</span><span class="o">?</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>an object belongs to Share if it has the same id (its the actual share object)
or its $shares hash has share.id as key</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_isMySharedObjectAndChanged : </span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">belongsToMe = </span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span> <span class="o">is</span> <span class="nx">@id</span> <span class="o">or</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span><span class="o">?</span><span class="p">[</span><span class="nx">@id</span><span class="p">]</span><span class="o">?</span>
    <span class="k">return</span> <span class="nx">belongsToMe</span> <span class="o">and</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">isDirty</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">$type</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span></div></div></div><div class="segment"><div class="code"><div class="wrapper">  <span class="nv">_handleRemoteChanges : </span><span class="o">-&gt;</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s1">&#39;_handleRemoteChanges&#39;</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...</span></div></div></div></div></body></html>