<!DOCTYPE html><html lang="en"><head><title>hoodie/share/remote</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="hoodie/share/remote"><meta name="groc-project-path" content="src/hoodie/share/remote.coffee"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/hoodie/share/remote.coffee</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><p>Remote patched for Share.</p>

<p>The only difference is the pull URL, it adds a filter to assure that
only documents get pulled that belong to the share. This is important
when an object gets removed from the share, by removing the share id
from the objects $shares array and deleting the object. The filter
avoids that the deletion will be synchronized through the _changes feed.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>needs to to have the same name due to hoodie's loading mechanism
see: Hoodie::_loadModules</p></div></div><div class="code"><div class="wrapper"><span class="k">class</span> <span class="nx">Hoodie</span><span class="p">.</span><span class="nx">Share</span><span class="p">.</span><span class="nx">Remote</span> <span class="k">extends</span> <span class="nx">Hoodie</span><span class="p">.</span><span class="nx">RemoteStore</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="push">push</h2>

<p>we only want to push stuff that belongs to this share</p></div></div><div class="code"><div class="wrapper">  <span class="nv">push : </span><span class="p">(</span><span class="nx">docs</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">unless</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">docs</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>walk through all changed docs, check if it's
1. the share object itself or
2. an object belonging to the share</p></div></div><div class="code"><div class="wrapper">      <span class="nv">docs = </span><span class="k">for</span> <span class="nx">obj</span> <span class="k">in</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">changedDocs</span><span class="p">()</span> <span class="k">when</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">id</span> <span class="o">is</span> <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">share</span><span class="p">.</span><span class="nx">id</span> <span class="o">or</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span> <span class="o">and</span> <span class="o">~</span><span class="nx">obj</span><span class="p">.</span><span class="nx">$shares</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">@hoodie</span><span class="p">.</span><span class="nx">share</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
        <span class="nx">obj</span> 

    <span class="k">super</span><span class="p">(</span><span class="nx">docs</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="private">PRIVATE</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>pull url</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The pull URL has an addition filter to only pull for the documents
that belong to the share, see above</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_pullUrl : </span><span class="o">-&gt;</span>
    <span class="nv">since = </span><span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;_remote.seq&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="nx">@active</span> <span class="c1"># make a long poll request</span>
      <span class="s2">&quot;/#{encodeURIComponent @hoodie.my.account.db()}/_changes?filter=%24share_#{@hoodie.share.id}/owned&amp;include_docs=true&amp;since=#{since}&amp;heartbeat=10000&amp;feed=longpoll&quot;</span>
    <span class="k">else</span>
      <span class="s2">&quot;/#{encodeURIComponent @hoodie.my.account.db()}/_changes?filter=%24share_#{@hoodie.share.id}/owned&amp;include_docs=true&amp;since=#{since}&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add revision to object</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>in addition to the standard behavior, we check for the $docsToRemove
attribute, to add new revision to these as well.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_addRevisionTo : </span><span class="nf">(obj) -&gt;</span>
    <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$docsToRemove</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s2">&quot;obj.$docsToRemove&quot;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$docsToRemove</span>
      <span class="nx">@_addRevisionTo</span><span class="p">(</span><span class="nx">doc</span><span class="p">)</span> <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">doc</span> <span class="k">of</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$docsToRemove</span>

    <span class="k">super</span> <span class="nx">obj</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>handle push success</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>before handing over the docs (that have been replicated to the couch)
to the default procedure, we check for the $docsToRemove attribute
again, and handle these documents upfront</p></div></div><div class="code"><div class="wrapper">  <span class="nv">_handlePushSuccess: </span><span class="p">(</span><span class="nx">docs</span><span class="p">,</span> <span class="nx">pushedDocs</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="o">=&gt;</span>
      <span class="k">for</span> <span class="nx">pushedDoc</span> <span class="k">in</span> <span class="nx">pushedDocs</span>
        <span class="k">if</span> <span class="nx">pushedDoc</span><span class="p">.</span><span class="nx">$docsToRemove</span>
          <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">doc</span> <span class="k">of</span> <span class="nx">pushedDoc</span><span class="p">.</span><span class="nx">$docsToRemove</span>
            <span class="p">[</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">split</span> <span class="sr">/\//</span>
            <span class="nv">update = _rev: </span><span class="nx">doc</span><span class="p">.</span><span class="nx">_rev</span>
            <span class="nx">@hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">update</span><span class="p">,</span> <span class="nv">remote: </span><span class="kc">true</span><span class="p">)</span> <span class="k">for</span> <span class="nx">doc</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">docs</span>

      <span class="k">super</span><span class="p">(</span><span class="nx">docs</span><span class="p">,</span> <span class="nx">pushedDocs</span><span class="p">)()</span></div></div></div></div></body></html>