// Generated by CoffeeScript 1.3.1
var __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

define('account', function() {
  var Account;
  return Account = (function() {

    Account.name = 'Account';

    Account.prototype.email = void 0;

    function Account(app) {
      this.app = app;
      this._handle_sign_out = __bind(this._handle_sign_out, this);

      this._handle_sign_in = __bind(this._handle_sign_in, this);

      this.email = this.app.store.db.getItem('_couch.account.email');
      this.authenticate();
      this.on('signed_in', this._handle_sign_in);
      this.on('signed_out', this._handle_sign_out);
    }

    Account.prototype.authenticate = function() {
      var defer,
        _this = this;
      defer = this.app.defer();
      if (!this.email) {
        return defer.reject().promise();
      }
      if (this._authenticated === true) {
        return defer.resolve(this.email).promise();
      }
      if (this._authenticated === false) {
        return defer.reject().promise();
      }
      this.app.request('GET', "/_session", {
        success: function(response) {
          if (response.userCtx.name) {
            _this._authenticated = true;
            _this.email = response.userCtx.name;
            return defer.resolve(_this.email);
          } else {
            _this._authenticated = false;
            _this.app.trigger('account:error:unauthenticated');
            return defer.reject();
          }
        },
        error: function(xhr) {
          var error;
          try {
            error = JSON.parse(xhr.responseText);
          } catch (e) {
            error = {
              error: xhr.responseText || "unknown"
            };
          }
          return defer.reject(error);
        }
      });
      return defer.promise();
    };

    Account.prototype.sign_up = function(email, password, attributes) {
      var defer, key,
        _this = this;
      if (attributes == null) {
        attributes = {};
      }
      defer = this.app.defer();
      key = "" + this._prefix + ":" + email;
      this._doc = {
        _id: key,
        name: email,
        type: 'user',
        roles: [],
        attributes: attributes
      };
      this.app.request('PUT', "/_users/" + (encodeURIComponent(key)), {
        data: JSON.stringify($.extend({
          password: password
        }, this._doc)),
        contentType: 'application/json',
        success: function(response) {
          _this._doc._rev = response.rev;
          _this.app.trigger('account:signed_up', email);
          _this.app.trigger('account:signed_in', email);
          return defer.resolve(email);
        },
        error: function(xhr) {
          var error;
          try {
            error = JSON.parse(xhr.responseText);
          } catch (e) {
            error = {
              error: xhr.responseText || "unknown"
            };
          }
          return defer.reject(error);
        }
      });
      return defer.promise();
    };

    Account.prototype.sign_in = function(email, password) {
      var defer,
        _this = this;
      defer = this.app.defer();
      this.app.request('POST', '/_session', {
        data: {
          name: email,
          password: password
        },
        success: function() {
          _this.app.trigger('account:signed_in', email);
          return defer.resolve(email);
        },
        error: function(xhr) {
          var error;
          try {
            error = JSON.parse(xhr.responseText);
          } catch (e) {
            error = {
              error: xhr.responseText || "unknown"
            };
          }
          return defer.reject(error);
        }
      });
      return defer.promise();
    };

    Account.prototype.login = Account.prototype.sign_in;

    Account.prototype.change_password = function(current_password, new_password) {
      return alert('change password is not yet implementd');
    };

    Account.prototype.sign_out = function() {
      var _this = this;
      return this.app.request('DELETE', '/_session', {
        success: function() {
          return _this.app.trigger('account:signed_out');
        }
      });
    };

    Account.prototype.logout = Account.prototype.sign_out;

    Account.prototype.on = function(event, cb) {
      return this.app.on("account:" + event, cb);
    };

    Account.prototype.user_db = function() {
      var _ref;
      return (_ref = this.email) != null ? _ref.toLowerCase().replace(/@/, "$").replace(/\./g, "_") : void 0;
    };

    Account.prototype.fetch = function() {
      var defer, key,
        _this = this;
      defer = this.app.defer();
      if (!this.email) {
        defer.reject({
          error: "unauthenticated",
          reason: "not logged in"
        });
        return defer.promise();
      }
      key = "" + this._prefix + ":" + this.email;
      this.app.request('GET', "/_users/" + (encodeURIComponent(key)), {
        success: function(response) {
          delete response.password_sha;
          _this._doc = response;
          return defer.resolve(response);
        },
        error: function(xhr) {
          var error;
          try {
            error = JSON.parse(xhr.responseText);
          } catch (e) {
            error = {
              error: xhr.responseText || "unknown"
            };
          }
          return defer.reject(error);
        }
      });
      return defer.promise();
    };

    Account.prototype._prefix = 'org.couchdb.user';

    Account.prototype._doc = {};

    Account.prototype._handle_sign_in = function(email) {
      this.email = email;
      this.app.store.db.setItem('_couch.account.email', this.email);
      return this._authenticated = true;
    };

    Account.prototype._handle_sign_out = function() {
      delete this.email;
      this.app.store.db.removeItem('_couch.account.email');
      return this._authenticated = false;
    };

    return Account;

  })();
});
