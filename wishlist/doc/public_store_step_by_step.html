<!DOCTYPE html><html lang="en"><head><title>public_store_step_by_step</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="public_store_step_by_step"><meta name="groc-project-path" content="public_store_step_by_step.js"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">public_store_step_by_step.js</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="implementation-of-public-user-stores">Implementation of public user stores</h1>

<p>From hoodie's frontend API perspective, every user has a store which
is private by default. Nobody but the user himself is able to access
this data, authenticated by a username and a password.</p>

<p>Above that, objects can selectively be set to be public. Entire objects
or only some of the attributes.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="step-one-create-or-make-an-object-public">Step one: create or make an object public</h2></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>We create a profile with a name and an email address. This will internally
create an sync a couchDB doc that looks like this:</p>

<pre><code>{
  "_id"       : "profile/uuid567",
  "_ref"      : "1-5so4hkn",
  "type"      : "profile",
  "name"      : "Joe Doe",
  "email"     : "joe@example.com",
  "createdAt" : "2012-07-12T21:55:42.228Z",
  "updatedAt" : "2012-07-12T21:55:42.228Z"
}
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="s2">&quot;profile&quot;</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">name</span>  <span class="o">:</span> <span class="s2">&quot;Joe Doe&quot;</span><span class="p">,</span>
  <span class="nx">email</span> <span class="o">:</span> <span class="s2">&quot;joe@example.com&quot;</span>
<span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>To make it available to other users, it needs to be made public. We use
the <code>store.update</code> method for it. Simply leave the update object empty 
and pass a <code>{ public: true }</code> hash as the forth parameter. This will update
the couchDB document and look like this:</p>

<pre><code>{
  "_id"       : "profile/uuid567",
  "_ref"      : "2-cr3m5g8",
  "$public"   : true,
  "type"      : "profile",
  "name"      : "Joe Doe",
  "email"     : "joe@example.com",
  "createdAt" : "2012-07-12T21:55:42.228Z",
  "updatedAt" : "2012-07-12T21:55:42.228Z"
}
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="s2">&quot;profile&quot;</span><span class="p">,</span> <span class="s2">&quot;uuid567&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span> <span class="kr">public</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>instead of making the entire profile public, we can select specific
attributes to be made publicly available while the rest will be hidden.
The resulting couchDB doc will look like this:</p>

<pre><code>{
  "_id"       : "profile/uuid567",
  "_ref"      : "3-7apxftr",
  "$public"   : ["name"],
  "type"      : "profile",
  "name"      : "Joe Doe",
  "email"     : "joe@example.com",
  "createdAt" : "2012-07-12T21:55:42.228Z",
  "updatedAt" : "2012-07-12T21:55:42.228Z"
}
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="s2">&quot;profile&quot;</span><span class="p">,</span> <span class="s2">&quot;uuid567&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span> <span class="kr">public</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>when you want to make an object private again, simply set public to false.
We now could simply remove the $public attribut, but we intentionally set
it to false, otherwise the public store worke would ignore it (see blelow)</p>

<pre><code>{
  "_id"       : "profile/uuid567",
  "_ref"      : "4-ldva53g",
  "type"      : "profile",
  "$public"   : "false",
  "name"      : "Joe Doe",
  "email"     : "joe@example.com",
  "createdAt" : "2012-07-12T21:55:42.228Z",
  "updatedAt" : "2012-07-12T21:55:42.228Z"
}
</code></pre></div></div><div class="code"><div class="wrapper"><span class="nx">hoodie</span><span class="p">.</span><span class="nx">my</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="s2">&quot;profile&quot;</span><span class="p">,</span> <span class="s2">&quot;uuid567&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span> <span class="kr">public</span><span class="o">:</span> <span class="kc">false</span> <span class="p">})</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="step-2-synchronization-with-public-store">Step 2: Synchronization with public store</h2>

<p>In hoodie's internal implementation with couchDB, each user will have two
couchDB database when public stores are enabled. The first is the standard
one and is private, only accessible by by the user after authentication.
The second one is the "public user store" and contains only the objects
that have been set to be public as described above.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Let's say the user created a public profile object which gets synchronized
to his private store as usual:</p></div></div><div class="code"><div class="wrapper"><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span>       <span class="o">:</span> <span class="s2">&quot;profile/uuid567&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_ref&quot;</span>      <span class="o">:</span> <span class="s2">&quot;2-cr3m5g8&quot;</span><span class="p">,</span>
  <span class="s2">&quot;$public&quot;</span>   <span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="s2">&quot;type&quot;</span>      <span class="o">:</span> <span class="s2">&quot;profile&quot;</span><span class="p">,</span>
  <span class="s2">&quot;name&quot;</span>      <span class="o">:</span> <span class="s2">&quot;Joe Doe&quot;</span><span class="p">,</span>
  <span class="s2">&quot;email&quot;</span>     <span class="o">:</span> <span class="s2">&quot;joe@example.com&quot;</span><span class="p">,</span>
  <span class="s2">&quot;createdAt&quot;</span> <span class="o">:</span> <span class="s2">&quot;2012-07-12T21:55:42.228Z&quot;</span><span class="p">,</span>
  <span class="s2">&quot;updatedAt&quot;</span> <span class="o">:</span> <span class="s2">&quot;2012-07-12T21:55:42.228Z&quot;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The <strong>public store worker</strong> listens to changes on the users private store 
(e.g. <code>http://myapp.hood.ie/joe</code>) and watches for documents with a 
<code>$public</code> attribute. If the one above  shows up in the <code>_changes</code> feed, it
will create or update the respective object in the public store
(e.g. <code>http://myapp.hood.ie/joe/public</code>)</p></div></div><div class="code"><div class="wrapper"><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span>       <span class="o">:</span> <span class="s2">&quot;$public/profile/uuid567&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_ref&quot;</span>      <span class="o">:</span> <span class="s2">&quot;2-cr3m5g8&quot;</span><span class="p">,</span>
  <span class="s2">&quot;type&quot;</span>      <span class="o">:</span> <span class="s2">&quot;profile&quot;</span><span class="p">,</span>
  <span class="s2">&quot;name&quot;</span>      <span class="o">:</span> <span class="s2">&quot;Joe Doe&quot;</span><span class="p">,</span>
  <span class="s2">&quot;email&quot;</span>     <span class="o">:</span> <span class="s2">&quot;joe@example.com&quot;</span><span class="p">,</span>
  <span class="s2">&quot;createdAt&quot;</span> <span class="o">:</span> <span class="s2">&quot;2012-07-12T21:55:42.228Z&quot;</span><span class="p">,</span>
  <span class="s2">&quot;updatedAt&quot;</span> <span class="o">:</span> <span class="s2">&quot;2012-07-12T21:55:42.228Z&quot;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>If the user created a public profile, but with only the name attribute
beeing public (<code>"$public" : ["name"]</code>), the public store worker would
turn it into the following doc:</p></div></div><div class="code"><div class="wrapper"><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span>       <span class="o">:</span> <span class="s2">&quot;$public/profile/uuid567&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_ref&quot;</span>      <span class="o">:</span> <span class="s2">&quot;2-cr3m5g8&quot;</span><span class="p">,</span>
  <span class="s2">&quot;type&quot;</span>      <span class="o">:</span> <span class="s2">&quot;profile&quot;</span><span class="p">,</span>
  <span class="s2">&quot;name&quot;</span>      <span class="o">:</span> <span class="s2">&quot;Joe Doe&quot;</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>When a user makes a public object private again the <code>$private</code> attribute
will be set to false as mentioned above. he public store worker would
turn it into the following doc, which will remove it form the public store</p></div></div><div class="code"><div class="wrapper"><span class="p">{</span>
  <span class="s2">&quot;_id&quot;</span>       <span class="o">:</span> <span class="s2">&quot;$public/profile/uuid567&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_ref&quot;</span>      <span class="o">:</span> <span class="s2">&quot;2-cr3m5g8&quot;</span><span class="p">,</span>
  <span class="s2">&quot;_deleted&quot;</span>  <span class="o">:</span> <span class="kc">true</span>
<span class="p">}</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><h2 id="the-worker">the worker</h2>

<p>the public store worker could be described as an extended filtered 
replication. It listens for specific documents in Database A
(user private store) and replicates them to Database B
(user public store). But in contrast to standard CouchDB replications,
the worker parses the document from A and turns it into a different object
before creating or updating it in B.</p>

<p>The code for the worker will have a function wich will be called for every
document coming from the users private store <code>_changes</code> feed. If the 
function returns an object, the object will be PUT to users public store.</p></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>The function might look like this:</p></div></div><div class="code"><div class="wrapper"><span class="kd">function</span> <span class="nx">changes_doc_parser</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make object entirely public</p></div></div><div class="code"><div class="wrapper">    <span class="k">case</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$public</span> <span class="o">===</span> <span class="kc">true</span><span class="o">:</span>
      <span class="k">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$public</span>
      <span class="nx">obj</span><span class="p">.</span><span class="nx">_id</span> <span class="o">=</span> <span class="s2">&quot;$public/&quot;</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">_id</span>
      <span class="k">return</span> <span class="nx">obj</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make certain attributes public</p></div></div><div class="code"><div class="wrapper">    <span class="k">case</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">$public</span><span class="p">)</span><span class="o">:</span>
      <span class="kd">var</span> <span class="nx">newObj</span> <span class="o">=</span> <span class="p">{},</span>
          <span class="nx">defaultPublicAtts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_ref&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">]</span>

      <span class="nx">obj</span><span class="p">.</span><span class="nx">$public</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">defaultPublicAtts</span><span class="p">)</span>
      <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">attr</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$public</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">attr</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$public</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
        <span class="nx">newObj</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span>
      <span class="p">};</span>
      <span class="nx">obj</span><span class="p">.</span><span class="nx">_id</span> <span class="o">=</span> <span class="s2">&quot;$public/&quot;</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">_id</span>
      <span class="k">return</span> <span class="nx">obj</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>make public object private again, remove it from public store</p></div></div><div class="code"><div class="wrapper">    <span class="k">case</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">$public</span> <span class="o">===</span> <span class="kc">false</span><span class="o">:</span>
      <span class="nx">obj</span><span class="p">.</span><span class="nx">_deleted</span> <span class="o">=</span> <span class="kc">true</span>
      <span class="k">return</span> <span class="nx">obj</span>
  <span class="p">}</span>
<span class="p">}</span></div></div></div></div></body></html>